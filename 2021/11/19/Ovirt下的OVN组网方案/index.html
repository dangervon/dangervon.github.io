<!DOCTYPE html>
<html lang="en-US">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.loli.net/css?family=Noto Serif SC:300,300italic,400,400italic,700,700italic|Lobster Two:300,300italic,400,400italic,700,700italic|EB Garamond:300,300italic,400,400italic,700,700italic|Source Code Pro:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="/nextlib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"dangervon.github.io","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":3,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="Ovirt云平台下的OVN组网方案，包括二层&#x2F;三层组网以及ACL、LB、HA等">
<meta property="og:type" content="article">
<meta property="og:title" content="Ovirt下的OVN组网方案">
<meta property="og:url" content="http://dangervon.github.io/2021/11/19/Ovirt%E4%B8%8B%E7%9A%84OVN%E7%BB%84%E7%BD%91%E6%96%B9%E6%A1%88/index.html">
<meta property="og:site_name" content="DangerZone">
<meta property="og:description" content="Ovirt云平台下的OVN组网方案，包括二层&#x2F;三层组网以及ACL、LB、HA等">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://s3.us-west-2.amazonaws.com/secure.notion-static.com/a1dff44f-748a-4048-b20f-c36e33f8fca3/ovirt%E4%BA%91%E5%B9%B3%E5%8F%B0%E7%BD%91%E7%BB%9C%E6%8B%93%E6%89%91.png?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Content-Sha256=UNSIGNED-PAYLOAD&X-Amz-Credential=AKIAT73L2G45EIPT3X45/20211119/us-west-2/s3/aws4_request&X-Amz-Date=20211119T093120Z&X-Amz-Expires=86400&X-Amz-Signature=f46c1cd45e33a29464032de9c356b9ff3b90ef6b2f6b60e5a1d1a1315aeba636&X-Amz-SignedHeaders=host&response-content-disposition=filename%20=%22ovirt%25E4%25BA%2591%25E5%25B9%25B3%25E5%258F%25B0%25E7%25BD%2591%25E7%25BB%259C%25E6%258B%2593%25E6%2589%2591.png%22&x-id=GetObject">
<meta property="og:image" content="https://s3.us-west-2.amazonaws.com/secure.notion-static.com/e17a94bc-d851-4502-8479-6b69d940d056/ovirt%E4%BA%91%E5%B9%B3%E5%8F%B0%E7%BD%91%E7%BB%9C%E6%8B%93%E6%89%91.bmp?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Content-Sha256=UNSIGNED-PAYLOAD&X-Amz-Credential=AKIAT73L2G45EIPT3X45/20211119/us-west-2/s3/aws4_request&X-Amz-Date=20211119T093206Z&X-Amz-Expires=86400&X-Amz-Signature=91d0132ce009d168b8ea1778f3d40b27906a6bba167995e18be236eedda61ff5&X-Amz-SignedHeaders=host&response-content-disposition=filename%20=%22ovirt%25E4%25BA%2591%25E5%25B9%25B3%25E5%258F%25B0%25E7%25BD%2591%25E7%25BB%259C%25E6%258B%2593%25E6%2589%2591.bmp%22&x-id=GetObject">
<meta property="article:published_time" content="2021-11-19T09:24:46.000Z">
<meta property="article:modified_time" content="2021-11-19T09:35:49.965Z">
<meta property="article:author" content="dangervon">
<meta property="article:tag" content="ovn">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://s3.us-west-2.amazonaws.com/secure.notion-static.com/a1dff44f-748a-4048-b20f-c36e33f8fca3/ovirt%E4%BA%91%E5%B9%B3%E5%8F%B0%E7%BD%91%E7%BB%9C%E6%8B%93%E6%89%91.png?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Content-Sha256=UNSIGNED-PAYLOAD&X-Amz-Credential=AKIAT73L2G45EIPT3X45/20211119/us-west-2/s3/aws4_request&X-Amz-Date=20211119T093120Z&X-Amz-Expires=86400&X-Amz-Signature=f46c1cd45e33a29464032de9c356b9ff3b90ef6b2f6b60e5a1d1a1315aeba636&X-Amz-SignedHeaders=host&response-content-disposition=filename%20=%22ovirt%25E4%25BA%2591%25E5%25B9%25B3%25E5%258F%25B0%25E7%25BD%2591%25E7%25BB%259C%25E6%258B%2593%25E6%2589%2591.png%22&x-id=GetObject">

<link rel="canonical" href="http://dangervon.github.io/2021/11/19/Ovirt%E4%B8%8B%E7%9A%84OVN%E7%BB%84%E7%BD%91%E6%96%B9%E6%A1%88/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'en-US'
  };
</script>

  <title>Ovirt下的OVN组网方案 | DangerZone</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>
<a target="_blank" rel="noopener" href="https://github.com/dangervon" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">DangerZone</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">Linus Benedict Torvalds Once Said:Talk is Cheap,Show me the Code.That is true Correct!</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags<span class="badge">3</span></a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories<span class="badge">3</span></a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives<span class="badge">4</span></a>

  </li>
        <li class="menu-item menu-item-schedule">

    <a href="/schedule/" rel="section"><i class="fa fa-calendar fa-fw"></i>Schedule</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en-US">
    <link itemprop="mainEntityOfPage" href="http://dangervon.github.io/2021/11/19/Ovirt%E4%B8%8B%E7%9A%84OVN%E7%BB%84%E7%BD%91%E6%96%B9%E6%A1%88/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/header.png">
      <meta itemprop="name" content="dangervon">
      <meta itemprop="description" content="To be a Better man">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="DangerZone">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Ovirt下的OVN组网方案
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2021-11-19 17:24:46 / Modified: 17:35:49" itemprop="dateCreated datePublished" datetime="2021-11-19T17:24:46+08:00">2021-11-19</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/openvswitch/" itemprop="url" rel="index"><span itemprop="name">openvswitch</span></a>
                </span>
            </span>

          
            <div class="post-description">Ovirt云平台下的OVN组网方案，包括二层/三层组网以及ACL、LB、HA等</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="整体架构"><a href="#整体架构" class="headerlink" title="整体架构"></a>整体架构</h1><p>ovirt云平台下ovn组网方案整体架构如下图所示：</p>
<p><img src="https://s3.us-west-2.amazonaws.com/secure.notion-static.com/a1dff44f-748a-4048-b20f-c36e33f8fca3/ovirt%E4%BA%91%E5%B9%B3%E5%8F%B0%E7%BD%91%E7%BB%9C%E6%8B%93%E6%89%91.png?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Content-Sha256=UNSIGNED-PAYLOAD&X-Amz-Credential=AKIAT73L2G45EIPT3X45/20211119/us-west-2/s3/aws4_request&X-Amz-Date=20211119T093120Z&X-Amz-Expires=86400&X-Amz-Signature=f46c1cd45e33a29464032de9c356b9ff3b90ef6b2f6b60e5a1d1a1315aeba636&X-Amz-SignedHeaders=host&response-content-disposition=filename%20=%22ovirt%25E4%25BA%2591%25E5%25B9%25B3%25E5%258F%25B0%25E7%25BD%2591%25E7%25BB%259C%25E6%258B%2593%25E6%2589%2591.png%22&x-id=GetObject" alt="ovirt云平台网络架构"></p>
<h2 id="ovirt-provider-ovn"><a href="#ovirt-provider-ovn" class="headerlink" title="ovirt-provider-ovn"></a>ovirt-provider-ovn</h2><p>是ovirt4.3的一个插件，作为OVN和ovirt之间的接口，它将ovirt中的数据翻译成为一种可以让ovn-northbound DB所能理解的逻辑网络配置数据，翻译后的数据采用ovsdb协议来传输。</p>
<h2 id="ovsdb"><a href="#ovsdb" class="headerlink" title="ovsdb"></a>ovsdb</h2><p>ovsdb管理协议（open vswitch database management protocol）是一个用于实现对虚拟交换机的可编程访问和配置管理的SDB管理协议，ovsdb管理协议定义了一套RPC接口，用户可以通过远程调用的方式来管理，主要包括通信协议（JSON-RPC）和所支持的OVSDB操作，ovs是ovsdb的主要应用，其数据模式由ovsdb schema定义，传输格式为JSON。</p>
<h2 id="Northbound-DB"><a href="#Northbound-DB" class="headerlink" title="Northbound DB"></a>Northbound DB</h2><p>Northbound DB里存储着ovirt provider ovn产生的逻辑网络相关数据，主要包括logical switch、logical router、logical port和ACL等。</p>
<h2 id="OVN-Northd-Daemon"><a href="#OVN-Northd-Daemon" class="headerlink" title="OVN Northd Daemon"></a>OVN Northd Daemon</h2><p>OVN Northd守护程序是一个集中的控制器，监听Northbound DB数据库里数据的变化，它能把Northbound DB里存储的逻辑网络相关的数据翻译为Southbound DB所能理解的Logical datapath flows，并传递给Southbound DB进行存储，进而被classis读取和应用,hypervisor和网关一起被称为传输节点或者classis。</p>
<h2 id="Southbound-DB"><a href="#Southbound-DB" class="headerlink" title="Southbound DB"></a>Southbound DB</h2><p>OVN Southbound DB是OVN的核心，它是OVN中最重要的部分，和其他的OVN组件都有交互。里面存放的数据和Northbound DB语义完全不一样，主要包含三类数据：</p>
<ul>
<li>物理网络数据，比如Hypervisor的IP地址，Hypervisor的tunnel封装格式，这类数据由ovn-controller写入；</li>
<li>逻辑网络数据，由Northbound DB转发而来；</li>
<li>物理网络和逻辑网络的绑定关系，比如逻辑端口关联到哪个hypervisor上面，这类数据存储在binding表中，字段有uuid,chassis, logical_datapath, logical_port, mac, parent_port, tag, tunnel_key。</li>
</ul>
<h2 id="OVN-Controller"><a href="#OVN-Controller" class="headerlink" title="OVN Controller"></a>OVN Controller</h2><p>ovn-controller运行在每个hypervisor和软件网关上面，主要有以下两个功能：</p>
<ul>
<li>把物理网络的信息写到Southbound DB里面；</li>
<li>把Southbound DB里的存放的一些数据转换成为openflow flow配到本地的ovs table里面，来实现报文的转发，具体实现就是ovn-controller连接到本地的ovsdb-server，监控、读取、管理openvswitch的配置信息。</li>
</ul>
<p>ovn-controller作为ovs-vswitched的openflow控制器来控制流量的转发，从上图中可以看出ovn-controller是一种分布式的SDN控制器。</p>
<h2 id="ovsdb-server和ovs-vswitched"><a href="#ovsdb-server和ovs-vswitched" class="headerlink" title="ovsdb-server和ovs-vswitched"></a>ovsdb-server和ovs-vswitched</h2><p>ovs-vswitched是openvswitch的核心模块，实现交换功能，和Linux内核一起实现基于流的交换。</p>
<p>ovsdb-server是一个数据库，其保存了整个openvswitch的配置信息，包括接口、流表、vlan等，ovs-vswitched从其中查询数据。</p>
<h1 id="OVN安装"><a href="#OVN安装" class="headerlink" title="OVN安装"></a>OVN安装</h1><blockquote>
<p>生产环境下不需以下步骤，virtualHost自带这些包，并且连接方式是ssl而不是tcp</p>
</blockquote>
<h2 id="环境初始化"><a href="#环境初始化" class="headerlink" title="环境初始化"></a>环境初始化</h2><p>配置本地yum源local_repo.repo，如下所示：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">[jb-eap-7.2-for-rhel-7-server-rpms]</span><br><span class="line">name=jb-eap-7.2-for-rhel-7-server-rpms</span><br><span class="line">baseurl=http://172.16.126.238/rhvrepo/jb-eap-7.2-for-rhel-7-server-rpms/</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=0</span><br><span class="line"></span><br><span class="line">[rhel-7-server-ansible-2.9-rpms]</span><br><span class="line">name=rhel-7-server-ansible-2.9-rpms</span><br><span class="line">baseurl=http://172.16.126.238/rhvrepo/rhel-7-server-ansible-2.9-rpms/</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=0</span><br><span class="line"></span><br><span class="line">[rhel-7-server-rhv-4.3-manager-rpms]</span><br><span class="line">name=rhel-7-server-rhv-4.3-manager-rpms</span><br><span class="line">baseurl=http://172.16.126.238/rhvrepo/rhel-7-server-rhv-4.3-manager-rpms/</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=0</span><br><span class="line"></span><br><span class="line">[rhel-7-server-rhv-4-manager-tools-rpms]</span><br><span class="line">name=rhel-7-server-rhv-4-manager-tools-rpms</span><br><span class="line">baseurl=http://172.16.126.238/rhvrepo/rhel-7-server-rhv-4-manager-tools-rpms/</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=0</span><br><span class="line"></span><br><span class="line">[rhel-7-server-rhv-4-mgmt-agent-rpms]</span><br><span class="line">name=rhel-7-server-rhv-4-mgmt-agent-rpms</span><br><span class="line">baseurl=http://172.16.126.238/rhvrepo/rhel-7-server-rhv-4-mgmt-agent-rpms/</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=0</span><br><span class="line"></span><br><span class="line">[rhel-7-server-rpms]</span><br><span class="line">name=rhel-7-server-rpms</span><br><span class="line">baseurl=http://172.16.126.238/rhvrepo/rhel-7-server-rpms/</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=0</span><br><span class="line"></span><br><span class="line">[rh-gluster-3-for-rhel-7-server-rpms]</span><br><span class="line">name=rh-gluster-3-for-rhel-7-server-rpms</span><br><span class="line">baseurl=http://172.16.126.238/rhvrepo/rh-gluster-3-for-rhel-7-server-rpms/</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=0</span><br></pre></td></tr></table></figure>

<p>完成后生成缓存并安装vim、net-tools及lrzsz等软件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#yum makecache</span></span><br><span class="line"><span class="comment">#yum install vim net-tools lrzsz tcpdump</span></span><br></pre></td></tr></table></figure>

<p>更改Host映射关系或者直接在DNS服务器中添加中心节点及计算节点的域名解析</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#vim /etc/hosts</span></span><br><span class="line">127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4</span><br><span class="line">::1         localhost localhost.localdomain localhost6 localhost6.localdomain6</span><br><span class="line">172.16.126.70 ovn-central</span><br><span class="line">172.16.126.71 ovn-node1</span><br><span class="line">172.16.126.72 ovn-node2</span><br></pre></td></tr></table></figure>

<h2 id="OVN-CENTRAL中心节点安装"><a href="#OVN-CENTRAL中心节点安装" class="headerlink" title="OVN CENTRAL中心节点安装"></a>OVN CENTRAL中心节点安装</h2><h3 id="安装ovn-central软件包"><a href="#安装ovn-central软件包" class="headerlink" title="安装ovn-central软件包"></a>安装ovn-central软件包</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#yum install openvswitch2.11 openvswitch2.11-devel ovn2.11-central</span></span><br></pre></td></tr></table></figure>

<h3 id="选择关闭防火墙及selinux-和配置防火墙二选一即可"><a href="#选择关闭防火墙及selinux-和配置防火墙二选一即可" class="headerlink" title="选择关闭防火墙及selinux(和配置防火墙二选一即可)"></a>选择关闭防火墙及selinux(和配置防火墙二选一即可)</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#systemctl stop firewalld</span></span><br><span class="line"><span class="comment">#systemctl disable firewalld</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#sed -i &#x27;s#SELINUX=enforcing#SELINUX=disabled#g&#x27; /etc/sysconfig/selinux</span></span><br><span class="line"><span class="comment">#setenforce 0</span></span><br></pre></td></tr></table></figure>

<h3 id="选择配置防火墙规则"><a href="#选择配置防火墙规则" class="headerlink" title="选择配置防火墙规则"></a>选择配置防火墙规则</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#firewall-cmd --zone=public --add-service=ovn-central-firewall-service --permanent</span></span><br><span class="line"><span class="comment">#firewall-cmd --reload</span></span><br></pre></td></tr></table></figure>

<h3 id="开始端口监听并启动ovn-northd"><a href="#开始端口监听并启动ovn-northd" class="headerlink" title="开始端口监听并启动ovn-northd"></a>开始端口监听并启动ovn-northd</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#systemctl enable openvswitch ovn-northd</span></span><br><span class="line"><span class="comment">#systemctl start  openvswitch ovn-northd</span></span><br></pre></td></tr></table></figure>

<h3 id="设置南向和北向数据库连接"><a href="#设置南向和北向数据库连接" class="headerlink" title="设置南向和北向数据库连接"></a>设置南向和北向数据库连接</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#ovn-nbctl set-connection ptcp:6641:172.16.126.70 -- set connection . inactivity_probe=60000</span></span><br><span class="line"><span class="comment">#ovn-sbctl set-connection ptcp:6642:172.16.126.70 -- set connection . inactivity_probe=60000</span></span><br></pre></td></tr></table></figure>

<h2 id="OVN-HOST计算节点安装"><a href="#OVN-HOST计算节点安装" class="headerlink" title="OVN HOST计算节点安装"></a>OVN HOST计算节点安装</h2><h3 id="安装OVN-HOST计算节点软件包"><a href="#安装OVN-HOST计算节点软件包" class="headerlink" title="安装OVN HOST计算节点软件包"></a>安装OVN HOST计算节点软件包</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#yum install openvswitch2.11 openvswitch2.11-devel ovn2.11-host</span></span><br></pre></td></tr></table></figure>

<h3 id="选择关闭防火墙及selinux"><a href="#选择关闭防火墙及selinux" class="headerlink" title="选择关闭防火墙及selinux"></a>选择关闭防火墙及selinux</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#systemctl stop firewalld</span></span><br><span class="line"><span class="comment">#systemctl disable firewalld</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#sed -i &#x27;s#SELINUX=enforcing#SELINUX=disabled#g&#x27; /etc/sysconfig/selinux</span></span><br><span class="line"><span class="comment">#setenforce 0</span></span><br></pre></td></tr></table></figure>

<h3 id="选择配置防火墙规则-1"><a href="#选择配置防火墙规则-1" class="headerlink" title="选择配置防火墙规则"></a>选择配置防火墙规则</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#firewall-cmd --zone=public --add-service=ovn-host-firewall-service --permanent</span></span><br><span class="line"><span class="comment">#firewall-cmd --reload</span></span><br></pre></td></tr></table></figure>

<h3 id="开始端口监听并启动ovn-controller"><a href="#开始端口监听并启动ovn-controller" class="headerlink" title="开始端口监听并启动ovn-controller"></a>开始端口监听并启动ovn-controller</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#systemctl enable openvswitch ovn-controller</span></span><br><span class="line"><span class="comment">#systemctl start openvswitch ovn-controller</span></span><br></pre></td></tr></table></figure>

<h3 id="将控制器连接到中心节点并设置为geneve网络（如果需要接入vtep，则需要将网络设置为geneve和vxlan共存）"><a href="#将控制器连接到中心节点并设置为geneve网络（如果需要接入vtep，则需要将网络设置为geneve和vxlan共存）" class="headerlink" title="将控制器连接到中心节点并设置为geneve网络（如果需要接入vtep，则需要将网络设置为geneve和vxlan共存）"></a>将控制器连接到中心节点并设置为geneve网络（如果需要接入vtep，则需要将网络设置为geneve和vxlan共存）</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#节点172.16.126.71上</span></span><br><span class="line"><span class="comment">#ovs-vsctl set open . external-ids:ovn-remote=tcp:172.16.126.70:6642</span></span><br><span class="line"><span class="comment">#ovs-vsctl set open . external-ids:ovn-encap-type=geneve,vxlan</span></span><br><span class="line"><span class="comment">#ovs-vsctl set open . external-ids:ovn-encap-ip=172.16.126.71</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#节点172.16.126.72上</span></span><br><span class="line"><span class="comment">#ovs-vsctl set open . external-ids:ovn-remote=tcp:172.16.126.70:6642</span></span><br><span class="line"><span class="comment">#ovs-vsctl set open . external-ids:ovn-encap-type=geneve,vxlan</span></span><br><span class="line"><span class="comment">#ovs-vsctl set open . external-ids:ovn-encap-ip=172.16.126.72</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#此时查看central节点上的南向数据库，可以看到节点已经绑定</span></span><br><span class="line"><span class="comment"># ovn-sbctl show</span></span><br><span class="line">Chassis <span class="string">&quot;74ad0b26-6dde-4f0a-8244-c786e30ce953&quot;</span></span><br><span class="line">    hostname: <span class="string">&quot;ovn-node2&quot;</span></span><br><span class="line">    Encap vxlan</span><br><span class="line">        ip: <span class="string">&quot;172.16.126.72&quot;</span></span><br><span class="line">        options: &#123;csum=<span class="string">&quot;true&quot;</span>&#125;</span><br><span class="line">    Encap geneve</span><br><span class="line">        ip: <span class="string">&quot;172.16.126.72&quot;</span></span><br><span class="line">        options: &#123;csum=<span class="string">&quot;true&quot;</span>&#125;</span><br><span class="line">Chassis <span class="string">&quot;3d564c9f-d126-44a5-b604-0e165472e759&quot;</span></span><br><span class="line">    hostname: <span class="string">&quot;ovn-node1&quot;</span></span><br><span class="line">    Encap geneve</span><br><span class="line">        ip: <span class="string">&quot;172.16.126.71&quot;</span></span><br><span class="line">        options: &#123;csum=<span class="string">&quot;true&quot;</span>&#125;</span><br><span class="line">    Encap vxlan</span><br><span class="line">        ip: <span class="string">&quot;172.16.126.71&quot;</span></span><br><span class="line">        options: &#123;csum=<span class="string">&quot;true&quot;</span>&#125;</span><br></pre></td></tr></table></figure>

<h3 id="如果没有br-int网桥则创建网桥并设置网桥的接收流表方式为secure（仅接收控制器下发流表）"><a href="#如果没有br-int网桥则创建网桥并设置网桥的接收流表方式为secure（仅接收控制器下发流表）" class="headerlink" title="如果没有br-int网桥则创建网桥并设置网桥的接收流表方式为secure（仅接收控制器下发流表）"></a>如果没有br-int网桥则创建网桥并设置网桥的接收流表方式为secure（仅接收控制器下发流表）</h3><p>一般情况下，此时的br-int网桥会由上一步创建</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#ovs-vsctl add-br br-int -- set Bridge br-int fail-mode=secure</span></span><br></pre></td></tr></table></figure>

<h1 id="网络拓扑"><a href="#网络拓扑" class="headerlink" title="网络拓扑"></a>网络拓扑</h1><p><img src="https://s3.us-west-2.amazonaws.com/secure.notion-static.com/e17a94bc-d851-4502-8479-6b69d940d056/ovirt%E4%BA%91%E5%B9%B3%E5%8F%B0%E7%BD%91%E7%BB%9C%E6%8B%93%E6%89%91.bmp?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Content-Sha256=UNSIGNED-PAYLOAD&X-Amz-Credential=AKIAT73L2G45EIPT3X45/20211119/us-west-2/s3/aws4_request&X-Amz-Date=20211119T093206Z&X-Amz-Expires=86400&X-Amz-Signature=91d0132ce009d168b8ea1778f3d40b27906a6bba167995e18be236eedda61ff5&X-Amz-SignedHeaders=host&response-content-disposition=filename%20=%22ovirt%25E4%25BA%2591%25E5%25B9%25B3%25E5%258F%25B0%25E7%25BD%2591%25E7%25BB%259C%25E6%258B%2593%25E6%2589%2591.bmp%22&x-id=GetObject" alt="ovirt云平台网络拓扑"></p>
<h1 id="二层网络创建"><a href="#二层网络创建" class="headerlink" title="二层网络创建"></a>二层网络创建</h1><h2 id="创建逻辑交换机"><a href="#创建逻辑交换机" class="headerlink" title="创建逻辑交换机"></a>创建逻辑交换机</h2><p>在central节点上创建逻辑交换机</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#ovn-nbctl ls-add switchA</span></span><br><span class="line"><span class="comment">#下面这步骤指定子网为192.168.1.0/24网段，并排除192.168.1.1-192.168.1.80的DHCP分配，仅分配192.168.1.81-192.168.1.254中间分配</span></span><br><span class="line"><span class="comment">#在没有路由端口时，只有指定了子网才可以DHCP分配；如果有路由口，将server_id配置为路由口，则由路由口进行DHCP分配，就不用配置子网属性了</span></span><br><span class="line"><span class="comment">#ovn-nbctl set logical_switch switchA other_config:subnet=&quot;192.168.1.0/24&quot; other_config:exclude_ips=&quot;192.168.1.1..192.168.1.80&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#ovn-nbctl ls-add switchB</span></span><br><span class="line"><span class="comment">#下面这步骤指定子网为192.168.2.0/24网段，并排除192.168.2.1-192.168.2.80的DHCP分配，仅分配192.168.2.81-192.168.2.254中间分配</span></span><br><span class="line"><span class="comment">#在没有路由端口时，只有指定了子网才可以DHCP分配；如果有路由口，将server_id配置为路由口，则由路由口进行DHCP分配，就不用配置子网属性了</span></span><br><span class="line"><span class="comment">#ovn-nbctl set logical_switch switchB other_config:subnet=&quot;192.168.2.0/24&quot; other_config:exclude_ips=&quot;192.168.2.1..192.168.2.80&quot;</span></span><br></pre></td></tr></table></figure>

<p>为逻辑交换机switchA增加端口并设置端口的mac地址</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#ovn-nbctl lsp-add switchA switchA_portA</span></span><br><span class="line"><span class="comment">#ovn-nbctl lsp-set-addresses switchA_portA &quot;02:ac:10:ff:00:11&quot; #如果需要虚拟机手动设置IP地址就这样设置</span></span><br><span class="line"><span class="comment">#ovn-nbctl lsp-set-addresses switchA_portA &quot;02:ac:10:ff:00:11 dynamic&quot; #如果需要虚拟机DHCP获取IP地址就这样设置</span></span><br><span class="line"><span class="comment">#ovn-nbctl lsp-set-addresses switchA_portA &quot;02:ac:10:ff:00:11 192.168.1.20&quot; #如果需要虚拟机DHCP获取固定IP地址就这样设置</span></span><br><span class="line"><span class="comment">#ovn-nbctl lsp-set-port-security switchA_portA &quot;02:ac:10:ff:00:11&quot; #设置端口安全,限制出入端口的流量地址匹配</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#ovn-nbctl lsp-add switchA switchA_portB</span></span><br><span class="line"><span class="comment">#ovn-nbctl lsp-set-addresses switchA_portB &quot;02:ac:10:ff:00:22&quot; #如果需要虚拟机手动设置IP地址就这样设置</span></span><br><span class="line"><span class="comment">#ovn-nbctl lsp-set-addresses switchA_portB &quot;02:ac:10:ff:00:22 dynamic&quot; #如果需要虚拟机DHCP获取IP地址就这样设置</span></span><br><span class="line"><span class="comment">#ovn-nbctl lsp-set-addresses switchA_portB &quot;02:ac:10:ff:00:22 192.168.1.30&quot; #如果需要虚拟机DHCP获取固定IP地址就这样设置</span></span><br><span class="line"><span class="comment">#ovn-nbctl lsp-set-port-security switchA_portB &quot;02:ac:10:ff:00:22&quot;</span></span><br></pre></td></tr></table></figure>

<p>为逻辑交换机switchB增加端口并设置端口的mac地址</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#ovn-nbctl lsp-add switchB switchB_portA</span></span><br><span class="line"><span class="comment">#ovn-nbctl lsp-set-addresses switchB_portA &quot;02:ac:10:ff:00:33&quot; #如果需要虚拟机手动设置IP地址就这样设置</span></span><br><span class="line"><span class="comment">#ovn-nbctl lsp-set-addresses switchB_portA &quot;02:ac:10:ff:00:33 dynamic&quot; #如果需要虚拟机DHCP获取IP地址就这样设置</span></span><br><span class="line"><span class="comment">#ovn-nbctl lsp-set-addresses switchB_portA &quot;02:ac:10:ff:00:33 192.168.2.40&quot; #如果需要虚拟机DHCP获取固定IP地址就这样设置</span></span><br><span class="line"><span class="comment">#ovn-nbctl lsp-set-port-security switchB_portA &quot;02:ac:10:ff:00:33&quot; #设置端口安全,限制出入端口的流量地址匹配</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#ovn-nbctl lsp-add switchB switchB_portB</span></span><br><span class="line"><span class="comment">#ovn-nbctl lsp-set-addresses switchB_portB &quot;02:ac:10:ff:00:44&quot; #如果需要虚拟机手动设置IP地址就这样设置</span></span><br><span class="line"><span class="comment">#ovn-nbctl lsp-set-addresses switchB_portB &quot;02:ac:10:ff:00:44 dynamic&quot; #如果需要虚拟机DHCP获取IP地址就这样设置</span></span><br><span class="line"><span class="comment">#ovn-nbctl lsp-set-addresses switchB_portB &quot;02:ac:10:ff:00:44 192.168.2.50&quot; #如果需要虚拟机DHCP获取固定IP地址就这样设置</span></span><br><span class="line"><span class="comment">#ovn-nbctl lsp-set-port-security switchB_portB &quot;02:ac:10:ff:00:44&quot;</span></span><br></pre></td></tr></table></figure>

<h2 id="创建虚拟机并手动设置IP地址"><a href="#创建虚拟机并手动设置IP地址" class="headerlink" title="创建虚拟机并手动设置IP地址"></a>创建虚拟机并手动设置IP地址</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#使用命名空间进行测试，在node1上创建命名空间</span></span><br><span class="line"><span class="comment">#ip netns add vm1</span></span><br><span class="line"><span class="comment">#ovs-vsctl add-port br-int vm1_nic -- set interface vm1_nic type=internal</span></span><br><span class="line"><span class="comment">#ip link set vm1_nic netns vm1</span></span><br><span class="line"><span class="comment">#ip netns exec vm1 ip link set vm1_nic address 02:ac:10:ff:00:11</span></span><br><span class="line"><span class="comment">#ip netns exec vm1 ip addr add 192.168.1.11/24 dev vm1_nic</span></span><br><span class="line"><span class="comment">#ip netns exec vm1 ip link set vm1_nic up</span></span><br><span class="line"><span class="comment">#ovs-vsctl set interface vm1_nic external_ids:iface-id=switchA_portA</span></span><br><span class="line"><span class="comment">#ip netns exec vm1 ip addr</span></span><br><span class="line"><span class="comment">#ip netns exec vm1 ip route show</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#ip netns add vm3</span></span><br><span class="line"><span class="comment">#ovs-vsctl add-port br-int vm3_nic -- set interface vm3_nic type=internal</span></span><br><span class="line"><span class="comment">#ip link set vm3_nic netns vm3</span></span><br><span class="line"><span class="comment">#ip netns exec vm3 ip link set vm3_nic address 02:ac:10:ff:00:33</span></span><br><span class="line"><span class="comment">#ip netns exec vm3 ip addr add 192.168.2.13/24 dev vm3_nic</span></span><br><span class="line"><span class="comment">#ip netns exec vm3 ip link set vm3_nic up</span></span><br><span class="line"><span class="comment">#ovs-vsctl set interface vm3_nic external_ids:iface-id=switchB_portA</span></span><br><span class="line"><span class="comment">#ip netns exec vm3 ip addr</span></span><br><span class="line"><span class="comment">#ip netns exec vm3 ip route show</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#使用命名空间进行测试，在node2上创建命名空间</span></span><br><span class="line"><span class="comment">#ip netns add vm2</span></span><br><span class="line"><span class="comment">#ovs-vsctl add-port br-int vm2_nic -- set interface vm2_nic type=internal</span></span><br><span class="line"><span class="comment">#ip link set vm2_nic netns vm2</span></span><br><span class="line"><span class="comment">#ip netns exec vm2 ip link set vm2_nic address 02:ac:10:ff:00:22</span></span><br><span class="line"><span class="comment">#ip netns exec vm2 ip addr add 192.168.1.12/24 dev vm2_nic</span></span><br><span class="line"><span class="comment">#ip netns exec vm2 ip link set vm2_nic up</span></span><br><span class="line"><span class="comment">#ovs-vsctl set interface vm2_nic external_ids:iface-id=switchA_portB</span></span><br><span class="line"><span class="comment">#ip netns exec vm2 ip addr</span></span><br><span class="line"><span class="comment">#ip netns exec vm2 ip route show</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#ip netns add vm4</span></span><br><span class="line"><span class="comment">#ovs-vsctl add-port br-int vm4_nic -- set interface vm4_nic type=internal</span></span><br><span class="line"><span class="comment">#ip link set vm4_nic netns vm4</span></span><br><span class="line"><span class="comment">#ip netns exec vm4 ip link set vm4_nic address 02:ac:10:ff:00:44</span></span><br><span class="line"><span class="comment">#ip netns exec vm4 ip addr add 192.168.2.14/24 dev vm4_nic</span></span><br><span class="line"><span class="comment">#ip netns exec vm4 ip link set vm4_nic up</span></span><br><span class="line"><span class="comment">#ovs-vsctl set interface vm4_nic external_ids:iface-id=switchB_portB</span></span><br><span class="line"><span class="comment">#ip netns exec vm4 ip addr</span></span><br><span class="line"><span class="comment">#ip netns exec vm4 ip route show</span></span><br></pre></td></tr></table></figure>

<p>此时查看南向数据库端口绑定</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@ovn-central ~]<span class="comment"># ovn-sbctl show</span></span><br><span class="line">Chassis <span class="string">&quot;74ad0b26-6dde-4f0a-8244-c786e30ce953&quot;</span></span><br><span class="line">    hostname: <span class="string">&quot;ovn-node2&quot;</span></span><br><span class="line">    Encap vxlan</span><br><span class="line">        ip: <span class="string">&quot;172.16.126.72&quot;</span></span><br><span class="line">        options: &#123;csum=<span class="string">&quot;true&quot;</span>&#125;</span><br><span class="line">    Encap geneve</span><br><span class="line">        ip: <span class="string">&quot;172.16.126.72&quot;</span></span><br><span class="line">        options: &#123;csum=<span class="string">&quot;true&quot;</span>&#125;</span><br><span class="line">    Port_Binding switchB_portB</span><br><span class="line">    Port_Binding switchA_portB</span><br><span class="line">Chassis <span class="string">&quot;3d564c9f-d126-44a5-b604-0e165472e759&quot;</span></span><br><span class="line">    hostname: <span class="string">&quot;ovn-node1&quot;</span></span><br><span class="line">    Encap geneve</span><br><span class="line">        ip: <span class="string">&quot;172.16.126.71&quot;</span></span><br><span class="line">        options: &#123;csum=<span class="string">&quot;true&quot;</span>&#125;</span><br><span class="line">    Encap vxlan</span><br><span class="line">        ip: <span class="string">&quot;172.16.126.71&quot;</span></span><br><span class="line">        options: &#123;csum=<span class="string">&quot;true&quot;</span>&#125;</span><br><span class="line">    Port_Binding switchA_portA</span><br><span class="line">    Port_Binding switchB_portA</span><br></pre></td></tr></table></figure>

<p>测试虚拟机互通，可以看出二层网络已经打通，三层不通</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ip netns exec vm1 ping 192.168.1.12</span></span><br><span class="line">PING 192.168.1.12 (192.168.1.12) 56(84) bytes of data.</span><br><span class="line">64 bytes from 192.168.1.12: icmp_seq=1 ttl=64 time=4.08 ms</span><br><span class="line">64 bytes from 192.168.1.12: icmp_seq=2 ttl=64 time=0.561 ms</span><br><span class="line">^C</span><br><span class="line">--- 192.168.1.12 ping statistics ---</span><br><span class="line">2 packets transmitted, 2 received, 0% packet loss, time 1001ms</span><br><span class="line">rtt min/avg/max/mdev = 0.561/2.325/4.089/1.764 ms</span><br><span class="line"><span class="comment"># ip netns exec vm3 ping 192.168.2.14</span></span><br><span class="line">PING 192.168.2.14 (192.168.2.14) 56(84) bytes of data.</span><br><span class="line">64 bytes from 192.168.2.14: icmp_seq=1 ttl=64 time=2.93 ms</span><br><span class="line">64 bytes from 192.168.2.14: icmp_seq=2 ttl=64 time=0.501 ms</span><br><span class="line">64 bytes from 192.168.2.14: icmp_seq=3 ttl=64 time=0.578 ms</span><br><span class="line">^C</span><br><span class="line">--- 192.168.2.14 ping statistics ---</span><br><span class="line">3 packets transmitted, 3 received, 0% packet loss, time 2001ms</span><br><span class="line">rtt min/avg/max/mdev = 0.501/1.337/2.934/1.130 ms</span><br><span class="line"></span><br><span class="line"><span class="comment"># ip netns exec vm3 ping 192.168.1.11</span></span><br><span class="line">connect: Network is unreachable</span><br><span class="line"></span><br><span class="line"><span class="comment"># ip netns exec vm3 ping 192.168.1.12</span></span><br><span class="line">connect: Network is unreachable</span><br><span class="line"></span><br><span class="line"><span class="comment"># ip netns exec vm1 ping 192.168.2.13</span></span><br><span class="line">connect: Network is unreachable</span><br><span class="line"></span><br><span class="line"><span class="comment"># ip netns exec vm1 ping 192.168.2.14</span></span><br><span class="line">connect: Network is unreachable</span><br></pre></td></tr></table></figure>

<h2 id="创建并分配DHCP选项给端口"><a href="#创建并分配DHCP选项给端口" class="headerlink" title="创建并分配DHCP选项给端口"></a>创建并分配DHCP选项给端口</h2><p>创建DHCP选项</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ovn-nbctl dhcp-options-create 192.168.1.0/24 network=switchA</span></span><br><span class="line"><span class="comment"># ovn-nbctl dhcp-options-create 192.168.2.0/24 network=switchB</span></span><br></pre></td></tr></table></figure>

<p>查看DHCP选项</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ovn-nbctl list dhcp-options</span></span><br><span class="line">_uuid               : 1e204723-aa55-405f-a9c5-8a36aaf40805</span><br><span class="line">cidr                : <span class="string">&quot;192.168.1.0/24&quot;</span></span><br><span class="line">external_ids        : &#123;network=switchA&#125;</span><br><span class="line">options             : &#123;&#125;</span><br><span class="line"></span><br><span class="line">_uuid               : e483f5df-9e03-49b1-a5e0-dce69f10971f</span><br><span class="line">cidr                : <span class="string">&quot;192.168.2.0/24&quot;</span></span><br><span class="line">external_ids        : &#123;network=switchB&#125;</span><br><span class="line">options             : &#123;&#125;</span><br></pre></td></tr></table></figure>

<p>填充DHCP参数</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#此处的server_id和server_mac需要填写，但是值不重要，可以填路由地址或者网络地址，因为采用了openflow的DHCP自回应(二层DHCP回应)</span></span><br><span class="line"><span class="comment"># ovn-nbctl dhcp-options-set-options 1e204723-aa55-405f-a9c5-8a36aaf40805 lease_time=86400 router=192.168.1.1 server_id=192.168.1.0 server_mac=03:ac:10:ff:00:11</span></span><br><span class="line"><span class="comment"># ovn-nbctl dhcp-options-set-options e483f5df-9e03-49b1-a5e0-dce69f10971f lease_time=86400 router=192.168.2.1 server_id=192.168.2.0 server_mac=03:ac:10:ff:00:22</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ovn-nbctl list dhcp-options</span></span><br><span class="line">_uuid               : 1e204723-aa55-405f-a9c5-8a36aaf40805</span><br><span class="line">cidr                : <span class="string">&quot;192.168.1.0/24&quot;</span></span><br><span class="line">external_ids        : &#123;network=switchA&#125;</span><br><span class="line">options             : &#123;lease_time=<span class="string">&quot;3600&quot;</span>, router=<span class="string">&quot;192.168.1.1&quot;</span>, server_id=<span class="string">&quot;192.168.1.0&quot;</span>, server_mac=<span class="string">&quot;03:ac:10:ff:00:11&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line">_uuid               : e483f5df-9e03-49b1-a5e0-dce69f10971f</span><br><span class="line">cidr                : <span class="string">&quot;192.168.2.0/24&quot;</span></span><br><span class="line">external_ids        : &#123;network=switchB&#125;</span><br><span class="line">options             : &#123;lease_time=<span class="string">&quot;3600&quot;</span>, router=<span class="string">&quot;192.168.2.1&quot;</span>, server_id=<span class="string">&quot;192.168.2.0&quot;</span>, server_mac=<span class="string">&quot;03:ac:10:ff:00:22&quot;</span>&#125;</span><br></pre></td></tr></table></figure>

<p>分配DHCP给逻辑端口</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#为logical_switch_port分配DHCP</span></span><br><span class="line"><span class="comment"># ovn-nbctl lsp-set-dhcpv4-options switchA_portA 1e204723-aa55-405f-a9c5-8a36aaf40805</span></span><br><span class="line"><span class="comment"># ovn-nbctl lsp-set-dhcpv4-options switchA_portB 1e204723-aa55-405f-a9c5-8a36aaf40805</span></span><br><span class="line"><span class="comment"># ovn-nbctl lsp-set-dhcpv4-options switchB_portA e483f5df-9e03-49b1-a5e0-dce69f10971f</span></span><br><span class="line"><span class="comment"># ovn-nbctl lsp-set-dhcpv4-options switchB_portB e483f5df-9e03-49b1-a5e0-dce69f10971f</span></span><br></pre></td></tr></table></figure>

<h2 id="虚拟机DHCP从IP池中分配IP地址"><a href="#虚拟机DHCP从IP池中分配IP地址" class="headerlink" title="虚拟机DHCP从IP池中分配IP地址"></a>虚拟机DHCP从IP池中分配IP地址</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#VM1 DHCP分配</span></span><br><span class="line"><span class="comment"># ip netns exec vm1 dhclient -d vm1_nic</span></span><br><span class="line">Internet Systems Consortium DHCP Client 4.2.5</span><br><span class="line">Copyright 2004-2013 Internet Systems Consortium.</span><br><span class="line">All rights reserved.</span><br><span class="line">For info, please visit https://www.isc.org/software/dhcp/</span><br><span class="line"></span><br><span class="line">Listening on LPF/vm1_nic/02:ac:10:ff:00:11</span><br><span class="line">Sending on   LPF/vm1_nic/02:ac:10:ff:00:11</span><br><span class="line">Sending on   Socket/fallback</span><br><span class="line">DHCPDISCOVER on vm1_nic to 255.255.255.255 port 67 interval 4 (xid=0x13b2fb58)</span><br><span class="line">DHCPREQUEST on vm1_nic to 255.255.255.255 port 67 (xid=0x13b2fb58)</span><br><span class="line">DHCPOFFER from 192.168.1.0</span><br><span class="line">DHCPACK from 192.168.1.0 (xid=0x13b2fb58)</span><br><span class="line">bound to 192.168.1.81 -- renewal <span class="keyword">in</span> 1469 seconds.</span><br><span class="line"></span><br><span class="line"><span class="comment">#VM3 DHCP分配</span></span><br><span class="line"><span class="comment"># ip netns exec vm3 dhclient -d vm3_nic</span></span><br><span class="line">Internet Systems Consortium DHCP Client 4.2.5</span><br><span class="line">Copyright 2004-2013 Internet Systems Consortium.</span><br><span class="line">All rights reserved.</span><br><span class="line">For info, please visit https://www.isc.org/software/dhcp/</span><br><span class="line"></span><br><span class="line">Listening on LPF/vm3_nic/02:ac:10:ff:00:33</span><br><span class="line">Sending on   LPF/vm3_nic/02:ac:10:ff:00:33</span><br><span class="line">Sending on   Socket/fallback</span><br><span class="line">DHCPDISCOVER on vm3_nic to 255.255.255.255 port 67 interval 6 (xid=0x4059d691)</span><br><span class="line">DHCPREQUEST on vm3_nic to 255.255.255.255 port 67 (xid=0x4059d691)</span><br><span class="line">DHCPOFFER from 192.168.2.0</span><br><span class="line">DHCPACK from 192.168.2.0 (xid=0x4059d691)</span><br><span class="line">bound to 192.168.2.82 -- renewal <span class="keyword">in</span> 1639 seconds.</span><br><span class="line"></span><br><span class="line"><span class="comment">#VM2 DHCP分配</span></span><br><span class="line"><span class="comment"># ip netns exec vm2 dhclient -d vm2_nic</span></span><br><span class="line">Internet Systems Consortium DHCP Client 4.2.5</span><br><span class="line">Copyright 2004-2013 Internet Systems Consortium.</span><br><span class="line">All rights reserved.</span><br><span class="line">For info, please visit https://www.isc.org/software/dhcp/</span><br><span class="line"></span><br><span class="line">Listening on LPF/vm2_nic/02:ac:10:ff:00:22</span><br><span class="line">Sending on   LPF/vm2_nic/02:ac:10:ff:00:22</span><br><span class="line">Sending on   Socket/fallback</span><br><span class="line">DHCPDISCOVER on vm2_nic to 255.255.255.255 port 67 interval 8 (xid=0x2a5bf2d9)</span><br><span class="line">DHCPREQUEST on vm2_nic to 255.255.255.255 port 67 (xid=0x2a5bf2d9)</span><br><span class="line">DHCPOFFER from 192.168.1.0</span><br><span class="line">DHCPACK from 192.168.1.0 (xid=0x2a5bf2d9)</span><br><span class="line">bound to 192.168.1.82 -- renewal <span class="keyword">in</span> 1674 seconds.</span><br><span class="line"></span><br><span class="line"><span class="comment">#VM4 DHCP分配</span></span><br><span class="line"><span class="comment"># ip netns exec vm4 dhclient -d vm4_nic</span></span><br><span class="line">Internet Systems Consortium DHCP Client 4.2.5</span><br><span class="line">Copyright 2004-2013 Internet Systems Consortium.</span><br><span class="line">All rights reserved.</span><br><span class="line">For info, please visit https://www.isc.org/software/dhcp/</span><br><span class="line"></span><br><span class="line">Listening on LPF/vm4_nic/02:ac:10:ff:00:44</span><br><span class="line">Sending on   LPF/vm4_nic/02:ac:10:ff:00:44</span><br><span class="line">Sending on   Socket/fallback</span><br><span class="line">DHCPDISCOVER on vm4_nic to 255.255.255.255 port 67 interval 8 (xid=0x173b5665)</span><br><span class="line">DHCPREQUEST on vm4_nic to 255.255.255.255 port 67 (xid=0x173b5665)</span><br><span class="line">DHCPOFFER from 192.168.2.0</span><br><span class="line">DHCPACK from 192.168.2.0 (xid=0x173b5665)</span><br><span class="line">bound to 192.168.2.81 -- renewal <span class="keyword">in</span> 1680 seconds.</span><br></pre></td></tr></table></figure>

<h2 id="虚拟机DHCP分配固定IP地址"><a href="#虚拟机DHCP分配固定IP地址" class="headerlink" title="虚拟机DHCP分配固定IP地址"></a>虚拟机DHCP分配固定IP地址</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#VM1 DHCP分配固定IP地址</span></span><br><span class="line"><span class="comment"># ip netns exec vm1 dhclient -d vm1_nic</span></span><br><span class="line">Internet Systems Consortium DHCP Client 4.2.5</span><br><span class="line">Copyright 2004-2013 Internet Systems Consortium.</span><br><span class="line">All rights reserved.</span><br><span class="line">For info, please visit https://www.isc.org/software/dhcp/</span><br><span class="line"></span><br><span class="line">Listening on LPF/vm1_nic/02:ac:10:ff:00:11</span><br><span class="line">Sending on   LPF/vm1_nic/02:ac:10:ff:00:11</span><br><span class="line">Sending on   Socket/fallback</span><br><span class="line">DHCPREQUEST on vm1_nic to 255.255.255.255 port 67 (xid=0x1f1eaf4)</span><br><span class="line">DHCPNAK from 192.168.1.1 (xid=0x1f1eaf4)</span><br><span class="line">DHCPDISCOVER on vm1_nic to 255.255.255.255 port 67 interval 6 (xid=0x1706fa15)</span><br><span class="line">DHCPREQUEST on vm1_nic to 255.255.255.255 port 67 (xid=0x1706fa15)</span><br><span class="line">DHCPOFFER from 192.168.1.1</span><br><span class="line">DHCPACK from 192.168.1.1 (xid=0x1706fa15)</span><br><span class="line">bound to 192.168.1.20 -- renewal <span class="keyword">in</span> 1643 seconds.</span><br><span class="line">^C</span><br><span class="line"></span><br><span class="line"><span class="comment">#VM2 DHCP分配固定IP地址</span></span><br><span class="line"><span class="comment"># ip netns exec vm3 dhclient -d vm3_nic</span></span><br><span class="line">Internet Systems Consortium DHCP Client 4.2.5</span><br><span class="line">Copyright 2004-2013 Internet Systems Consortium.</span><br><span class="line">All rights reserved.</span><br><span class="line">For info, please visit https://www.isc.org/software/dhcp/</span><br><span class="line"></span><br><span class="line">Listening on LPF/vm3_nic/02:ac:10:ff:00:33</span><br><span class="line">Sending on   LPF/vm3_nic/02:ac:10:ff:00:33</span><br><span class="line">Sending on   Socket/fallback</span><br><span class="line">DHCPREQUEST on vm3_nic to 255.255.255.255 port 67 (xid=0x1a89050f)</span><br><span class="line">DHCPNAK from 192.168.2.1 (xid=0x1a89050f)</span><br><span class="line">DHCPDISCOVER on vm3_nic to 255.255.255.255 port 67 interval 7 (xid=0x5158e2c)</span><br><span class="line">DHCPREQUEST on vm3_nic to 255.255.255.255 port 67 (xid=0x5158e2c)</span><br><span class="line">DHCPOFFER from 192.168.2.1</span><br><span class="line">DHCPACK from 192.168.2.1 (xid=0x5158e2c)</span><br><span class="line">bound to 192.168.2.40 -- renewal <span class="keyword">in</span> 1558 seconds.</span><br><span class="line"></span><br><span class="line"><span class="comment">#VM3 DHCP分配固定IP地址</span></span><br><span class="line"><span class="comment"># ip netns exec vm2 dhclient -d vm2_nic</span></span><br><span class="line">Internet Systems Consortium DHCP Client 4.2.5</span><br><span class="line">Copyright 2004-2013 Internet Systems Consortium.</span><br><span class="line">All rights reserved.</span><br><span class="line">For info, please visit https://www.isc.org/software/dhcp/</span><br><span class="line"></span><br><span class="line">Listening on LPF/vm2_nic/02:ac:10:ff:00:22</span><br><span class="line">Sending on   LPF/vm2_nic/02:ac:10:ff:00:22</span><br><span class="line">Sending on   Socket/fallback</span><br><span class="line">DHCPREQUEST on vm2_nic to 255.255.255.255 port 67 (xid=0x22dbe262)</span><br><span class="line">DHCPNAK from 192.168.1.1 (xid=0x22dbe262)</span><br><span class="line">DHCPDISCOVER on vm2_nic to 255.255.255.255 port 67 interval 3 (xid=0x6ac15f68)</span><br><span class="line">DHCPREQUEST on vm2_nic to 255.255.255.255 port 67 (xid=0x6ac15f68)</span><br><span class="line">DHCPOFFER from 192.168.1.1</span><br><span class="line">DHCPACK from 192.168.1.1 (xid=0x6ac15f68)</span><br><span class="line">bound to 192.168.1.30 -- renewal <span class="keyword">in</span> 1700 seconds.</span><br><span class="line"></span><br><span class="line"><span class="comment">#VM4 DHCP分配固定IP地址</span></span><br><span class="line"><span class="comment"># ip netns exec vm4 dhclient -d vm4_nic</span></span><br><span class="line">Internet Systems Consortium DHCP Client 4.2.5</span><br><span class="line">Copyright 2004-2013 Internet Systems Consortium.</span><br><span class="line">All rights reserved.</span><br><span class="line">For info, please visit https://www.isc.org/software/dhcp/</span><br><span class="line"></span><br><span class="line">Listening on LPF/vm4_nic/02:ac:10:ff:00:44</span><br><span class="line">Sending on   LPF/vm4_nic/02:ac:10:ff:00:44</span><br><span class="line">Sending on   Socket/fallback</span><br><span class="line">DHCPREQUEST on vm4_nic to 255.255.255.255 port 67 (xid=0x18ab31df)</span><br><span class="line">DHCPNAK from 192.168.2.1 (xid=0x18ab31df)</span><br><span class="line">DHCPDISCOVER on vm4_nic to 255.255.255.255 port 67 interval 8 (xid=0x50ca1ad2)</span><br><span class="line">DHCPREQUEST on vm4_nic to 255.255.255.255 port 67 (xid=0x50ca1ad2)</span><br><span class="line">DHCPOFFER from 192.168.2.1</span><br><span class="line">DHCPACK from 192.168.2.1 (xid=0x50ca1ad2)</span><br><span class="line">bound to 192.168.2.50 -- renewal <span class="keyword">in</span> 1408 seconds.</span><br></pre></td></tr></table></figure>

<h2 id="跟踪DHCP请求和回应"><a href="#跟踪DHCP请求和回应" class="headerlink" title="跟踪DHCP请求和回应"></a>跟踪DHCP请求和回应</h2><p>在ovn-central上可以根据ovn-trace来跟踪DHCP的请求和响应</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ovn-trace --summary switchA &#x27;inport==&quot;switchA_portA&quot; &amp;&amp; eth.src==02:ac:10:ff:00:11 &amp;&amp; ip4.src==0.0.0.0 &amp;&amp; ip.ttl==1 &amp;&amp; ip4.dst==255.255.255.255 &amp;&amp; udp.src==68 &amp;&amp; udp.dst==67&#x27;</span></span><br><span class="line"><span class="comment">#跟踪到的信息如下</span></span><br><span class="line"><span class="comment"># udp,reg14=0x1,vlan_tci=0x0000,dl_src=02:ac:10:ff:00:11,dl_dst=00:00:00:00:00:00,nw_src=0.0.0.0,nw_dst=255.255.255.255,nw_tos=0,nw_ecn=0,nw_ttl=1,tp_src=68,tp_dst=67</span></span><br><span class="line">ingress(dp=<span class="string">&quot;switchA&quot;</span>, inport=<span class="string">&quot;switchA_portA&quot;</span>) &#123;</span><br><span class="line">    next;</span><br><span class="line">    reg0[3] = put_dhcp_opts(offerip = 192.168.1.20, lease_time = 86400, netmask = 255.255.255.0, router = 192.168.1.1, server_id = 192.168.1.0);</span><br><span class="line">    /* We assume that this packet is DHCPDISCOVER or DHCPREQUEST. */;</span><br><span class="line">    next;</span><br><span class="line">    eth.dst = eth.src;</span><br><span class="line">    eth.src = 03:ac:10:ff:00:11;</span><br><span class="line">    ip4.dst = 192.168.1.20;</span><br><span class="line">    ip4.src = 192.168.1.0;</span><br><span class="line">    udp.src = 67;</span><br><span class="line">    udp.dst = 68;</span><br><span class="line">    outport = inport;</span><br><span class="line">    flags.loopback = 1;</span><br><span class="line">    output;</span><br><span class="line">    egress(dp=<span class="string">&quot;switchA&quot;</span>, inport=<span class="string">&quot;switchA_portA&quot;</span>, outport=<span class="string">&quot;switchA_portA&quot;</span>) &#123;</span><br><span class="line">        next;</span><br><span class="line">        output;</span><br><span class="line">        /* output to <span class="string">&quot;switchA_portA&quot;</span>, <span class="built_in">type</span> <span class="string">&quot;&quot;</span> */;</span><br><span class="line">    &#125;;</span><br></pre></td></tr></table></figure>

<h1 id="三层网络创建"><a href="#三层网络创建" class="headerlink" title="三层网络创建"></a>三层网络创建</h1><h2 id="创建逻辑路由器"><a href="#创建逻辑路由器" class="headerlink" title="创建逻辑路由器"></a>创建逻辑路由器</h2><p>在central节点创建逻辑路由器</p>
<p>创建路基路由器A，并创建逻辑路由器A到逻辑交换机的接口。注意逻辑路由器上的IP地址为逻辑交换机的网关地址，而且必须配子网掩码</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#ovn-nbctl lr-add routerA</span></span><br><span class="line"><span class="comment">#ovn-nbctl lrp-add routerA routerA2switchA 02:ac:10:ff:01:88 192.168.1.1/24</span></span><br><span class="line"><span class="comment">#ovn-nbctl lrp-add routerA routerA2switchB 02:ac:10:ff:01:99 192.168.2.1/24</span></span><br></pre></td></tr></table></figure>

<h2 id="创建逻辑交换机上的路由端口"><a href="#创建逻辑交换机上的路由端口" class="headerlink" title="创建逻辑交换机上的路由端口"></a>创建逻辑交换机上的路由端口</h2><p>创建逻辑交换机A到逻辑路由器A的接口</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#ovn-nbctl lsp-add switchA switchA2routerA </span></span><br><span class="line"><span class="comment">#ovn-nbctl lsp-set-type switchA2routerA router</span></span><br><span class="line"><span class="comment">#ovn-nbctl lsp-set-addresses switchA2routerA 02:ac:10:ff:01:88</span></span><br><span class="line"><span class="comment">#ovn-nbctl lsp-set-options switchA2routerA router-port=routerA2switchA</span></span><br></pre></td></tr></table></figure>

<p>创建逻辑交换机B到逻辑路由器A的接口</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#ovn-nbctl lsp-add switchB switchB2routerA</span></span><br><span class="line"><span class="comment">#ovn-nbctl lsp-set-type switchB2routerA router</span></span><br><span class="line"><span class="comment">#ovn-nbctl lsp-set-addresses switchB2routerA 02:ac:10:ff:01:99</span></span><br><span class="line"><span class="comment">#ovn-nbctl lsp-set-options switchB2routerA router-port=routerA2switchB</span></span><br></pre></td></tr></table></figure>

<p>查看此时逻辑网络</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ovn-nbctl show</span></span><br><span class="line">switch 0acd0085-18ab-489e-85db-67f31173c17d (switchB)</span><br><span class="line">    port switchB_portB</span><br><span class="line">        addresses: [<span class="string">&quot;02:ac:10:ff:00:44 192.168.2.50&quot;</span>]</span><br><span class="line">    port switchB_portA</span><br><span class="line">        addresses: [<span class="string">&quot;02:ac:10:ff:00:33 192.168.2.40&quot;</span>]</span><br><span class="line">    port switchB2routerA</span><br><span class="line">        <span class="built_in">type</span>: router</span><br><span class="line">        addresses: [<span class="string">&quot;02:ac:10:ff:01:99&quot;</span>]</span><br><span class="line">        router-port: routerA2switchB</span><br><span class="line">switch 1d8ff1a1-91d5-46f5-9f9b-ce631353e102 (switchA)</span><br><span class="line">    port switchA_portA</span><br><span class="line">        addresses: [<span class="string">&quot;02:ac:10:ff:00:11 192.168.1.20&quot;</span>]</span><br><span class="line">    port switchA2routerA</span><br><span class="line">        <span class="built_in">type</span>: router</span><br><span class="line">        addresses: [<span class="string">&quot;02:ac:10:ff:01:88&quot;</span>]</span><br><span class="line">        router-port: routerA2switchA</span><br><span class="line">    port switchA_portB</span><br><span class="line">        addresses: [<span class="string">&quot;02:ac:10:ff:00:22 192.168.1.30&quot;</span>]</span><br><span class="line">router bd119949-3cf7-4440-b79e-f861feb7d5a5 (routerA)</span><br><span class="line">    port routerA2switchB</span><br><span class="line">        mac: <span class="string">&quot;02:ac:10:ff:01:99&quot;</span></span><br><span class="line">        networks: [<span class="string">&quot;192.168.2.1/24&quot;</span>]</span><br><span class="line">    port routerA2switchA</span><br><span class="line">        mac: <span class="string">&quot;02:ac:10:ff:01:88&quot;</span></span><br><span class="line">        networks: [<span class="string">&quot;192.168.1.1/24&quot;</span>]</span><br></pre></td></tr></table></figure>

<h2 id="虚拟机互通测试"><a href="#虚拟机互通测试" class="headerlink" title="虚拟机互通测试"></a>虚拟机互通测试</h2><p>从node1上的vm1测试到switchA网关的连通性</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ip netns exec vm1 ping 192.168.1.1</span></span><br><span class="line">PING 192.168.1.1 (192.168.1.1) 56(84) bytes of data.</span><br><span class="line">64 bytes from 192.168.1.1: icmp_seq=1 ttl=254 time=0.238 ms</span><br><span class="line">64 bytes from 192.168.1.1: icmp_seq=2 ttl=254 time=0.261 ms</span><br><span class="line">64 bytes from 192.168.1.1: icmp_seq=3 ttl=254 time=0.129 ms</span><br></pre></td></tr></table></figure>

<p>从node1上的vm1上测试跨越本机逻辑路由器的连通性</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ip netns exec vm1 ping 192.168.2.40</span></span><br><span class="line">PING 192.168.2.40 (192.168.2.40) 56(84) bytes of data.</span><br><span class="line">64 bytes from 192.168.2.40: icmp_seq=1 ttl=63 time=0.406 ms</span><br><span class="line">64 bytes from 192.168.2.40: icmp_seq=2 ttl=63 time=0.077 ms</span><br><span class="line">64 bytes from 192.168.2.40: icmp_seq=3 ttl=63 time=0.062 ms</span><br></pre></td></tr></table></figure>

<p>从node1上的vm1上测试跨越不同主机SDN网络的连通性</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ip netns exec vm1 ping 192.168.2.50</span></span><br><span class="line">PING 192.168.2.50 (192.168.2.50) 56(84) bytes of data.</span><br><span class="line">64 bytes from 192.168.2.50: icmp_seq=1 ttl=63 time=4.97 ms</span><br><span class="line">64 bytes from 192.168.2.50: icmp_seq=2 ttl=63 time=1.06 ms</span><br><span class="line">64 bytes from 192.168.2.50: icmp_seq=3 ttl=63 time=0.582 ms</span><br></pre></td></tr></table></figure>

<h1 id="连接外部网络"><a href="#连接外部网络" class="headerlink" title="连接外部网络"></a>连接外部网络</h1><h2 id="创建外部逻辑交换机"><a href="#创建外部逻辑交换机" class="headerlink" title="创建外部逻辑交换机"></a>创建外部逻辑交换机</h2><p>在central节点上创外部建逻辑交换机</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#ovn-nbctl ls-add switch_external</span></span><br></pre></td></tr></table></figure>

<p>为外部逻辑交换机增加外部端口</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#ovn-nbctl lsp-add switch_external external_port</span></span><br><span class="line"><span class="comment">#ovn-nbctl lsp-set-type external_port localnet</span></span><br><span class="line"><span class="comment">#ovn-nbctl lsp-set-addresses external_port unknown</span></span><br><span class="line"><span class="comment">#ovn-nbctl lsp-set-options external_port network_name=dataNet</span></span><br></pre></td></tr></table></figure>

<p>为外部逻辑交换机增加到逻辑路由器A的端口</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#ovn-nbctl lsp-add switch_external external2routerA</span></span><br><span class="line"><span class="comment">#ovn-nbctl lsp-set-type external2routerA router</span></span><br><span class="line"><span class="comment">#ovn-nbctl lsp-set-addresses external2routerA 02:ac:10:ff:01:77</span></span><br><span class="line"><span class="comment">#ovn-nbctl lsp-set-options external2routerA router-port=routerA2external</span></span><br></pre></td></tr></table></figure>

<h2 id="设置逻辑路由器"><a href="#设置逻辑路由器" class="headerlink" title="设置逻辑路由器"></a>设置逻辑路由器</h2><p>查看绑定的计算节点</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ovn-sbctl show</span></span><br><span class="line">Chassis <span class="string">&quot;74ad0b26-6dde-4f0a-8244-c786e30ce953&quot;</span></span><br><span class="line">    hostname: <span class="string">&quot;ovn-node2&quot;</span></span><br><span class="line">    Encap vxlan</span><br><span class="line">        ip: <span class="string">&quot;172.16.126.72&quot;</span></span><br><span class="line">        options: &#123;csum=<span class="string">&quot;true&quot;</span>&#125;</span><br><span class="line">    Encap geneve</span><br><span class="line">        ip: <span class="string">&quot;172.16.126.72&quot;</span></span><br><span class="line">        options: &#123;csum=<span class="string">&quot;true&quot;</span>&#125;</span><br><span class="line">    Port_Binding switchB_portB</span><br><span class="line">    Port_Binding switchA_portB</span><br><span class="line">Chassis <span class="string">&quot;3d564c9f-d126-44a5-b604-0e165472e759&quot;</span></span><br><span class="line">    hostname: <span class="string">&quot;ovn-node1&quot;</span></span><br><span class="line">    Encap geneve</span><br><span class="line">        ip: <span class="string">&quot;172.16.126.71&quot;</span></span><br><span class="line">        options: &#123;csum=<span class="string">&quot;true&quot;</span>&#125;</span><br><span class="line">    Encap vxlan</span><br><span class="line">        ip: <span class="string">&quot;172.16.126.71&quot;</span></span><br><span class="line">        options: &#123;csum=<span class="string">&quot;true&quot;</span>&#125;</span><br><span class="line">    Port_Binding switchA_portA</span><br><span class="line">    Port_Binding switchB_portA</span><br></pre></td></tr></table></figure>

<p>为逻辑路由器增加到外部逻辑交换机的端口，端口IP必须为外部网络中未使用的IP地址，我们可以在外部逻辑交换机中预留一段IP地址</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#ovn-nbctl lrp-add routerA routerA2external 02:ac:10:ff:01:77 172.16.126.74/24</span></span><br></pre></td></tr></table></figure>

<p>为端口设置网络节点，将node1和node2均作为网络节点（平衡负载），并设置优先级</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#ovn-nbctl lrp-set-gateway-chassis routerA2external 3d564c9f-d126-44a5-b604-0e165472e759 100</span></span><br><span class="line"><span class="comment">#ovn-nbctl lrp-set-gateway-chassis routerA2external 74ad0b26-6dde-4f0a-8244-c786e30ce953 90</span></span><br></pre></td></tr></table></figure>

<p>此时可以在节点1和节点2上看到bfd信息，此处有问题，如何实现负载自动切换，是需要设置HA吧</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#ovn-node1</span></span><br><span class="line"><span class="comment"># ovs-vsctl show</span></span><br><span class="line">ebabcc03-5219-421a-9562-7443921fa275</span><br><span class="line">    Bridge br-int</span><br><span class="line">        fail_mode: secure</span><br><span class="line">        Port <span class="string">&quot;vm3_nic&quot;</span></span><br><span class="line">            Interface <span class="string">&quot;vm3_nic&quot;</span></span><br><span class="line">                <span class="built_in">type</span>: internal</span><br><span class="line">        Port <span class="string">&quot;vm1_nic&quot;</span></span><br><span class="line">            Interface <span class="string">&quot;vm1_nic&quot;</span></span><br><span class="line">                <span class="built_in">type</span>: internal</span><br><span class="line">        Port <span class="string">&quot;ovn-74ad0b-0&quot;</span></span><br><span class="line">            Interface <span class="string">&quot;ovn-74ad0b-0&quot;</span></span><br><span class="line">                <span class="built_in">type</span>: geneve</span><br><span class="line">                options: &#123;csum=<span class="string">&quot;true&quot;</span>, key=flow, remote_ip=<span class="string">&quot;172.16.126.72&quot;</span>&#125;</span><br><span class="line">                bfd_status: &#123;diagnostic=<span class="string">&quot;Control Detection Time Expired&quot;</span>, flap_count=<span class="string">&quot;3&quot;</span>, forwarding=<span class="string">&quot;true&quot;</span>, remote_diagnostic=<span class="string">&quot;Control Detection Time Expired&quot;</span>, remote_state=up, state=up&#125;</span><br><span class="line">        Port br-int</span><br><span class="line">            Interface br-int</span><br><span class="line">                <span class="built_in">type</span>: internal</span><br><span class="line">    ovs_version: <span class="string">&quot;2.11.0&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#ovn-node2</span></span><br><span class="line"><span class="comment"># ovs-vsctl show</span></span><br><span class="line">35f58dbd-6b8b-45e3-8a5d-0567811ecb76</span><br><span class="line">    Bridge br-int</span><br><span class="line">        fail_mode: secure</span><br><span class="line">        Port <span class="string">&quot;vm4_nic&quot;</span></span><br><span class="line">            Interface <span class="string">&quot;vm4_nic&quot;</span></span><br><span class="line">                <span class="built_in">type</span>: internal</span><br><span class="line">        Port <span class="string">&quot;ovn-3d564c-0&quot;</span></span><br><span class="line">            Interface <span class="string">&quot;ovn-3d564c-0&quot;</span></span><br><span class="line">                <span class="built_in">type</span>: geneve</span><br><span class="line">                options: &#123;csum=<span class="string">&quot;true&quot;</span>, key=flow, remote_ip=<span class="string">&quot;172.16.126.71&quot;</span>&#125;</span><br><span class="line">                bfd_status: &#123;diagnostic=<span class="string">&quot;Control Detection Time Expired&quot;</span>, flap_count=<span class="string">&quot;3&quot;</span>, forwarding=<span class="string">&quot;true&quot;</span>, remote_diagnostic=<span class="string">&quot;Control Detection Time Expired&quot;</span>, remote_state=up, state=up&#125;</span><br><span class="line">        Port <span class="string">&quot;vm2_nic&quot;</span></span><br><span class="line">            Interface <span class="string">&quot;vm2_nic&quot;</span></span><br><span class="line">                <span class="built_in">type</span>: internal</span><br><span class="line">        Port br-int</span><br><span class="line">            Interface br-int</span><br><span class="line">                <span class="built_in">type</span>: internal</span><br><span class="line">    ovs_version: <span class="string">&quot;2.11.0&quot;</span></span><br></pre></td></tr></table></figure>

<h2 id="在网络节点设置映射"><a href="#在网络节点设置映射" class="headerlink" title="在网络节点设置映射"></a>在网络节点设置映射</h2><p>在设置逻辑路由器时，我们将node1和node2上设置了网络节点，现在在node1和node2上设置映射</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#node1 ovirt上此步骤是由VDSM生成的随机名称网桥</span></span><br><span class="line"><span class="comment">#ovs-vsctl add-br br-ex</span></span><br><span class="line"><span class="comment">#ovs-vsctl set Open_vSwitch . external-ids:ovn-bridge-mappings=dataNet:br-ex</span></span><br><span class="line"><span class="comment">#ovs-vsctl add-port br-ex eth0</span></span><br><span class="line"><span class="comment">#ovs-vsctl add-port br-ex dataNet -- set interface dataNet type=interface</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#node2 ovirt上此步骤是由VDSM生成的随机名称网桥</span></span><br><span class="line"><span class="comment">#ovs-vsctl add-br br-ex</span></span><br><span class="line"><span class="comment">#ovs-vsctl set Open_vSwitch . external-ids:ovn-bridge-mappings=dataNet:br-ex</span></span><br><span class="line"><span class="comment">#ovs-vsctl add-port br-ex eth0</span></span><br><span class="line"><span class="comment">#ovs-vsctl add-port br-ex dataNet -- set interface dataNet type=interface</span></span><br></pre></td></tr></table></figure>

<p>为dataNet设置IP地址并删除eth0上的IP地址</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#node1</span></span><br><span class="line"><span class="comment">#ip addr del 172.16.126.71/24 dev eth0</span></span><br><span class="line"><span class="comment">#ip addr add 172.16.126.71/24 dev dataNet</span></span><br><span class="line"><span class="comment">#ip link set dataNet up</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#node2</span></span><br><span class="line"><span class="comment">#ip addr del 172.16.126.72/24 dev eth0</span></span><br><span class="line"><span class="comment">#ip addr add 172.16.126.72/24 dev dataNet</span></span><br><span class="line"><span class="comment">#ip link set dataNet up</span></span><br></pre></td></tr></table></figure>

<p>如果是在ovirt的ovs集群上配置的虚拟机主机，可能会出现网络不通的故障，这是因为ovn默认开启了mac地址检查功能，需要将虚拟机主机的逻辑端口设置为unknown即可</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ovn-nbctl lsp-set-addresses 29263d0e-f4f7-4bd5-9e4e-4383eb7df3c8 unknown</span></span><br><span class="line"><span class="comment"># ovn-nbctl lsp-set-addresses 720ba611-5bc9-4bef-b56b-46ff1b42c270 unknown</span></span><br><span class="line"><span class="comment"># ovn-nbctl lsp-set-addresses 288debcb-dae0-41a7-aaeb-ba567c391ceb unknown</span></span><br></pre></td></tr></table></figure>

<p>如果网络还是不通，则检查ovs集群的网络是否配置了端口安全，如果配置了端口安全，则该端口可能被加入到了DropAll端口组，对包进行了丢弃。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ovn-nbctl list logical_switch_port 288debcb-dae0-41a7-aaeb-ba567c391ceb</span></span><br><span class="line">_uuid               : cf218523-5d0c-4bfa-ab39-7bf3d2b66995</span><br><span class="line">addresses           : [unknown]</span><br><span class="line">dhcpv4_options      : bed6def8-6333-475a-94a3-b65ad3ef4601</span><br><span class="line">dhcpv6_options      : []</span><br><span class="line">dynamic_addresses   : []</span><br><span class="line">enabled             : <span class="literal">true</span></span><br><span class="line">external_ids        : &#123;ovirt_device_id=<span class="string">&quot;942816d4-70e9-44aa-bf74-d7e4e7f55b48&quot;</span>, ovirt_device_owner=oVirt, ovirt_nic_name=<span class="string">&quot;nic1&quot;</span>, ovirt_security_groups=<span class="string">&quot;&quot;</span>&#125;</span><br><span class="line">ha_chassis_group    : []</span><br><span class="line">name                : <span class="string">&quot;288debcb-dae0-41a7-aaeb-ba567c391ceb&quot;</span></span><br><span class="line">options             : &#123;&#125;</span><br><span class="line">parent_name         : []</span><br><span class="line">port_security       : []<span class="comment">#查看是否启用了端口安全功能</span></span><br><span class="line">tag                 : []</span><br><span class="line">tag_request         : []</span><br><span class="line"><span class="built_in">type</span>                : <span class="string">&quot;&quot;</span></span><br><span class="line">up                  : <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<p>如果在ovirt上网络还是不通的话，请检查虚拟化平台的nwfilter设置，并删除该端口所对应的nwfilter-</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">virsh <span class="comment"># nwfilter-binding-list </span></span><br><span class="line"> Port Dev              Filter               </span><br><span class="line">------------------------------------------------------------------</span><br><span class="line"> vnet0                 vdsm-no-mac-spoofing</span><br><span class="line"> vnet2                 vdsm-no-mac-spoofing</span><br><span class="line"> vnet3                 vdsm-no-mac-spoofing</span><br><span class="line"> vnet4                 vdsm-no-mac-spoofing</span><br><span class="line"> vnet5                 vdsm-no-mac-spoofing</span><br><span class="line"> vnet6                 vdsm-no-mac-spoofing</span><br><span class="line"></span><br><span class="line">virsh <span class="comment"># nwfilter-binding-delete vnet2</span></span><br></pre></td></tr></table></figure>

<p>如果需要网络设置可持久化，需要将配置写入到如下文件中</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#node1 上</span></span><br><span class="line"><span class="comment">#vim /etc/rc.d/rc.local</span></span><br><span class="line">ip addr del 172.16.126.71/24 dev eth0</span><br><span class="line">ip addr add 172.16.126.71/24 dev dataNet</span><br><span class="line">ip link <span class="built_in">set</span> dataNet up</span><br><span class="line"></span><br><span class="line"><span class="comment">#node2 上</span></span><br><span class="line"><span class="comment">#vim /etc/rc.d/rc.local</span></span><br><span class="line">ip addr del 172.16.126.72/24 dev eth0</span><br><span class="line">ip addr add 172.16.126.72/24 dev dataNet</span><br><span class="line">ip link <span class="built_in">set</span> dataNet up</span><br><span class="line"></span><br><span class="line"><span class="comment">#设置权限</span></span><br><span class="line">[root@openstack ~]<span class="comment"># chmod u+x /etc/rc.d/rc.local</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#如果没有成功，请查看系统日志</span></span><br><span class="line">[root@openstack ~]<span class="comment">#cat /var/log/message | grep rc.local</span></span><br></pre></td></tr></table></figure>

<p>注意：rc.local 运行在操作系统完全引导成功、但尚未启动login shell之前。所以我们配置在 /etc/profiles 或 bashrc 里的环境变量并未得到执行、还未生效，因此，在 rc.local 执行阶段看不到任何环境变量。有些时候添加的自启动命令不生效，可能是该原因导致，如果在 rc.local 中添加的自启动命令对环境变量有依赖的话，可能会因为环境变量未生效而导致自启动失败。</p>
<p>解决办法：在 rc.local 中在执行启动命令之前加上 export 环境变量设置。或者启动命令做到避免依赖环境变量。</p>
<h2 id="设置NAT"><a href="#设置NAT" class="headerlink" title="设置NAT"></a>设置NAT</h2><p>增加snat，让内部网络可以访问外部网络</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#ovn-nbctl lr-nat-add routerA snat 172.16.126.74 192.168.1.0/24</span></span><br><span class="line"><span class="comment">#ovn-nbctl lr-nat-add routerA snat 172.16.126.74 192.168.2.0/24</span></span><br></pre></td></tr></table></figure>

<p>增加dnat，让外部网络可以访问内部服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#ovn-nbctl lr-nat-add routerA dnat_and_snat 172.16.126.75 192.168.1.20</span></span><br></pre></td></tr></table></figure>

<p>查看此时的北向数据库配置</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ovn-nbctl show</span></span><br><span class="line">switch 1d8ff1a1-91d5-46f5-9f9b-ce631353e102 (switchA)</span><br><span class="line">    port switchA_portA</span><br><span class="line">        addresses: [<span class="string">&quot;02:ac:10:ff:00:11 192.168.1.20&quot;</span>]</span><br><span class="line">    port switchA2routerA</span><br><span class="line">        <span class="built_in">type</span>: router</span><br><span class="line">        addresses: [<span class="string">&quot;02:ac:10:ff:01:88&quot;</span>]</span><br><span class="line">        router-port: routerA2switchA</span><br><span class="line">    port switchA_portB</span><br><span class="line">        addresses: [<span class="string">&quot;02:ac:10:ff:00:22 192.168.1.30&quot;</span>]</span><br><span class="line">switch 0acd0085-18ab-489e-85db-67f31173c17d (switchB)</span><br><span class="line">    port switchB_portB</span><br><span class="line">        addresses: [<span class="string">&quot;02:ac:10:ff:00:44 192.168.2.50&quot;</span>]</span><br><span class="line">    port switchB_portA</span><br><span class="line">        addresses: [<span class="string">&quot;02:ac:10:ff:00:33 192.168.2.40&quot;</span>]</span><br><span class="line">    port switchB2routerA</span><br><span class="line">        <span class="built_in">type</span>: router</span><br><span class="line">        addresses: [<span class="string">&quot;02:ac:10:ff:01:99&quot;</span>]</span><br><span class="line">        router-port: routerA2switchB</span><br><span class="line">switch 082b74b1-9d01-4989-914a-60ad66a3bdbf (switch_external)</span><br><span class="line">    port external2routerA</span><br><span class="line">        <span class="built_in">type</span>: router</span><br><span class="line">        addresses: [<span class="string">&quot;02:ac:10:ff:01:77&quot;</span>]</span><br><span class="line">        router-port: routerA2external</span><br><span class="line">    port external_port</span><br><span class="line">        <span class="built_in">type</span>: localnet</span><br><span class="line">        addresses: [<span class="string">&quot;unknown&quot;</span>]</span><br><span class="line">router bd119949-3cf7-4440-b79e-f861feb7d5a5 (routerA)</span><br><span class="line">    port routerA2external</span><br><span class="line">        mac: <span class="string">&quot;02:ac:10:ff:01:77&quot;</span></span><br><span class="line">        networks: [<span class="string">&quot;172.16.126.74/24&quot;</span>]</span><br><span class="line">        gateway chassis: [3d564c9f-d126-44a5-b604-0e165472e759 74ad0b26-6dde-4f0a-8244-c786e30ce953]</span><br><span class="line">    port routerA2switchB</span><br><span class="line">        mac: <span class="string">&quot;02:ac:10:ff:01:99&quot;</span></span><br><span class="line">        networks: [<span class="string">&quot;192.168.2.1/24&quot;</span>]</span><br><span class="line">    port routerA2switchA</span><br><span class="line">        mac: <span class="string">&quot;02:ac:10:ff:01:88&quot;</span></span><br><span class="line">        networks: [<span class="string">&quot;192.168.1.1/24&quot;</span>]</span><br><span class="line">    nat af870889-880d-418f-8cd4-8208d7935d9b</span><br><span class="line">        external ip: <span class="string">&quot;172.16.126.74&quot;</span></span><br><span class="line">        logical ip: <span class="string">&quot;192.168.1.0/24&quot;</span></span><br><span class="line">        <span class="built_in">type</span>: <span class="string">&quot;snat&quot;</span></span><br><span class="line">    nat b7af144a-1e0c-4ba0-b30e-672769e38339</span><br><span class="line">        external ip: <span class="string">&quot;172.16.126.74&quot;</span></span><br><span class="line">        logical ip: <span class="string">&quot;192.168.2.0/24&quot;</span></span><br><span class="line">        <span class="built_in">type</span>: <span class="string">&quot;snat&quot;</span></span><br><span class="line">    nat bf84a00a-94c0-4895-b4d2-d5053fe4675f</span><br><span class="line">        external ip: <span class="string">&quot;172.16.126.75&quot;</span></span><br><span class="line">        logical ip: <span class="string">&quot;192.168.1.20&quot;</span></span><br><span class="line">        <span class="built_in">type</span>: <span class="string">&quot;dnat_and_snat&quot;</span></span><br></pre></td></tr></table></figure>

<h2 id="测试NAT的连接性"><a href="#测试NAT的连接性" class="headerlink" title="测试NAT的连接性"></a>测试NAT的连接性</h2><p>从vm1中访问外部网络</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ip netns exec vm1 ping 172.16.126.221</span></span><br><span class="line">PING 172.16.126.221 (172.16.126.221) 56(84) bytes of data.</span><br><span class="line">64 bytes from 172.16.126.221: icmp_seq=1 ttl=63 time=1.09 ms</span><br><span class="line">64 bytes from 172.16.126.221: icmp_seq=2 ttl=63 time=0.236 ms</span><br><span class="line">^C</span><br><span class="line">--- 172.16.126.221 ping statistics ---</span><br></pre></td></tr></table></figure>

<p>在外部网络中访问vm2的服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ping 172.16.126.75</span></span><br><span class="line">PING 172.16.126.75 (172.16.126.75) 56(84) bytes of data.</span><br><span class="line">64 bytes from 172.16.126.75: icmp_seq=1 ttl=63 time=0.764 ms</span><br><span class="line">64 bytes from 172.16.126.75: icmp_seq=2 ttl=63 time=0.205 ms</span><br><span class="line">64 bytes from 172.16.126.75: icmp_seq=3 ttl=63 time=0.189 ms</span><br><span class="line">64 bytes from 172.16.126.75: icmp_seq=4 ttl=63 time=0.088 ms</span><br><span class="line">^C</span><br><span class="line">--- 172.16.126.75 ping statistics ---</span><br><span class="line">4 packets transmitted, 4 received, 0% packet loss, time 3000ms</span><br></pre></td></tr></table></figure>

<p>还有一个比较复杂的设置nat的方法，通过create方法来操作北向数据库，可以了解一下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#ovn-nbctl -- --id=@nat create nat type=&quot;snat&quot; logical_ip=192.168.1.0/24 external_ip=172.16.126.74 -- add logical_router logical_routerA nat @nat</span></span><br><span class="line"><span class="comment">#ovn-nbctl -- --id=@nat create nat type=&quot;snat&quot; logical_ip=192.168.2.0/24 external_ip=172.16.126.74 -- add logical_router logical_routerA nat @nat</span></span><br><span class="line"><span class="comment">#ovn-nbctl -- --id=@nat create nat type=&quot;dnat&quot; logical_ip=192.168.1.20 external_ip=172.16.126.75 -- add logical_router logical_routerA nat @nat</span></span><br></pre></td></tr></table></figure>

<h1 id="网络安全相关配置"><a href="#网络安全相关配置" class="headerlink" title="网络安全相关配置"></a>网络安全相关配置</h1><h2 id="端口组"><a href="#端口组" class="headerlink" title="端口组"></a>端口组</h2><h3 id="添加端口组"><a href="#添加端口组" class="headerlink" title="添加端口组"></a>添加端口组</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#ovn-nbctl pg-add pg_default</span></span><br></pre></td></tr></table></figure>

<h3 id="查看端口组"><a href="#查看端口组" class="headerlink" title="查看端口组"></a>查看端口组</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ovn-nbctl list port_group</span></span><br><span class="line">_uuid               : 452cad08-1afa-45ea-a199-18d3dab9c334</span><br><span class="line">acls                : []</span><br><span class="line">external_ids        : &#123;&#125;</span><br><span class="line">name                : pg_default</span><br><span class="line">ports               : []</span><br></pre></td></tr></table></figure>

<h3 id="添加端口到端口组"><a href="#添加端口到端口组" class="headerlink" title="添加端口到端口组"></a>添加端口到端口组</h3><p>仅能添加逻辑交换机端口，不能添加逻辑路由器端口</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#ovn-nbctl pg-set-ports pg_default switchA_portA switchA_portB switchB_portA switchB_portB</span></span><br><span class="line"><span class="comment">#ovn-nbctl list port_group</span></span><br><span class="line">_uuid               : 452cad08-1afa-45ea-a199-18d3dab9c334</span><br><span class="line">acls                : []</span><br><span class="line">external_ids        : &#123;&#125;</span><br><span class="line">name                : pg_default</span><br><span class="line">ports               : [616f220c-3f87-4c72-a8c4-617a4d0f42ad, 6b283ec9-e2a2-4013-bad3-0ec0a8fa20d5, aba2c95e-2ed6-4616-89d6-c52fdf49ba60, bbb3d86d-cd69-4279-a9e3-0bd7297f7db7]</span><br></pre></td></tr></table></figure>

<h3 id="从端口组删除端口"><a href="#从端口组删除端口" class="headerlink" title="从端口组删除端口"></a>从端口组删除端口</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ovn-nbctl remove port_group pg_default ports 616f220c-3f87-4c72-a8c4-617a4d0f42ad</span></span><br><span class="line"><span class="comment"># ovn-nbctl list port_group</span></span><br><span class="line">_uuid               : 452cad08-1afa-45ea-a199-18d3dab9c334</span><br><span class="line">acls                : []</span><br><span class="line">external_ids        : &#123;&#125;</span><br><span class="line">name                : pg_default</span><br><span class="line">ports               : [6b283ec9-e2a2-4013-bad3-0ec0a8fa20d5, aba2c95e-2ed6-4616-89d6-c52fdf49ba60, bbb3d86d-cd69-4279-a9e3-0bd7297f7db7]</span><br></pre></td></tr></table></figure>

<h3 id="往端口组增加单个端口"><a href="#往端口组增加单个端口" class="headerlink" title="往端口组增加单个端口"></a>往端口组增加单个端口</h3><p>只能通过uuid添加，不能通过名字添加</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ovn-nbctl add port_group pg_default ports 616f220c-3f87-4c72-a8c4-617a4d0f42ad</span></span><br><span class="line"><span class="comment"># ovn-nbctl list port_group</span></span><br><span class="line">_uuid               : 452cad08-1afa-45ea-a199-18d3dab9c334</span><br><span class="line">acls                : []</span><br><span class="line">external_ids        : &#123;&#125;</span><br><span class="line">name                : pg_default</span><br><span class="line">ports               : [616f220c-3f87-4c72-a8c4-617a4d0f42ad, 6b283ec9-e2a2-4013-bad3-0ec0a8fa20d5, aba2c95e-2ed6-4616-89d6-c52fdf49ba60, bbb3d86d-cd69-4279-a9e3-0bd7297f7db7]</span><br></pre></td></tr></table></figure>

<h3 id="删除端口组"><a href="#删除端口组" class="headerlink" title="删除端口组"></a>删除端口组</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#ovn-nbctl pg-del pg_default</span></span><br></pre></td></tr></table></figure>

<h2 id="定义ACL规则"><a href="#定义ACL规则" class="headerlink" title="定义ACL规则"></a>定义ACL规则</h2><h3 id="基本定义"><a href="#基本定义" class="headerlink" title="基本定义"></a>基本定义</h3><p>ACL规则,ACL规则的主体是逻辑交换机和端口组，一条ACL必须要有对应的主体，无法单独创建，不能对类型为localnet和router类型的端口应用ACL规则</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">priority:优先级，0-32767的整型，数字越大优先级越高</span><br><span class="line">direction：ACL规则应用的流向，from-lport（入站）对应端口inport，to-lport （出站）对应端口outport</span><br><span class="line">match:匹配规则，不允许在<span class="built_in">type</span>=router和<span class="built_in">type</span>=localnet的端口上匹配ACL，outport逻辑端口仅适用于to-lport路径，inport适用于to-lport和from-lport双向路径。</span><br><span class="line">action:动作，allow-related，它允许反向相关的流量（例如，响应，fragements等）通过，drop（丢包）,allow（允许包通过）,reject(丢包，并且回应一个带RST标识的TCP包)</span><br><span class="line">注：</span><br><span class="line">ip:所有IP包</span><br><span class="line">tcp：所有TCP报文，如tcp.dst=22就是ssh端口</span><br></pre></td></tr></table></figure>

<h3 id="增加ACL规则"><a href="#增加ACL规则" class="headerlink" title="增加ACL规则"></a>增加ACL规则</h3><p>对switchA应用安全策略，完全锁定switchA的switchA_portB端口，丢弃switchA交换机上switchA_portB端口的所有出站流量（从交换机方向出发是出站，从虚拟机方面出发是入站）</p>
<p>注意转义符的使用及单引号双引号的配合使用，最外层使用单引号，里层的虚拟端口必须使用双引号，ACL规则才能生效</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#应用ACL规则</span></span><br><span class="line"><span class="comment">#ovn-nbctl acl-add switchA to-lport 1000 &#x27;outport == &quot;switchA_portB&quot; &amp;&amp; ip4&#x27; drop</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#查看虚拟机流量，可以看到流量均被丢弃</span></span><br><span class="line"><span class="comment"># ip netns exec vm2 ping 192.168.2.50</span></span><br><span class="line">PING 192.168.2.50 (192.168.2.50) 56(84) bytes of data.</span><br><span class="line">^C</span><br><span class="line">--- 192.168.2.50 ping statistics ---</span><br><span class="line">175 packets transmitted, 0 received, 100% packet loss, time 175013ms</span><br></pre></td></tr></table></figure>

<h3 id="修改ACL规则"><a href="#修改ACL规则" class="headerlink" title="修改ACL规则"></a>修改ACL规则</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#首先查看ACL规则</span></span><br><span class="line"><span class="comment"># ovn-nbctl list acl</span></span><br><span class="line">_uuid               : 5efa45de-9f30-4993-beaa-ed5eb09e444a</span><br><span class="line">action              : drop</span><br><span class="line">direction           : to-lport</span><br><span class="line">external_ids        : &#123;&#125;</span><br><span class="line"><span class="built_in">log</span>                 : <span class="literal">false</span></span><br><span class="line">match               : <span class="string">&quot;outport == \&quot;switchA_portB\&quot; &amp;&amp; ip4&quot;</span></span><br><span class="line">meter               : []</span><br><span class="line">name                : []</span><br><span class="line">priority            : 1000</span><br><span class="line">severity            : []</span><br><span class="line"></span><br><span class="line"><span class="comment">#修改ACL规则</span></span><br><span class="line"><span class="comment"># ovn-nbctl set acl 5efa45de-9f30-4993-beaa-ed5eb09e444a match=&#x27;&quot;outport == \&quot;switchA_portA\&quot; &amp;&amp; ip4&quot;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#查看虚拟机流量</span></span><br><span class="line"><span class="comment"># ip netns exec vm2 ping 172.16.126.220</span></span><br><span class="line">PING 172.16.126.220 (172.16.126.220) 56(84) bytes of data.</span><br><span class="line">64 bytes from 172.16.126.220: icmp_seq=1 ttl=63 time=1.49 ms</span><br><span class="line">64 bytes from 172.16.126.220: icmp_seq=2 ttl=63 time=0.794 ms</span><br><span class="line">^C</span><br><span class="line">--- 172.16.126.220 ping statistics ---</span><br><span class="line">2 packets transmitted, 2 received, 0% packet loss, time 1043ms</span><br><span class="line"></span><br><span class="line"><span class="comment"># ip netns exec vm1 ping 172.16.126.220</span></span><br><span class="line">PING 172.16.126.220 (172.16.126.220) 56(84) bytes of data.</span><br><span class="line">^C</span><br><span class="line">--- 172.16.126.220 ping statistics ---</span><br><span class="line">3 packets transmitted, 0 received, 100% packet loss, time 2000ms</span><br></pre></td></tr></table></figure>

<h3 id="增加web访问ACL规则"><a href="#增加web访问ACL规则" class="headerlink" title="增加web访问ACL规则"></a>增加web访问ACL规则</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#首先在switchA的vm1上启动web服务</span></span><br><span class="line"><span class="comment"># rm /tmp/www -rf</span></span><br><span class="line"><span class="comment"># mkdir -p /tmp/www</span></span><br><span class="line"><span class="comment"># echo &quot;i am vm1&quot; &gt; /tmp/www/index.html</span></span><br><span class="line"><span class="comment"># cd /tmp/www</span></span><br><span class="line"><span class="comment"># ls</span></span><br><span class="line">index.html</span><br><span class="line"><span class="comment"># ip netns exec vm1 python -m SimpleHTTPServer 8000</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#验证其他vm可以访问这个web服务</span></span><br><span class="line"><span class="comment"># ip netns exec vm3 curl 192.168.1.20:8000</span></span><br><span class="line">i am vm1</span><br><span class="line"><span class="comment"># ip netns exec vm2 curl 192.168.1.20:8000</span></span><br><span class="line">i am vm1</span><br><span class="line"><span class="comment"># ip netns exec vm4 curl 192.168.1.20:8000</span></span><br><span class="line">i am vm1</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看web服务返回消息</span></span><br><span class="line"><span class="comment"># ip netns exec vm1 python -m SimpleHTTPServer 8000</span></span><br><span class="line">Serving HTTP on 0.0.0.0 port 8000 ...</span><br><span class="line">192.168.2.40 - - [19/Nov/2021 09:56:23] <span class="string">&quot;GET / HTTP/1.1&quot;</span> 200 -</span><br><span class="line">192.168.1.30 - - [19/Nov/2021 09:56:51] <span class="string">&quot;GET / HTTP/1.1&quot;</span> 200 -</span><br><span class="line">192.168.2.50 - - [19/Nov/2021 09:56:58] <span class="string">&quot;GET / HTTP/1.1&quot;</span> 200 -</span><br><span class="line"></span><br><span class="line"><span class="comment">#添加drop规则，使得访问web服务失败</span></span><br><span class="line"><span class="comment"># ovn-nbctl acl-add switchA to-lport 100 &#x27;outport == &quot;switchA_portA&quot; &amp;&amp; ip4&#x27; drop</span></span><br><span class="line"><span class="comment"># ovn-nbctl acl-add switchA from-lport 100 &#x27;inport == &quot;switchA_portA&quot; &amp;&amp; ip4&#x27; drop</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#此时其他虚拟机均无法访问vm1的web服务</span></span><br><span class="line"><span class="comment"># ip netns exec vm4 curl 192.168.1.20:8000</span></span><br><span class="line">^C</span><br><span class="line"><span class="comment"># ip netns exec vm2 curl 192.168.1.20:8000</span></span><br><span class="line">^C</span><br><span class="line"><span class="comment"># ip netns exec vm3 curl 192.168.1.20:8000</span></span><br><span class="line">^C</span><br><span class="line"></span><br><span class="line"><span class="comment">#添加allow规则，使得switchB上的虚拟机可以访问web，但是switchA上的依然无法访问</span></span><br><span class="line"><span class="comment"># ovn-nbctl acl-add switchA to-lport 1000 &#x27;outport == &quot;switchA_portA&quot; &amp;&amp; ip4.src == 192.168.2.0/24 &amp;&amp; tcp.dst == 8000&#x27; allow-related</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#此时测试web服务，发现switchA上的vm2依然无法访问web服务，但是switchB的vm3和vm4均可以访问web服务了</span></span><br><span class="line"><span class="comment"># ip netns exec vm2 curl 192.168.1.20:8000</span></span><br><span class="line">^C</span><br><span class="line"><span class="comment"># ip netns exec vm4 curl 192.168.1.20:8000</span></span><br><span class="line">i am vm1</span><br><span class="line"><span class="comment"># ip netns exec vm3 curl 192.168.1.20:8000</span></span><br><span class="line">i am vm1</span><br><span class="line"></span><br><span class="line"><span class="comment">#删除acl规则</span></span><br><span class="line"><span class="comment"># ovn-nbctl acl-del switchA</span></span><br></pre></td></tr></table></figure>

<h3 id="从逻辑交换机移除该ACL规则"><a href="#从逻辑交换机移除该ACL规则" class="headerlink" title="从逻辑交换机移除该ACL规则"></a>从逻辑交换机移除该ACL规则</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ovn-nbctl remove logical_switch 1d8ff1a1-91d5-46f5-9f9b-ce631353e102 acls 5efa45de-9f30-4993-beaa-ed5eb09e444a</span><br></pre></td></tr></table></figure>

<h3 id="彻底删除ACL规则"><a href="#彻底删除ACL规则" class="headerlink" title="彻底删除ACL规则"></a>彻底删除ACL规则</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#这条语句将把switch交换机下的ACL规则全部清空</span></span><br><span class="line"><span class="comment">#ovn-nbctl acl-del switchA</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#这条语句将删除某一条ACL语句，注意空格也要匹配到才能成功删除</span></span><br><span class="line"><span class="comment"># ovn-nbctl acl-del switchA to-lport 1000 &#x27;outport == &quot;switchA_portA&quot; &amp;&amp; ip4&#x27;</span></span><br></pre></td></tr></table></figure>

<h3 id="列出ACL规则"><a href="#列出ACL规则" class="headerlink" title="列出ACL规则"></a>列出ACL规则</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#列出虚拟交换机上的ACL规则，可以看出此时所有规则均被删除</span></span><br><span class="line"><span class="comment">#ovn-nbctl acl-list switchA</span></span><br></pre></td></tr></table></figure>

<h3 id="添加ACL规则到端口组"><a href="#添加ACL规则到端口组" class="headerlink" title="添加ACL规则到端口组"></a>添加ACL规则到端口组</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#ovn-nbctl acl-add pg_default to-lport 1000 &#x27;ip4 &amp;&amp; ip4.src == 172.16.126.0/24&#x27; drop</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#此时可以看到端口组的ACL规则</span></span><br><span class="line"><span class="comment"># ovn-nbctl acl-list pg_default</span></span><br><span class="line">  to-lport  1000 (ip4 &amp;&amp; ip4.src == 172.16.126.0/24) drop</span><br><span class="line"></span><br><span class="line"><span class="comment">#此时端口组下的所有虚拟机均无法访问172.16.126.0/24网段,而其他网段并不受影响</span></span><br><span class="line"><span class="comment"># ip netns exec vm1 ping 172.16.126.220</span></span><br><span class="line">PING 172.16.126.220 (172.16.126.220) 56(84) bytes of data.</span><br><span class="line">^C</span><br><span class="line">--- 172.16.126.220 ping statistics ---</span><br><span class="line">3 packets transmitted, 0 received, 100% packet loss, time 2000ms</span><br><span class="line"></span><br><span class="line"><span class="comment"># ip netns exec vm1 ping 192.168.1.30</span></span><br><span class="line">PING 192.168.1.30 (192.168.1.30) 56(84) bytes of data.</span><br><span class="line">64 bytes from 192.168.1.30: icmp_seq=1 ttl=64 time=1.73 ms</span><br><span class="line">64 bytes from 192.168.1.30: icmp_seq=2 ttl=64 time=0.587 ms</span><br><span class="line">^C</span><br><span class="line">--- 192.168.1.30 ping statistics ---</span><br><span class="line">2 packets transmitted, 2 received, 0% packet loss, time 1001ms</span><br><span class="line">rtt min/avg/max/mdev = 0.587/1.158/1.730/0.572 ms</span><br><span class="line"></span><br><span class="line"><span class="comment"># ip netns exec vm1 ping 192.168.2.40</span></span><br><span class="line">PING 192.168.2.40 (192.168.2.40) 56(84) bytes of data.</span><br><span class="line">64 bytes from 192.168.2.40: icmp_seq=1 ttl=63 time=0.424 ms</span><br><span class="line">64 bytes from 192.168.2.40: icmp_seq=2 ttl=63 time=0.080 ms</span><br><span class="line">^C</span><br><span class="line">--- 192.168.2.40 ping statistics ---</span><br><span class="line">2 packets transmitted, 2 received, 0% packet loss, time 999ms</span><br><span class="line">rtt min/avg/max/mdev = 0.080/0.252/0.424/0.172 ms</span><br></pre></td></tr></table></figure>

<h3 id="从端口组移除ACL规则"><a href="#从端口组移除ACL规则" class="headerlink" title="从端口组移除ACL规则"></a>从端口组移除ACL规则</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#仅从端口组移除ACL规则</span></span><br><span class="line"><span class="comment"># ovn-nbctl remove  port_group 452cad08-1afa-45ea-a199-18d3dab9c334 acls a97c8206-8cee-4de8-8c4e-0e54fb2448e3</span></span><br></pre></td></tr></table></figure>

<h3 id="彻底删除端口组ACL规则"><a href="#彻底删除端口组ACL规则" class="headerlink" title="彻底删除端口组ACL规则"></a>彻底删除端口组ACL规则</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#ovn-nbctl acl-del pg_default to-lport 1000 &#x27;ip4 &amp;&amp; ip4.src == 172.16.126.0/24&#x27;</span></span><br></pre></td></tr></table></figure>

<h3 id="直接摧毁ACL规则"><a href="#直接摧毁ACL规则" class="headerlink" title="直接摧毁ACL规则"></a>直接摧毁ACL规则</h3><p>直接从数据库中摧毁该ACL，注意如果当前ACL规则还挂载到虚拟交换机或者端口组，则无法摧毁</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ovn-nbctl destroy acl a97c8206-8cee-4de8-8c4e-0e54fb2448e3</span></span><br></pre></td></tr></table></figure>

<h1 id="服务质量（Qos）"><a href="#服务质量（Qos）" class="headerlink" title="服务质量（Qos）"></a>服务质量（Qos）</h1><p>Qos可以针对某个端口设置，也可以针对某个逻辑交换机设置，以下是服务质量的一些名词</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">priority：优先级，0-32767</span><br><span class="line">direction：流量流向，from-lport或者to-lport</span><br><span class="line">match：匹配语句，Qos适配规则要匹配的对象</span><br><span class="line">action：键值对，键必须是dscp，值在0-63之间，如果设置了，流表则应用了dscp标记</span><br><span class="line">bandwidth:键值对，键必须是brust或rate,值在1 - 4,294,967,295之间，rate的单位是kbps，brust单位kilobits</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">dscp:DSCP差分服务代码点（Differentiated Services Code Point），IETF于1998年12月发布了Diff-Serv（Differentiated Service）的QoS分类标准。它在每个数据包IP头部的服务类别TOS标识字节中，利用已使用的6比特和未使用的2比特，通过编码值来区分优先级.DSCP 使用6个bit，DSCP的值得范围为0~63。DSCP 是“IP 优先”和“服务类型”字段的组合。为了利用只支持“IP 优先”的旧路由器，会使用 DSCP 值，因为 DSCP 值与“IP 优先”字段兼容。用通俗一点的语言解释，其实DSCP就是为了保证通信的QoS，在数据包IP头部的8个标识字节进行编码，来划分服务类别，区分服务的优先级。其实DSCP就是用来保证IP层的优先级的，用于流量的区分。</span><br><span class="line">rate:带宽限制，单位kbps，千比特每秒</span><br><span class="line">burst:突发量，以kilobits（千比特，125字节）为单位</span><br></pre></td></tr></table></figure>

<h2 id="针对端口的Qos"><a href="#针对端口的Qos" class="headerlink" title="针对端口的Qos"></a>针对端口的Qos</h2><h3 id="添加端口Qos"><a href="#添加端口Qos" class="headerlink" title="添加端口Qos"></a>添加端口Qos</h3><blockquote>
<p>这个方案仅支持出方向和跨主机的Qos，QoS范围 1M &lt;- -&gt; 100M。</p>
</blockquote>
<p>qos_max_rate: </p>
<p>如果设置，表示从该接口发送数据的最大速率，以比特/秒（bit/s）为单位，流量将根据此限制进行调整。</p>
<p>qos_burst: </p>
<p>如果设置，则指示从此接口发送的数据的最大突发大小，以位（bit）为单位。</p>
<ul>
<li>OVN提供设置Port的QoS接口</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#添加端口switchA_portA的Qos,单位bit/s</span></span><br><span class="line"><span class="comment">#ovn-nbctl set logical_switch_port switchA_portA options:qos_max_rate=1000000</span></span><br><span class="line"><span class="comment">#ovn-nbctl set logical_switch_port switchA_portA options:qos_brust=1000000</span></span><br><span class="line"><span class="comment">#ovn-nbctl find logical_switch_port name=switchA_portA</span></span><br><span class="line">_uuid               : 616f220c-3f87-4c72-a8c4-617a4d0f42ad</span><br><span class="line">addresses           : [<span class="string">&quot;02:ac:10:ff:00:11 192.168.1.20&quot;</span>]</span><br><span class="line">dhcpv4_options      : 1e204723-aa55-405f-a9c5-8a36aaf40805</span><br><span class="line">dhcpv6_options      : []</span><br><span class="line">dynamic_addresses   : []</span><br><span class="line">enabled             : []</span><br><span class="line">external_ids        : &#123;&#125;</span><br><span class="line">ha_chassis_group    : []</span><br><span class="line">name                : switchA_portA</span><br><span class="line">options             : &#123;qos_brust=<span class="string">&quot;1000000&quot;</span>, qos_max_rate=<span class="string">&quot;1000000&quot;</span>&#125;</span><br><span class="line">parent_name         : []</span><br><span class="line">port_security       : [<span class="string">&quot;02:ac:10:ff:00:11&quot;</span>]</span><br><span class="line">tag                 : []</span><br><span class="line">tag_request         : []</span><br><span class="line"><span class="built_in">type</span>                : <span class="string">&quot;&quot;</span></span><br><span class="line">up                  : <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<ul>
<li>ovn-controller 处理local binding port时，本地维护local port的qos_map</li>
<li>基于overlay port的remote找到egress interface</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ovs-vsctl list interface &quot;ovn-74ad0b-0&quot;</span></span><br><span class="line">_uuid               : 0fe33a87-70f7-4df3-bfe9-cc042d914bb4</span><br><span class="line">admin_state         : up</span><br><span class="line">bfd                 : &#123;<span class="built_in">enable</span>=<span class="string">&quot;true&quot;</span>&#125;</span><br><span class="line">bfd_status          : &#123;diagnostic=<span class="string">&quot;No Diagnostic&quot;</span>, flap_count=<span class="string">&quot;1&quot;</span>, forwarding=<span class="string">&quot;true&quot;</span>, remote_diagnostic=<span class="string">&quot;No Diagnostic&quot;</span>, remote_state=up, state=up&#125;</span><br><span class="line">cfm_fault           : []</span><br><span class="line">cfm_fault_status    : []</span><br><span class="line">cfm_flap_count      : []</span><br><span class="line">cfm_health          : []</span><br><span class="line">cfm_mpid            : []</span><br><span class="line">cfm_remote_mpids    : []</span><br><span class="line">cfm_remote_opstate  : []</span><br><span class="line">duplex              : []</span><br><span class="line">error               : []</span><br><span class="line">external_ids        : &#123;&#125;</span><br><span class="line">ifindex             : 12</span><br><span class="line">ingress_policing_burst: 0</span><br><span class="line">ingress_policing_rate: 0</span><br><span class="line">lacp_current        : []</span><br><span class="line">link_resets         : 0</span><br><span class="line">link_speed          : []</span><br><span class="line">link_state          : up</span><br><span class="line">lldp                : &#123;&#125;</span><br><span class="line">mac                 : []</span><br><span class="line">mac_in_use          : <span class="string">&quot;06:31:46:b7:15:ff&quot;</span></span><br><span class="line">mtu                 : []</span><br><span class="line">mtu_request         : []</span><br><span class="line">name                : <span class="string">&quot;ovn-74ad0b-0&quot;</span></span><br><span class="line">ofport              : 9</span><br><span class="line">ofport_request      : []</span><br><span class="line">options             : &#123;csum=<span class="string">&quot;true&quot;</span>, key=flow, remote_ip=<span class="string">&quot;172.16.126.72&quot;</span>&#125;</span><br><span class="line">other_config        : &#123;&#125;</span><br><span class="line">statistics          : &#123;rx_bytes=1421868, rx_packets=21453, tx_bytes=62710399906, tx_packets=46918276&#125;</span><br><span class="line">status              : &#123;tunnel_egress_iface=dataNet, tunnel_egress_iface_carrier=up&#125;</span><br><span class="line"><span class="built_in">type</span>                : geneve</span><br></pre></td></tr></table></figure>

<ul>
<li>查看egress interface的 linux_htb规则，可以看出，没有创建规则</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># tc -d -s -p qdisc show dev dataNet</span></span><br><span class="line">qdisc noqueue 0: root refcnt 2</span><br><span class="line"> Sent 0 bytes 0 pkt (dropped 0, overlimits 0 requeues 0)</span><br><span class="line"> backlog 0b 0p requeues 0</span><br><span class="line"></span><br><span class="line"><span class="comment"># tc -d -s -p class show dev dataNet</span></span><br></pre></td></tr></table></figure>

<h3 id="测试端口qos"><a href="#测试端口qos" class="headerlink" title="测试端口qos"></a>测试端口qos</h3><p>测试时注意将端口加入到防火墙的端口例外</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ip netns exec vm2 iperf3 -s -i 10 -p 1100</span></span><br><span class="line">-----------------------------------------------------------</span><br><span class="line">Server listening on 1100</span><br><span class="line">-----------------------------------------------------------</span><br><span class="line">Accepted connection from 192.168.1.20, port 49898</span><br><span class="line">[  5] <span class="built_in">local</span> 192.168.1.30 port 1100 connected to 192.168.1.20 port 49900</span><br><span class="line">[ ID] Interval           Transfer     Bandwidth</span><br><span class="line">[  5]   0.00-10.01  sec  0.00 Bytes  0.00 bits/sec</span><br><span class="line">[  5]  10.01-20.01  sec  0.00 Bytes  0.00 bits/sec</span><br><span class="line">[  5]  20.01-30.00  sec  0.00 Bytes  0.00 bits/sec</span><br><span class="line">[  5]  30.00-30.03  sec  0.00 Bytes  0.00 bits/sec</span><br><span class="line">- - - - - - - - - - - - - - - - - - - - - - - - -</span><br><span class="line">[ ID] Interval           Transfer     Bandwidth</span><br><span class="line">[  5]   0.00-30.03  sec  0.00 Bytes  0.00 bits/sec                  sender</span><br><span class="line">[  5]   0.00-30.03  sec  0.00 Bytes  0.00 bits/sec                  receiver</span><br><span class="line">-----------------------------------------------------------</span><br><span class="line">Server listening on 1100</span><br><span class="line">-----------------------------------------------------------</span><br><span class="line"></span><br><span class="line"><span class="comment"># ip netns exec vm1 iperf3 -c 192.168.1.30 -i 3 -t 30 -p 1100</span></span><br><span class="line">Connecting to host 192.168.1.30, port 1100</span><br><span class="line">[  4] <span class="built_in">local</span> 192.168.1.20 port 49900 connected to 192.168.1.30 port 1100</span><br><span class="line">[ ID] Interval           Transfer     Bandwidth       Retr  Cwnd</span><br><span class="line">[  4]   0.00-3.00   sec  84.8 KBytes   231 Kbits/sec    3   1.41 KBytes</span><br><span class="line">[  4]   3.00-6.00   sec  0.00 Bytes  0.00 bits/sec    1   1.41 KBytes</span><br><span class="line">[  4]   6.00-9.00   sec  0.00 Bytes  0.00 bits/sec    1   1.41 KBytes</span><br><span class="line">[  4]   9.00-12.00  sec  0.00 Bytes  0.00 bits/sec    0   1.41 KBytes</span><br><span class="line">[  4]  12.00-15.00  sec  0.00 Bytes  0.00 bits/sec    1   1.41 KBytes</span><br><span class="line">[  4]  15.00-18.00  sec  0.00 Bytes  0.00 bits/sec    0   1.41 KBytes</span><br><span class="line">[  4]  18.00-21.00  sec  0.00 Bytes  0.00 bits/sec    0   1.41 KBytes</span><br><span class="line">[  4]  21.00-24.00  sec  0.00 Bytes  0.00 bits/sec    0   1.41 KBytes</span><br><span class="line">[  4]  24.00-27.00  sec  0.00 Bytes  0.00 bits/sec    1   1.41 KBytes</span><br><span class="line">[  4]  27.00-30.00  sec  0.00 Bytes  0.00 bits/sec    0   1.41 KBytes</span><br><span class="line">- - - - - - - - - - - - - - - - - - - - - - - - -</span><br><span class="line">[ ID] Interval           Transfer     Bandwidth       Retr</span><br><span class="line">[  4]   0.00-30.00  sec  84.8 KBytes  23.2 Kbits/sec    7             sender</span><br><span class="line">[  4]   0.00-30.00  sec  0.00 Bytes  0.00 bits/sec                  receiver</span><br><span class="line"></span><br><span class="line">iperf Done.</span><br></pre></td></tr></table></figure>

<p>测试结果，发送端的带宽为23.2 Kbits/sec，而我们设置的为1000000bit/sec，即1000Kbits/sec，这种速度远远没达到限速值，也谈不上实验成功，可能和使用命名空间有关，所以在生产环境测试一下。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#测试前的网络测试</span></span><br><span class="line">[root@ovn-node2 ~]<span class="comment"># iperf3 -s -i 10 -p 1100</span></span><br><span class="line">-----------------------------------------------------------</span><br><span class="line">Server listening on 1100</span><br><span class="line">-----------------------------------------------------------</span><br><span class="line">Accepted connection from 172.16.126.71, port 34432</span><br><span class="line">[  5] <span class="built_in">local</span> 172.16.126.72 port 1100 connected to 172.16.126.71 port 34434</span><br><span class="line">[ ID] Interval           Transfer     Bandwidth</span><br><span class="line">[  5]   0.00-10.00  sec  1.08 GBytes   931 Mbits/sec</span><br><span class="line">[  5]  10.00-20.00  sec  1.09 GBytes   938 Mbits/sec</span><br><span class="line">[  5]  20.00-30.00  sec  1.08 GBytes   925 Mbits/sec</span><br><span class="line">[  5]  30.00-40.00  sec  1.08 GBytes   930 Mbits/sec</span><br><span class="line">[  5]  40.00-50.00  sec  1.09 GBytes   939 Mbits/sec</span><br><span class="line">[  5]  50.00-60.00  sec  1.07 GBytes   916 Mbits/sec</span><br><span class="line">[  5]  60.00-70.00  sec  1.09 GBytes   933 Mbits/sec</span><br><span class="line">[  5]  70.00-80.00  sec  1.09 GBytes   939 Mbits/sec</span><br><span class="line">[  5]  80.00-90.00  sec  1.06 GBytes   914 Mbits/sec</span><br><span class="line">[  5]  90.00-100.00 sec  1.00 GBytes   861 Mbits/sec</span><br><span class="line">[  5] 100.00-100.06 sec  6.61 MBytes   933 Mbits/sec</span><br><span class="line">- - - - - - - - - - - - - - - - - - - - - - - - -</span><br><span class="line">[ ID] Interval           Transfer     Bandwidth</span><br><span class="line">[  5]   0.00-100.06 sec  0.00 Bytes  0.00 bits/sec                  sender</span><br><span class="line">[  5]   0.00-100.06 sec  10.7 GBytes   923 Mbits/sec                  receiver</span><br><span class="line">-----------------------------------------------------------</span><br><span class="line">Server listening on 1100</span><br><span class="line">-----------------------------------------------------------</span><br><span class="line"></span><br><span class="line">[root@ovn-node1 ~]<span class="comment"># iperf3 -c 172.16.126.72 -i 1 -t 100 -p 1100</span></span><br><span class="line">Connecting to host 172.16.126.72, port 1100</span><br><span class="line">[  4] <span class="built_in">local</span> 172.16.126.71 port 34434 connected to 172.16.126.72 port 1100</span><br><span class="line">[ ID] Interval           Transfer     Bandwidth       Retr  Cwnd</span><br><span class="line">[  4]   0.00-1.00   sec   109 MBytes   913 Mbits/sec   14    395 KBytes</span><br><span class="line">[  4]   1.00-2.00   sec   112 MBytes   940 Mbits/sec    0    567 KBytes</span><br><span class="line">[  4]   2.00-3.00   sec   112 MBytes   937 Mbits/sec    0    698 KBytes</span><br><span class="line">[  4]   3.00-4.00   sec   112 MBytes   942 Mbits/sec    0    809 KBytes</span><br><span class="line">[  4]   4.00-5.00   sec   112 MBytes   942 Mbits/sec    0    905 KBytes</span><br><span class="line">[  4]   5.00-6.00   sec   112 MBytes   937 Mbits/sec    0    992 KBytes</span><br><span class="line">[  4]   6.00-7.00   sec   113 MBytes   946 Mbits/sec    0   1.05 MBytes</span><br><span class="line">[  4]   7.00-8.00   sec   112 MBytes   939 Mbits/sec    7   1.12 MBytes</span><br><span class="line">[  4]   8.00-9.00   sec   112 MBytes   944 Mbits/sec    0   1.19 MBytes</span><br><span class="line">[  4]   9.00-10.00  sec   111 MBytes   933 Mbits/sec   18   1.25 MBytes</span><br><span class="line">[  4]  10.00-11.00  sec   111 MBytes   933 Mbits/sec    0   1.31 MBytes</span><br><span class="line">[  4]  11.00-12.00  sec   112 MBytes   944 Mbits/sec    0   1.37 MBytes</span><br><span class="line">- - - - - - - - - - - - - - - - - - - - - - - - -</span><br><span class="line">[ ID] Interval           Transfer     Bandwidth       Retr</span><br><span class="line">[  4]   0.00-100.00 sec  10.7 GBytes   923 Mbits/sec  15941             sender</span><br><span class="line">[  4]   0.00-100.00 sec  10.7 GBytes   923 Mbits/sec                  receiver</span><br><span class="line"></span><br><span class="line">iperf Done.</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#配置qos</span></span><br><span class="line">[root@engine220 ovirt-engine]<span class="comment"># ovn-nbctl set logical_switch_port 29263d0e-f4f7-4bd5-9e4e-4383eb7df3c8  options:qos_max_rate=1000000</span></span><br><span class="line">[root@engine220 ovirt-engine]<span class="comment"># ovn-nbctl set logical_switch_port 29263d0e-f4f7-4bd5-9e4e-4383eb7df3c8  options:qos_brust=1000000</span></span><br><span class="line">[root@engine220 ovirt-engine]<span class="comment"># ovn-nbctl list logical_switch_port 29263d0e-f4f7-4bd5-9e4e-4383eb7df3c8</span></span><br><span class="line">_uuid               : d4304e68-bd4f-4914-9804-a4ec5684c945</span><br><span class="line">addresses           : [unknown]</span><br><span class="line">dhcpv4_options      : bed6def8-6333-475a-94a3-b65ad3ef4601</span><br><span class="line">dhcpv6_options      : []</span><br><span class="line">dynamic_addresses   : []</span><br><span class="line">enabled             : <span class="literal">true</span></span><br><span class="line">external_ids        : &#123;ovirt_device_id=<span class="string">&quot;d6c4f295-b90c-4263-8fb0-80e1c764dd0f&quot;</span>, ovirt_device_owner=oVirt, ovirt_nic_name=<span class="string">&quot;nic1&quot;</span>, ovirt_security_groups=<span class="string">&quot;&quot;</span>&#125;</span><br><span class="line">ha_chassis_group    : []</span><br><span class="line">name                : <span class="string">&quot;29263d0e-f4f7-4bd5-9e4e-4383eb7df3c8&quot;</span></span><br><span class="line">options             : &#123;qos_brust=<span class="string">&quot;1000000&quot;</span>, qos_max_rate=<span class="string">&quot;1000000&quot;</span>&#125;</span><br><span class="line">parent_name         : []</span><br><span class="line">port_security       : []</span><br><span class="line">tag                 : []</span><br><span class="line">tag_request         : []</span><br><span class="line"><span class="built_in">type</span>                : <span class="string">&quot;&quot;</span></span><br><span class="line">up                  : <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#配置qos后的网络测试</span></span><br><span class="line">[root@ovn-node2 ~]<span class="comment"># iperf3 -s -i 10 -p 1100</span></span><br><span class="line">-----------------------------------------------------------</span><br><span class="line">Server listening on 1100</span><br><span class="line">-----------------------------------------------------------</span><br><span class="line">-----------------------------------------------------------</span><br><span class="line">Accepted connection from 172.16.126.71, port 34436</span><br><span class="line">[  5] <span class="built_in">local</span> 172.16.126.72 port 1100 connected to 172.16.126.71 port 34438</span><br><span class="line">[ ID] Interval           Transfer     Bandwidth</span><br><span class="line">[  5]   0.00-10.00  sec  1.08 GBytes   932 Mbits/sec</span><br><span class="line">[  5]  10.00-20.00  sec  1002 MBytes   841 Mbits/sec</span><br><span class="line">[  5]  20.00-30.00  sec  1.09 GBytes   939 Mbits/sec</span><br><span class="line">[  5]  30.00-40.00  sec  1.01 GBytes   867 Mbits/sec</span><br><span class="line">[  5]  40.00-50.00  sec  1.06 GBytes   911 Mbits/sec</span><br><span class="line">[  5]  50.00-60.00  sec  1.09 GBytes   939 Mbits/sec</span><br><span class="line">[  5]  60.00-70.00  sec  1.09 GBytes   934 Mbits/sec</span><br><span class="line">[  5]  70.00-80.00  sec  1.08 GBytes   929 Mbits/sec</span><br><span class="line">[  5]  80.00-90.00  sec  1015 MBytes   851 Mbits/sec</span><br><span class="line">[  5]  90.00-100.00 sec  1.09 GBytes   939 Mbits/sec</span><br><span class="line">[  5] 100.00-100.06 sec  6.28 MBytes   937 Mbits/sec</span><br><span class="line">- - - - - - - - - - - - - - - - - - - - - - - - -</span><br><span class="line">[ ID] Interval           Transfer     Bandwidth</span><br><span class="line">[  5]   0.00-100.06 sec  0.00 Bytes  0.00 bits/sec                  sender</span><br><span class="line">[  5]   0.00-100.06 sec  10.6 GBytes   908 Mbits/sec                  receiver</span><br><span class="line">-----------------------------------------------------------</span><br><span class="line">Server listening on 1100</span><br><span class="line">-----------------------------------------------------------</span><br><span class="line"></span><br><span class="line">[root@ovn-node1 ~]<span class="comment"># iperf3 -c 172.16.126.72 -i 1 -t 100 -p 1100</span></span><br><span class="line">Connecting to host 172.16.126.72, port 1100</span><br><span class="line">[  4] <span class="built_in">local</span> 172.16.126.71 port 34438 connected to 172.16.126.72 port 1100</span><br><span class="line">[ ID] Interval           Transfer     Bandwidth       Retr  Cwnd</span><br><span class="line">[  4]   0.00-1.00   sec   109 MBytes   914 Mbits/sec   28    309 KBytes</span><br><span class="line">[  4]   1.00-2.00   sec   112 MBytes   942 Mbits/sec    0    512 KBytes</span><br><span class="line">[  4]   2.00-3.00   sec   112 MBytes   938 Mbits/sec    0    654 KBytes</span><br><span class="line">[  4]   3.00-4.00   sec   112 MBytes   936 Mbits/sec   32    766 KBytes</span><br><span class="line">[  4]   4.00-5.00   sec   112 MBytes   941 Mbits/sec    0    867 KBytes</span><br><span class="line">[  4]   5.00-6.00   sec   112 MBytes   939 Mbits/sec    0    957 KBytes</span><br><span class="line">[  4]   6.00-7.00   sec   113 MBytes   947 Mbits/sec    0   1.02 MBytes</span><br><span class="line">[  4]   7.00-8.00   sec   112 MBytes   938 Mbits/sec    0   1.09 MBytes</span><br><span class="line">[  4]   8.00-9.00   sec   112 MBytes   941 Mbits/sec    0   1.16 MBytes</span><br><span class="line">[  4]   9.00-10.00  sec   112 MBytes   944 Mbits/sec    0   1.23 MBytes</span><br><span class="line">[  4]  10.00-11.00  sec   111 MBytes   933 Mbits/sec    0   1.29 MBytes</span><br><span class="line">[  4]  11.00-12.00  sec  90.0 MBytes   755 Mbits/sec  1029   2.43 MBytes</span><br><span class="line">[  4]  12.00-13.00  sec   111 MBytes   933 Mbits/sec    0   3.00 MBytes</span><br><span class="line">- - - - - - - - - - - - - - - - - - - - - - - - -</span><br><span class="line">[ ID] Interval           Transfer     Bandwidth       Retr</span><br><span class="line">[  4]   0.00-100.00 sec  10.6 GBytes   909 Mbits/sec  24967             sender</span><br><span class="line">[  4]   0.00-100.00 sec  10.6 GBytes   909 Mbits/sec                  receiver</span><br></pre></td></tr></table></figure>

<p>可以看出，Qos并没有起作用，针对端口的限速不成功。清除环境</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">[root@engine220 ovirt-engine]<span class="comment"># ovn-nbctl clear logical_switch_port 29263d0e-f4f7-4bd5-9e4e-4383eb7df3c8 options</span></span><br><span class="line">[root@engine220 ovirt-engine]<span class="comment"># ovn-nbctl list logical_switch_port 29263d0e-f4f7-4bd5-9e4e-4383eb7df3c8</span></span><br><span class="line">_uuid               : d4304e68-bd4f-4914-9804-a4ec5684c945</span><br><span class="line">addresses           : [unknown]</span><br><span class="line">dhcpv4_options      : bed6def8-6333-475a-94a3-b65ad3ef4601</span><br><span class="line">dhcpv6_options      : []</span><br><span class="line">dynamic_addresses   : []</span><br><span class="line">enabled             : <span class="literal">true</span></span><br><span class="line">external_ids        : &#123;ovirt_device_id=<span class="string">&quot;d6c4f295-b90c-4263-8fb0-80e1c764dd0f&quot;</span>, ovirt_device_owner=oVirt, ovirt_nic_name=<span class="string">&quot;nic1&quot;</span>, ovirt_security_groups=<span class="string">&quot;&quot;</span>&#125;</span><br><span class="line">ha_chassis_group    : []</span><br><span class="line">name                : <span class="string">&quot;29263d0e-f4f7-4bd5-9e4e-4383eb7df3c8&quot;</span></span><br><span class="line">options             : &#123;&#125;</span><br><span class="line">parent_name         : []</span><br><span class="line">port_security       : []</span><br><span class="line">tag                 : []</span><br><span class="line">tag_request         : []</span><br><span class="line"><span class="built_in">type</span>                : <span class="string">&quot;&quot;</span></span><br><span class="line">up                  : <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">[root@ovn-central ~]<span class="comment"># ovn-nbctl clear logical_switch_port switchA_portA options</span></span><br><span class="line">[root@ovn-central ~]<span class="comment"># ovn-nbctl list logical_switch_port switchA_portA</span></span><br><span class="line">_uuid               : 616f220c-3f87-4c72-a8c4-617a4d0f42ad</span><br><span class="line">addresses           : [<span class="string">&quot;02:ac:10:ff:00:11 192.168.1.20&quot;</span>]</span><br><span class="line">dhcpv4_options      : 1e204723-aa55-405f-a9c5-8a36aaf40805</span><br><span class="line">dhcpv6_options      : []</span><br><span class="line">dynamic_addresses   : []</span><br><span class="line">enabled             : []</span><br><span class="line">external_ids        : &#123;&#125;</span><br><span class="line">ha_chassis_group    : []</span><br><span class="line">name                : switchA_portA</span><br><span class="line">options             : &#123;&#125;</span><br><span class="line">parent_name         : []</span><br><span class="line">port_security       : [<span class="string">&quot;02:ac:10:ff:00:11&quot;</span>]</span><br><span class="line">tag                 : []</span><br><span class="line">tag_request         : []</span><br><span class="line"><span class="built_in">type</span>                : <span class="string">&quot;&quot;</span></span><br><span class="line">up                  : <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<h2 id="针对虚拟交换机的Qos"><a href="#针对虚拟交换机的Qos" class="headerlink" title="针对虚拟交换机的Qos"></a>针对虚拟交换机的Qos</h2><h3 id="添加Qos"><a href="#添加Qos" class="headerlink" title="添加Qos"></a>添加Qos</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ovn-nbctl qos-add switchA to-lport 900 dscp=55 rate=10 burst=5</span></span><br><span class="line"><span class="comment"># ovn-nbctl list qos</span></span><br><span class="line">_uuid               : 4eff7af0-4782-4c9b-8a79-211405579bb8</span><br><span class="line">action              : &#123;&#125;</span><br><span class="line">bandwidth           : &#123;burst=5, rate=10&#125;</span><br><span class="line">direction           : to-lport</span><br><span class="line">external_ids        : &#123;&#125;</span><br><span class="line">match               : <span class="string">&quot;dscp=55&quot;</span></span><br><span class="line">priority            : 900</span><br></pre></td></tr></table></figure>

<h3 id="测试qos"><a href="#测试qos" class="headerlink" title="测试qos"></a>测试qos</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ip netns exec vm1 iperf3 -s -i 10 -p 1100</span></span><br><span class="line">-----------------------------------------------------------</span><br><span class="line">Server listening on 1100</span><br><span class="line">-----------------------------------------------------------</span><br><span class="line">Accepted connection from 192.168.2.50, port 36730</span><br><span class="line">[  5] <span class="built_in">local</span> 192.168.1.20 port 1100 connected to 192.168.2.50 port 36732</span><br><span class="line">[ ID] Interval           Transfer     Bandwidth</span><br><span class="line">[  5]   0.00-10.01  sec  0.00 Bytes  0.00 bits/sec</span><br><span class="line">[  5]  10.01-20.01  sec  0.00 Bytes  0.00 bits/sec</span><br><span class="line">[  5]  20.01-30.01  sec  0.00 Bytes  0.00 bits/sec</span><br><span class="line">[  5]  30.01-30.04  sec  0.00 Bytes  0.00 bits/sec</span><br><span class="line">- - - - - - - - - - - - - - - - - - - - - - - - -</span><br><span class="line">[ ID] Interval           Transfer     Bandwidth</span><br><span class="line">[  5]   0.00-30.04  sec  0.00 Bytes  0.00 bits/sec                  sender</span><br><span class="line">[  5]   0.00-30.04  sec  0.00 Bytes  0.00 bits/sec                  receiver</span><br><span class="line">-----------------------------------------------------------</span><br><span class="line">Server listening on 1100</span><br><span class="line">-----------------------------------------------------------</span><br><span class="line"></span><br><span class="line"><span class="comment"># ip netns exec vm4 iperf3 -c 192.168.1.20 -i 3 -t 30 -p 1100</span></span><br><span class="line">Connecting to host 192.168.1.20, port 1100</span><br><span class="line">[  4] <span class="built_in">local</span> 192.168.2.50 port 36732 connected to 192.168.1.20 port 1100</span><br><span class="line">[ ID] Interval           Transfer     Bandwidth       Retr  Cwnd</span><br><span class="line">[  4]   0.00-3.00   sec  84.8 KBytes   231 Kbits/sec    3   1.41 KBytes</span><br><span class="line">[  4]   3.00-6.00   sec  0.00 Bytes  0.00 bits/sec    1   1.41 KBytes</span><br><span class="line">[  4]   6.00-9.00   sec  0.00 Bytes  0.00 bits/sec    1   1.41 KBytes</span><br><span class="line">[  4]   9.00-12.00  sec  0.00 Bytes  0.00 bits/sec    0   1.41 KBytes</span><br><span class="line">[  4]  12.00-15.00  sec  0.00 Bytes  0.00 bits/sec    1   1.41 KBytes</span><br><span class="line">[  4]  15.00-18.00  sec  0.00 Bytes  0.00 bits/sec    0   1.41 KBytes</span><br><span class="line">[  4]  18.00-21.00  sec  0.00 Bytes  0.00 bits/sec    0   1.41 KBytes</span><br><span class="line">[  4]  21.00-24.00  sec  0.00 Bytes  0.00 bits/sec    0   1.41 KBytes</span><br><span class="line">[  4]  24.00-27.00  sec  0.00 Bytes  0.00 bits/sec    1   1.41 KBytes</span><br><span class="line">[  4]  27.00-30.00  sec  0.00 Bytes  0.00 bits/sec    0   1.41 KBytes</span><br><span class="line">- - - - - - - - - - - - - - - - - - - - - - - - -</span><br><span class="line">[ ID] Interval           Transfer     Bandwidth       Retr</span><br><span class="line">[  4]   0.00-30.00  sec  84.8 KBytes  23.2 Kbits/sec    7             sender</span><br><span class="line">[  4]   0.00-30.00  sec  0.00 Bytes  0.00 bits/sec                  receiver</span><br><span class="line"></span><br><span class="line">iperf Done.</span><br></pre></td></tr></table></figure>

<p>测试完毕，qos还是没起作用！！！</p>
<h3 id="编辑Qos"><a href="#编辑Qos" class="headerlink" title="编辑Qos"></a>编辑Qos</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ovn-nbctl set qos 4eff7af0-4782-4c9b-8a79-211405579bb8 bandwidth:rate=20</span></span><br><span class="line"><span class="comment"># ovn-nbctl list qos</span></span><br><span class="line">_uuid               : 4eff7af0-4782-4c9b-8a79-211405579bb8</span><br><span class="line">action              : &#123;&#125;</span><br><span class="line">bandwidth           : &#123;burst=5, rate=20&#125;</span><br><span class="line">direction           : to-lport</span><br><span class="line">external_ids        : &#123;&#125;</span><br><span class="line">match               : <span class="string">&quot;dscp=55&quot;</span></span><br><span class="line">priority            : 900</span><br><span class="line"></span><br><span class="line"><span class="comment"># ovn-nbctl set qos 4eff7af0-4782-4c9b-8a79-211405579bb8 match=&#x27;dscp\=30&#x27;</span></span><br><span class="line"><span class="comment"># ovn-nbctl list qos</span></span><br><span class="line">_uuid               : 4eff7af0-4782-4c9b-8a79-211405579bb8</span><br><span class="line">action              : &#123;&#125;</span><br><span class="line">bandwidth           : &#123;burst=5, rate=20&#125;</span><br><span class="line">direction           : to-lport</span><br><span class="line">external_ids        : &#123;&#125;</span><br><span class="line">match               : <span class="string">&quot;dscp=30&quot;</span></span><br><span class="line">priority            : 900</span><br></pre></td></tr></table></figure>

<h3 id="删除Qos"><a href="#删除Qos" class="headerlink" title="删除Qos"></a>删除Qos</h3><p>删除整个逻辑交换机上的所有Qos</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#ovn-nbctl qos-del switchA</span></span><br></pre></td></tr></table></figure>

<p>删除逻辑交换机上的出站或者入站的Qos</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#ovn-nbctl qos-del logical_switchA to-lport</span></span><br></pre></td></tr></table></figure>

<p>根据match规则删除入站或者出站的某条Qos</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#ovn-nbctl qos-del switchA to-lport 900 dscp=30</span></span><br></pre></td></tr></table></figure>

<h3 id="列出Qos"><a href="#列出Qos" class="headerlink" title="列出Qos"></a>列出Qos</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#ovn-nbctl qos-list logical_switchA</span></span><br></pre></td></tr></table></figure>

<h1 id="地址集"><a href="#地址集" class="headerlink" title="地址集"></a>地址集</h1><h2 id="增加地址集"><a href="#增加地址集" class="headerlink" title="增加地址集"></a>增加地址集</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#将整个172.16.126.0网段加入到地址集</span></span><br><span class="line"><span class="comment">#ovn-nbctl create Address_Set name=external_ids addresses=&#x27;172.16.126.243/24&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ovn-nbctl list address_set</span></span><br><span class="line">_uuid               : 81d6cf52-9472-41eb-9ebc-c20107e018ed</span><br><span class="line">addresses           : [<span class="string">&quot;172.16.126.243/24&quot;</span>]</span><br><span class="line">external_ids        : &#123;&#125;</span><br><span class="line">name                : external_ids</span><br></pre></td></tr></table></figure>

<h2 id="编辑地址集"><a href="#编辑地址集" class="headerlink" title="编辑地址集"></a>编辑地址集</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#可以用mac地址作为地址集</span></span><br><span class="line"><span class="comment">#ovn-nbctl set Address_Set external_ids addresses=&#x27;&quot;02:ac:10:ff:00:33&quot;,&quot;02:ac:10:ff:00:44&quot;&#x27;</span></span><br><span class="line"><span class="comment"># ovn-nbctl list address_set</span></span><br><span class="line">_uuid               : 81d6cf52-9472-41eb-9ebc-c20107e018ed</span><br><span class="line">addresses           : [<span class="string">&quot;02:ac:10:ff:00:33&quot;</span>, <span class="string">&quot;02:ac:10:ff:00:44&quot;</span>]</span><br><span class="line">external_ids        : &#123;&#125;</span><br><span class="line">name                : external_ids</span><br><span class="line"></span><br><span class="line"><span class="comment">#将地址集地址换为两个单个的地址</span></span><br><span class="line"><span class="comment">#ovn-nbctl set Address_Set external_ids addresses=&#x27;172.16.126.244,172.16.126.245&#x27;</span></span><br><span class="line"><span class="comment"># ovn-nbctl list address_set</span></span><br><span class="line">_uuid               : 81d6cf52-9472-41eb-9ebc-c20107e018ed</span><br><span class="line">addresses           : [<span class="string">&quot;172.16.126.244&quot;</span>, <span class="string">&quot;172.16.126.245&quot;</span>]</span><br><span class="line">external_ids        : &#123;&#125;</span><br><span class="line">name                : external_ids</span><br></pre></td></tr></table></figure>

<h2 id="测试地址集"><a href="#测试地址集" class="headerlink" title="测试地址集"></a>测试地址集</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#将地址集加入到ACL中</span></span><br><span class="line"><span class="comment">#ovn-nbctl acl-add switchA to-lport 1000 &#x27;outport == &quot;switchA_portA&quot; &amp;&amp; ip4 &amp;&amp; ip4.src==$external_ids&#x27; drop</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ovn-nbctl list acl</span></span><br><span class="line">_uuid               : c61928f9-9d35-4755-9e55-380a16aa3d76</span><br><span class="line">action              : drop</span><br><span class="line">direction           : to-lport</span><br><span class="line">external_ids        : &#123;&#125;</span><br><span class="line"><span class="built_in">log</span>                 : <span class="literal">false</span></span><br><span class="line">match               : <span class="string">&quot;outport == \&quot;switchA_portA\&quot; &amp;&amp; ip4 &amp;&amp; ip4.src==<span class="variable">$external_ids</span>&quot;</span></span><br><span class="line">meter               : []</span><br><span class="line">name                : []</span><br><span class="line">priority            : 1000</span><br><span class="line">severity            : []</span><br><span class="line"></span><br><span class="line"><span class="comment">#此时在node1上进行测试，可以看出，acl已经应用到了地址集上</span></span><br><span class="line"><span class="comment"># ip netns exec vm1 ping 172.16.126.244</span></span><br><span class="line">PING 172.16.126.244 (172.16.126.244) 56(84) bytes of data.</span><br><span class="line">^C</span><br><span class="line">--- 172.16.126.244 ping statistics ---</span><br><span class="line">3 packets transmitted, 0 received, 100% packet loss, time 1999ms</span><br><span class="line"></span><br><span class="line"><span class="comment"># ip netns exec vm1 ping 172.16.126.245</span></span><br><span class="line">PING 172.16.126.245 (172.16.126.245) 56(84) bytes of data.</span><br><span class="line">^C</span><br><span class="line">--- 172.16.126.245 ping statistics ---</span><br><span class="line">3 packets transmitted, 0 received, 100% packet loss, time 1999ms</span><br><span class="line"></span><br><span class="line"><span class="comment">#测试地址集为mac地址的地址集时，反复测试均发现成功，待后续再研究</span></span><br></pre></td></tr></table></figure>

<h2 id="使用nmap创建端口监听测试地址集"><a href="#使用nmap创建端口监听测试地址集" class="headerlink" title="使用nmap创建端口监听测试地址集"></a>使用nmap创建端口监听测试地址集</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#在vm1上开启3306端口监听</span></span><br><span class="line"><span class="comment">#ip netns exec vm1 ncat -l -p 3306</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#在其他虚拟机上测试到vm1 3306端口的连接，可以用如下命令，但是这天命令在监听端不显示信息，故我们不用</span></span><br><span class="line"><span class="comment">#ip netns exec vm3 ncat -w 1 192.168.1.20 3306</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#用curl命令在其他虚拟机上测试到vm1 3306端口的连接</span></span><br><span class="line"><span class="comment"># ip netns exec vm2 curl 192.168.1.20:3306</span></span><br><span class="line">^C</span><br><span class="line"><span class="comment"># ip netns exec vm4 curl 192.168.1.20:3306</span></span><br><span class="line">^C</span><br><span class="line"><span class="comment"># ip netns exec vm3 curl 192.168.1.20:3306</span></span><br><span class="line">^C</span><br><span class="line"></span><br><span class="line"><span class="comment">#在vm1上可以看到,端口是通的</span></span><br><span class="line"><span class="comment"># ip netns exec vm1 ncat -l -p 3306</span></span><br><span class="line">GET / HTTP/1.1</span><br><span class="line">User-Agent: curl/7.29.0</span><br><span class="line">Host: 192.168.1.20:3306</span><br><span class="line">Accept: */*</span><br><span class="line"></span><br><span class="line"><span class="comment"># ip netns exec vm1 ncat -l -p 3306</span></span><br><span class="line">GET / HTTP/1.1</span><br><span class="line">User-Agent: curl/7.29.0</span><br><span class="line">Host: 192.168.1.20:3306</span><br><span class="line">Accept: */*</span><br><span class="line"></span><br><span class="line"><span class="comment"># ip netns exec vm1 ncat -l -p 3306</span></span><br><span class="line">GET / HTTP/1.1</span><br><span class="line">User-Agent: curl/7.29.0</span><br><span class="line">Host: 192.168.1.20:3306</span><br><span class="line">Accept: */*</span><br><span class="line"></span><br><span class="line"><span class="comment">#将地址集的IP地址改为192.168.1.30和192.168.2.50</span></span><br><span class="line"><span class="comment">#ovn-nbctl set Address_Set external_ids addresses=&#x27;192.168.1.30,192.168.2.50&#x27;</span></span><br><span class="line"><span class="comment"># ovn-nbctl list address_set</span></span><br><span class="line">_uuid               : d443b492-0ee0-4756-bda7-2391a55bd46e</span><br><span class="line">addresses           : [<span class="string">&quot;192.168.1.30&quot;</span>, <span class="string">&quot;192.168.2.50&quot;</span>]</span><br><span class="line">external_ids        : &#123;&#125;</span><br><span class="line">name                : external_ids</span><br><span class="line"></span><br><span class="line"><span class="comment">#创建ACL限制地址集内的IP地址访问VM1的3306端口</span></span><br><span class="line"><span class="comment">#ovn-nbctl acl-add switchA to-lport 1000 &#x27;outport == &quot;switchA_portA&quot; &amp;&amp; ip4.src == $external_ids &amp;&amp; tcp.dst == 3306&#x27; drop</span></span><br><span class="line"><span class="comment"># ovn-nbctl list acl</span></span><br><span class="line">_uuid               : 54774269-76fd-4e0d-93d8-a5f396965b36</span><br><span class="line">action              : drop</span><br><span class="line">direction           : to-lport</span><br><span class="line">external_ids        : &#123;&#125;</span><br><span class="line"><span class="built_in">log</span>                 : <span class="literal">false</span></span><br><span class="line">match               : <span class="string">&quot;outport == \&quot;switchA_portA\&quot; &amp;&amp; ip4.src == <span class="variable">$external_ids</span> &amp;&amp; tcp.dst == 3306&quot;</span></span><br><span class="line">meter               : []</span><br><span class="line">name                : []</span><br><span class="line">priority            : 1000</span><br><span class="line">severity            : []</span><br><span class="line"></span><br><span class="line"><span class="comment">#此时测试其他vm到vm1端口3306的访问</span></span><br><span class="line"><span class="comment"># ip netns exec vm1 ncat -l -p 3306</span></span><br><span class="line">GET / HTTP/1.1</span><br><span class="line">User-Agent: curl/7.29.0</span><br><span class="line">Host: 192.168.1.20:3306</span><br><span class="line">Accept: */*</span><br><span class="line"><span class="comment"># ip netns exec vm3 curl 192.168.1.20:3306</span></span><br><span class="line">^C</span><br><span class="line"></span><br><span class="line"><span class="comment"># ip netns exec vm2 ncat -w 1 192.168.1.20 3306</span></span><br><span class="line">Ncat: Connection timed out.</span><br><span class="line"><span class="comment"># ip netns exec vm4 ncat -w 1 192.168.1.20 3306</span></span><br><span class="line">Ncat: Connection timed out.</span><br><span class="line"></span><br><span class="line"><span class="comment">#可以看出地址集测试成功</span></span><br></pre></td></tr></table></figure>

<h2 id="查看地址集"><a href="#查看地址集" class="headerlink" title="查看地址集"></a>查看地址集</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ovn-nbctl list address_set</span></span><br><span class="line">_uuid               : 81d6cf52-9472-41eb-9ebc-c20107e018ed</span><br><span class="line">addresses           : [<span class="string">&quot;172.16.126.244&quot;</span>, <span class="string">&quot;172.16.126.245&quot;</span>]</span><br><span class="line">external_ids        : &#123;&#125;</span><br><span class="line">name                : external_ids</span><br><span class="line"></span><br><span class="line"><span class="comment"># ovn-nbctl find address_set name=external_ids</span></span><br><span class="line">_uuid               : 81d6cf52-9472-41eb-9ebc-c20107e018ed</span><br><span class="line">addresses           : [<span class="string">&quot;172.16.126.244&quot;</span>, <span class="string">&quot;172.16.126.245&quot;</span>]</span><br><span class="line">external_ids        : &#123;&#125;</span><br><span class="line">name                : external_ids</span><br></pre></td></tr></table></figure>

<h2 id="删除地址集"><a href="#删除地址集" class="headerlink" title="删除地址集"></a>删除地址集</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#ovn-nbctl destroy address_set external_ids</span></span><br></pre></td></tr></table></figure>

<h1 id="LB负载平衡"><a href="#LB负载平衡" class="headerlink" title="LB负载平衡"></a>LB负载平衡</h1><p>OVN负载均衡器旨在为OVN逻辑网络空间内的工作负载提供非常基本的负载均衡服务。由于其简单的功能集，它不是设计用于替换那些为高级用例提供更多花里胡哨的功能的硬件负载均衡器。</p>
<p>其它负载均衡器大多使用基于哈希的算法来平衡VIP的请求到逻辑空间内的相关IP地址池。由于哈希算法是使用客户端请求的头来计算的，所以平衡应当是随机性的，其中每个单独的客户端请求在连接的持续时间内始终选择同一个负载均衡池的特定成员。</p>
<p>OVN中的负载平衡可以应用于逻辑交换机或逻辑路由器。选择何种方式取决于您的具体要求。每种方法都有注意事项。</p>
<p>当应用于逻辑路由器时，需要牢记以下注意事项：</p>
<ul>
<li>负载平衡只能应用于“集中式”路由器（即网关路由器）。</li>
<li>第1个注意事项已经决定了路由器上的负载平衡是非分布式服务。</li>
</ul>
<p>应用于逻辑交换机时，需要牢记以下注意事项：</p>
<ul>
<li>负载平衡是“分布式”的，因为它被应用于潜在的多个OVS主机。</li>
<li>仅在来自VIF(虚拟接口)的流量入口处评估逻辑交换机上的负载平衡。这意味着它必须应用在“客户端”逻辑交换机上，而不是在“服务器”逻辑交换机上。</li>
<li>由于第2个注意事项，您可能需要根据您的设计规模对多个逻辑交换机应用负载平衡。</li>
</ul>
<h2 id="配置web访问"><a href="#配置web访问" class="headerlink" title="配置web访问"></a>配置web访问</h2><p>在node71和node72上配置vm1和vm2作为web服务器（两个虚拟机均是switchA逻辑网络下的虚拟机）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#mkdir /tmp/www</span></span><br><span class="line"><span class="comment">#echo &quot;i am vm1&quot; &gt; /tmp/www/index.html</span></span><br><span class="line"><span class="comment">#cd /tmp/www</span></span><br><span class="line"><span class="comment">#ip netns exec vm1 python -m SimpleHTTPServer 8000</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#mkdir /tmp/www</span></span><br><span class="line"><span class="comment">#echo &quot;i am vm2&quot; &gt; /tmp/www/index.html</span></span><br><span class="line"><span class="comment">#cd /tmp/www</span></span><br><span class="line"><span class="comment">#ip netns exec vm2 python -m SimpleHTTPServer 8000</span></span><br></pre></td></tr></table></figure>

<h2 id="配置逻辑路由器上的LB"><a href="#配置逻辑路由器上的LB" class="headerlink" title="配置逻辑路由器上的LB"></a>配置逻辑路由器上的LB</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#需要注意的是，172.16.126.211是external网络中一个未使用的IP地址，我们将其作为VIP</span></span><br><span class="line"><span class="comment"># ovn-nbctl lb-add lb2router 172.16.126.211:8000 &quot;192.168.1.20:8000,192.168.1.30:8000&quot;</span></span><br><span class="line"><span class="comment"># ovn-nbctl lr-lb-add routerA lb2router</span></span><br><span class="line"><span class="comment"># ovn-nbctl lb-list</span></span><br><span class="line">UUID                                    LB                  PROTO      VIP                    IPs</span><br><span class="line">44396c09-cd56-4609-bc66-135d73660764    lb2router           tcp        172.16.126.211:8000    192.168.1.20:8000,192.168.1.30:8000</span><br><span class="line"></span><br><span class="line"><span class="comment">#测试LB，本次测试在物理网络的测试客户端上进行测试。从测试结果可以看出，LB是配置成功的</span></span><br><span class="line"><span class="comment"># curl 172.16.126.211:8000</span></span><br><span class="line">i am vm2</span><br><span class="line"><span class="comment"># curl 172.16.126.211:8000</span></span><br><span class="line">i am vm2</span><br><span class="line"><span class="comment"># curl 172.16.126.211:8000</span></span><br><span class="line">i am vm2</span><br><span class="line"><span class="comment"># curl 172.16.126.211:8000</span></span><br><span class="line">i am vm1</span><br><span class="line"><span class="comment"># curl 172.16.126.211:8000</span></span><br><span class="line">i am vm1</span><br><span class="line"><span class="comment"># curl 172.16.126.211:8000</span></span><br><span class="line">i am vm1</span><br></pre></td></tr></table></figure>

<h2 id="配置逻辑交换机上的LB"><a href="#配置逻辑交换机上的LB" class="headerlink" title="配置逻辑交换机上的LB"></a>配置逻辑交换机上的LB</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#此处需要注意的是，逻辑交换机上配置LB，需要LB的VIP和逻辑交换机的网段不同，所以我们只能将LB配置到switchB上</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ovn-nbctl lb-add lb2switch 192.168.1.60:8000 &quot;192.168.1.20:8000,192.168.1.30:8000&quot;</span></span><br><span class="line"><span class="comment"># ovn-nbctl lb-list</span></span><br><span class="line">UUID                                    LB                  PROTO      VIP                    IPs</span><br><span class="line">44396c09-cd56-4609-bc66-135d73660764    lb2router           tcp        172.16.126.211:8000    192.168.1.20:8000,192.168.1.30:8000</span><br><span class="line">c31d23f1-53e4-4514-afb0-b1e40555e1d2    lb2switch           tcp        192.168.1.60:8000      192.168.1.20:8000,192.168.1.30:8000</span><br><span class="line"><span class="comment"># ovn-nbctl ls-lb-add switchB lb2switch</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#测试LB，本次测试在虚拟机客户端上进行，从测试结果可以看出，LB是配置成功的</span></span><br><span class="line"><span class="comment"># ip netns exec vm3 curl 192.168.1.60:8000</span></span><br><span class="line">i am vm1</span><br><span class="line"><span class="comment"># ip netns exec vm3 curl 192.168.1.60:8000</span></span><br><span class="line">i am vm2</span><br><span class="line"><span class="comment"># ip netns exec vm3 curl 192.168.1.60:8000</span></span><br><span class="line">i am vm2</span><br><span class="line"><span class="comment"># ip netns exec vm3 curl 192.168.1.60:8000</span></span><br><span class="line">i am vm1</span><br><span class="line"><span class="comment"># ip netns exec vm3 curl 192.168.1.60:8000</span></span><br><span class="line">i am vm1</span><br><span class="line">[<span class="comment"># ip netns exec vm3 curl 192.168.1.60:8000</span></span><br><span class="line">i am vm1</span><br><span class="line"></span><br><span class="line"><span class="comment">#如果在switchA的虚拟机客户端上进行，则无响应。这也就说明负载均衡应该设置到用户的logical switch而不是server的logical switch</span></span><br><span class="line"><span class="comment"># ip netns exec vm1 curl 192.168.1.60:8000</span></span><br><span class="line">^C</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="配置LB的健康检查"><a href="#配置LB的健康检查" class="headerlink" title="配置LB的健康检查"></a>配置LB的健康检查</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#目前还未配置健康检查，我们可以关闭一个web服务器，再次看LB的执行情况</span></span><br><span class="line"><span class="comment"># ip netns exec vm1 python -m SimpleHTTPServer 8000</span></span><br><span class="line">Serving HTTP on 0.0.0.0 port 8000 ...</span><br><span class="line">172.16.126.70 - - [19/Nov/2021 15:39:28] <span class="string">&quot;GET / HTTP/1.1&quot;</span> 200 -</span><br><span class="line">172.16.126.70 - - [19/Nov/2021 15:39:28] <span class="string">&quot;GET / HTTP/1.1&quot;</span> 200 -</span><br><span class="line">KeyboardInterrupt</span><br><span class="line"></span><br><span class="line"><span class="comment">#执行LB的测试，可以看出，如果未配置健康检查，则执行结果是有可能返回错误的</span></span><br><span class="line"><span class="comment"># ip netns exec vm3 curl 192.168.1.60:8000</span></span><br><span class="line">i am vm2</span><br><span class="line"><span class="comment"># ip netns exec vm3 curl 192.168.1.60:8000</span></span><br><span class="line">curl: (7) Failed connect to 192.168.1.60:8000; Connection refused</span><br><span class="line"><span class="comment"># ip netns exec vm3 curl 192.168.1.60:8000</span></span><br><span class="line">i am vm2</span><br><span class="line"><span class="comment"># ip netns exec vm3 curl 192.168.1.60:8000</span></span><br><span class="line">curl: (7) Failed connect to 192.168.1.60:8000; Connection refused</span><br><span class="line"></span><br><span class="line"><span class="comment">#配置LB的健康检查</span></span><br><span class="line"><span class="comment"># ovn-nbctl -- --id=@hc create load_balancer_health_check vip=&quot;192.168.1.60\:8000&quot; options:timeout=10 --  add load_balancer c31d23f1-53e4-4514-afb0-b1e40555e1d2 health_check @hc</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#可以看出来，lb2switch已经配置了健康检查</span></span><br><span class="line"><span class="comment"># ovn-nbctl list load_balancer</span></span><br><span class="line">_uuid               : c31d23f1-53e4-4514-afb0-b1e40555e1d2</span><br><span class="line">external_ids        : &#123;&#125;</span><br><span class="line">health_check        : [65dde008-e110-4d55-bc8a-010ab67bb7d4]</span><br><span class="line">ip_port_mappings    : &#123;&#125;</span><br><span class="line">name                : <span class="string">&quot;lb2switch&quot;</span></span><br><span class="line">protocol            : tcp</span><br><span class="line">vips                : &#123;<span class="string">&quot;192.168.1.60:8000&quot;</span>=<span class="string">&quot;192.168.1.20:8000,192.168.1.30:8000&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line">_uuid               : 44396c09-cd56-4609-bc66-135d73660764</span><br><span class="line">external_ids        : &#123;&#125;</span><br><span class="line">health_check        : []</span><br><span class="line">ip_port_mappings    : &#123;&#125;</span><br><span class="line">name                : <span class="string">&quot;lb2router&quot;</span></span><br><span class="line">protocol            : tcp</span><br><span class="line">vips                : &#123;<span class="string">&quot;172.16.126.211:8000&quot;</span>=<span class="string">&quot;192.168.1.20:8000,192.168.1.30:8000&quot;</span>&#125;</span><br></pre></td></tr></table></figure>

<h1 id="HA高可用"><a href="#HA高可用" class="headerlink" title="HA高可用"></a>HA高可用</h1><p>待更新</p>
<h1 id="静态路由"><a href="#静态路由" class="headerlink" title="静态路由"></a>静态路由</h1><h2 id="增加静态路由"><a href="#增加静态路由" class="headerlink" title="增加静态路由"></a>增加静态路由</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#ovn-nbctl lr-route-add logical_routerA &quot;192.168.1.0/24&quot; 182.168.1.1</span></span><br></pre></td></tr></table></figure>

<h2 id="删除静态路由"><a href="#删除静态路由" class="headerlink" title="删除静态路由"></a>删除静态路由</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#ovn-nbctl lr-route-del logical_routerA 192.168.1.0/24</span></span><br></pre></td></tr></table></figure>

<h2 id="列出静态路由"><a href="#列出静态路由" class="headerlink" title="列出静态路由"></a>列出静态路由</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#ovn-nbctl lr-route-list logical_routerA</span></span><br></pre></td></tr></table></figure>

    </div>

    
    
    
        

<div>
<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>Post author:  </strong>dangervon
  </li>
  <li class="post-copyright-link">
    <strong>Post link: </strong>
    <a href="http://dangervon.github.io/2021/11/19/Ovirt%E4%B8%8B%E7%9A%84OVN%E7%BB%84%E7%BD%91%E6%96%B9%E6%A1%88/" title="Ovirt下的OVN组网方案">http://dangervon.github.io/2021/11/19/Ovirt下的OVN组网方案/</a>
  </li>
  <li class="post-copyright-license">
    <strong>Copyright Notice:  </strong>All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> unless stating additionally.
  </li>
</ul>
</div>


      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/ovn/" rel="tag"># ovn</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2021/11/17/IP%E5%9C%B0%E5%9D%80%E8%AF%A6%E8%A7%A3/" rel="prev" title="IP地址详解">
      <i class="fa fa-chevron-left"></i> IP地址详解
    </a></div>
      <div class="post-nav-item"></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%95%B4%E4%BD%93%E6%9E%B6%E6%9E%84"><span class="nav-number">1.</span> <span class="nav-text">整体架构</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#ovirt-provider-ovn"><span class="nav-number">1.1.</span> <span class="nav-text">ovirt-provider-ovn</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ovsdb"><span class="nav-number">1.2.</span> <span class="nav-text">ovsdb</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Northbound-DB"><span class="nav-number">1.3.</span> <span class="nav-text">Northbound DB</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#OVN-Northd-Daemon"><span class="nav-number">1.4.</span> <span class="nav-text">OVN Northd Daemon</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Southbound-DB"><span class="nav-number">1.5.</span> <span class="nav-text">Southbound DB</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#OVN-Controller"><span class="nav-number">1.6.</span> <span class="nav-text">OVN Controller</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ovsdb-server%E5%92%8Covs-vswitched"><span class="nav-number">1.7.</span> <span class="nav-text">ovsdb-server和ovs-vswitched</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#OVN%E5%AE%89%E8%A3%85"><span class="nav-number">2.</span> <span class="nav-text">OVN安装</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%8E%AF%E5%A2%83%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="nav-number">2.1.</span> <span class="nav-text">环境初始化</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#OVN-CENTRAL%E4%B8%AD%E5%BF%83%E8%8A%82%E7%82%B9%E5%AE%89%E8%A3%85"><span class="nav-number">2.2.</span> <span class="nav-text">OVN CENTRAL中心节点安装</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%89%E8%A3%85ovn-central%E8%BD%AF%E4%BB%B6%E5%8C%85"><span class="nav-number">2.2.1.</span> <span class="nav-text">安装ovn-central软件包</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%80%89%E6%8B%A9%E5%85%B3%E9%97%AD%E9%98%B2%E7%81%AB%E5%A2%99%E5%8F%8Aselinux-%E5%92%8C%E9%85%8D%E7%BD%AE%E9%98%B2%E7%81%AB%E5%A2%99%E4%BA%8C%E9%80%89%E4%B8%80%E5%8D%B3%E5%8F%AF"><span class="nav-number">2.2.2.</span> <span class="nav-text">选择关闭防火墙及selinux(和配置防火墙二选一即可)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%80%89%E6%8B%A9%E9%85%8D%E7%BD%AE%E9%98%B2%E7%81%AB%E5%A2%99%E8%A7%84%E5%88%99"><span class="nav-number">2.2.3.</span> <span class="nav-text">选择配置防火墙规则</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BC%80%E5%A7%8B%E7%AB%AF%E5%8F%A3%E7%9B%91%E5%90%AC%E5%B9%B6%E5%90%AF%E5%8A%A8ovn-northd"><span class="nav-number">2.2.4.</span> <span class="nav-text">开始端口监听并启动ovn-northd</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%AE%BE%E7%BD%AE%E5%8D%97%E5%90%91%E5%92%8C%E5%8C%97%E5%90%91%E6%95%B0%E6%8D%AE%E5%BA%93%E8%BF%9E%E6%8E%A5"><span class="nav-number">2.2.5.</span> <span class="nav-text">设置南向和北向数据库连接</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#OVN-HOST%E8%AE%A1%E7%AE%97%E8%8A%82%E7%82%B9%E5%AE%89%E8%A3%85"><span class="nav-number">2.3.</span> <span class="nav-text">OVN HOST计算节点安装</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%89%E8%A3%85OVN-HOST%E8%AE%A1%E7%AE%97%E8%8A%82%E7%82%B9%E8%BD%AF%E4%BB%B6%E5%8C%85"><span class="nav-number">2.3.1.</span> <span class="nav-text">安装OVN HOST计算节点软件包</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%80%89%E6%8B%A9%E5%85%B3%E9%97%AD%E9%98%B2%E7%81%AB%E5%A2%99%E5%8F%8Aselinux"><span class="nav-number">2.3.2.</span> <span class="nav-text">选择关闭防火墙及selinux</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%80%89%E6%8B%A9%E9%85%8D%E7%BD%AE%E9%98%B2%E7%81%AB%E5%A2%99%E8%A7%84%E5%88%99-1"><span class="nav-number">2.3.3.</span> <span class="nav-text">选择配置防火墙规则</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BC%80%E5%A7%8B%E7%AB%AF%E5%8F%A3%E7%9B%91%E5%90%AC%E5%B9%B6%E5%90%AF%E5%8A%A8ovn-controller"><span class="nav-number">2.3.4.</span> <span class="nav-text">开始端口监听并启动ovn-controller</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B0%86%E6%8E%A7%E5%88%B6%E5%99%A8%E8%BF%9E%E6%8E%A5%E5%88%B0%E4%B8%AD%E5%BF%83%E8%8A%82%E7%82%B9%E5%B9%B6%E8%AE%BE%E7%BD%AE%E4%B8%BAgeneve%E7%BD%91%E7%BB%9C%EF%BC%88%E5%A6%82%E6%9E%9C%E9%9C%80%E8%A6%81%E6%8E%A5%E5%85%A5vtep%EF%BC%8C%E5%88%99%E9%9C%80%E8%A6%81%E5%B0%86%E7%BD%91%E7%BB%9C%E8%AE%BE%E7%BD%AE%E4%B8%BAgeneve%E5%92%8Cvxlan%E5%85%B1%E5%AD%98%EF%BC%89"><span class="nav-number">2.3.5.</span> <span class="nav-text">将控制器连接到中心节点并设置为geneve网络（如果需要接入vtep，则需要将网络设置为geneve和vxlan共存）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A6%82%E6%9E%9C%E6%B2%A1%E6%9C%89br-int%E7%BD%91%E6%A1%A5%E5%88%99%E5%88%9B%E5%BB%BA%E7%BD%91%E6%A1%A5%E5%B9%B6%E8%AE%BE%E7%BD%AE%E7%BD%91%E6%A1%A5%E7%9A%84%E6%8E%A5%E6%94%B6%E6%B5%81%E8%A1%A8%E6%96%B9%E5%BC%8F%E4%B8%BAsecure%EF%BC%88%E4%BB%85%E6%8E%A5%E6%94%B6%E6%8E%A7%E5%88%B6%E5%99%A8%E4%B8%8B%E5%8F%91%E6%B5%81%E8%A1%A8%EF%BC%89"><span class="nav-number">2.3.6.</span> <span class="nav-text">如果没有br-int网桥则创建网桥并设置网桥的接收流表方式为secure（仅接收控制器下发流表）</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%BD%91%E7%BB%9C%E6%8B%93%E6%89%91"><span class="nav-number">3.</span> <span class="nav-text">网络拓扑</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BA%8C%E5%B1%82%E7%BD%91%E7%BB%9C%E5%88%9B%E5%BB%BA"><span class="nav-number">4.</span> <span class="nav-text">二层网络创建</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E9%80%BB%E8%BE%91%E4%BA%A4%E6%8D%A2%E6%9C%BA"><span class="nav-number">4.1.</span> <span class="nav-text">创建逻辑交换机</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E8%99%9A%E6%8B%9F%E6%9C%BA%E5%B9%B6%E6%89%8B%E5%8A%A8%E8%AE%BE%E7%BD%AEIP%E5%9C%B0%E5%9D%80"><span class="nav-number">4.2.</span> <span class="nav-text">创建虚拟机并手动设置IP地址</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E5%B9%B6%E5%88%86%E9%85%8DDHCP%E9%80%89%E9%A1%B9%E7%BB%99%E7%AB%AF%E5%8F%A3"><span class="nav-number">4.3.</span> <span class="nav-text">创建并分配DHCP选项给端口</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%99%9A%E6%8B%9F%E6%9C%BADHCP%E4%BB%8EIP%E6%B1%A0%E4%B8%AD%E5%88%86%E9%85%8DIP%E5%9C%B0%E5%9D%80"><span class="nav-number">4.4.</span> <span class="nav-text">虚拟机DHCP从IP池中分配IP地址</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%99%9A%E6%8B%9F%E6%9C%BADHCP%E5%88%86%E9%85%8D%E5%9B%BA%E5%AE%9AIP%E5%9C%B0%E5%9D%80"><span class="nav-number">4.5.</span> <span class="nav-text">虚拟机DHCP分配固定IP地址</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%B7%9F%E8%B8%AADHCP%E8%AF%B7%E6%B1%82%E5%92%8C%E5%9B%9E%E5%BA%94"><span class="nav-number">4.6.</span> <span class="nav-text">跟踪DHCP请求和回应</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B8%89%E5%B1%82%E7%BD%91%E7%BB%9C%E5%88%9B%E5%BB%BA"><span class="nav-number">5.</span> <span class="nav-text">三层网络创建</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E9%80%BB%E8%BE%91%E8%B7%AF%E7%94%B1%E5%99%A8"><span class="nav-number">5.1.</span> <span class="nav-text">创建逻辑路由器</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E9%80%BB%E8%BE%91%E4%BA%A4%E6%8D%A2%E6%9C%BA%E4%B8%8A%E7%9A%84%E8%B7%AF%E7%94%B1%E7%AB%AF%E5%8F%A3"><span class="nav-number">5.2.</span> <span class="nav-text">创建逻辑交换机上的路由端口</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%99%9A%E6%8B%9F%E6%9C%BA%E4%BA%92%E9%80%9A%E6%B5%8B%E8%AF%95"><span class="nav-number">5.3.</span> <span class="nav-text">虚拟机互通测试</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E8%BF%9E%E6%8E%A5%E5%A4%96%E9%83%A8%E7%BD%91%E7%BB%9C"><span class="nav-number">6.</span> <span class="nav-text">连接外部网络</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E5%A4%96%E9%83%A8%E9%80%BB%E8%BE%91%E4%BA%A4%E6%8D%A2%E6%9C%BA"><span class="nav-number">6.1.</span> <span class="nav-text">创建外部逻辑交换机</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%AE%BE%E7%BD%AE%E9%80%BB%E8%BE%91%E8%B7%AF%E7%94%B1%E5%99%A8"><span class="nav-number">6.2.</span> <span class="nav-text">设置逻辑路由器</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9C%A8%E7%BD%91%E7%BB%9C%E8%8A%82%E7%82%B9%E8%AE%BE%E7%BD%AE%E6%98%A0%E5%B0%84"><span class="nav-number">6.3.</span> <span class="nav-text">在网络节点设置映射</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%AE%BE%E7%BD%AENAT"><span class="nav-number">6.4.</span> <span class="nav-text">设置NAT</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B5%8B%E8%AF%95NAT%E7%9A%84%E8%BF%9E%E6%8E%A5%E6%80%A7"><span class="nav-number">6.5.</span> <span class="nav-text">测试NAT的连接性</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E7%9B%B8%E5%85%B3%E9%85%8D%E7%BD%AE"><span class="nav-number">7.</span> <span class="nav-text">网络安全相关配置</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AB%AF%E5%8F%A3%E7%BB%84"><span class="nav-number">7.1.</span> <span class="nav-text">端口组</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B7%BB%E5%8A%A0%E7%AB%AF%E5%8F%A3%E7%BB%84"><span class="nav-number">7.1.1.</span> <span class="nav-text">添加端口组</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9F%A5%E7%9C%8B%E7%AB%AF%E5%8F%A3%E7%BB%84"><span class="nav-number">7.1.2.</span> <span class="nav-text">查看端口组</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B7%BB%E5%8A%A0%E7%AB%AF%E5%8F%A3%E5%88%B0%E7%AB%AF%E5%8F%A3%E7%BB%84"><span class="nav-number">7.1.3.</span> <span class="nav-text">添加端口到端口组</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%8E%E7%AB%AF%E5%8F%A3%E7%BB%84%E5%88%A0%E9%99%A4%E7%AB%AF%E5%8F%A3"><span class="nav-number">7.1.4.</span> <span class="nav-text">从端口组删除端口</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BE%80%E7%AB%AF%E5%8F%A3%E7%BB%84%E5%A2%9E%E5%8A%A0%E5%8D%95%E4%B8%AA%E7%AB%AF%E5%8F%A3"><span class="nav-number">7.1.5.</span> <span class="nav-text">往端口组增加单个端口</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%A0%E9%99%A4%E7%AB%AF%E5%8F%A3%E7%BB%84"><span class="nav-number">7.1.6.</span> <span class="nav-text">删除端口组</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%9A%E4%B9%89ACL%E8%A7%84%E5%88%99"><span class="nav-number">7.2.</span> <span class="nav-text">定义ACL规则</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9F%BA%E6%9C%AC%E5%AE%9A%E4%B9%89"><span class="nav-number">7.2.1.</span> <span class="nav-text">基本定义</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A2%9E%E5%8A%A0ACL%E8%A7%84%E5%88%99"><span class="nav-number">7.2.2.</span> <span class="nav-text">增加ACL规则</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BF%AE%E6%94%B9ACL%E8%A7%84%E5%88%99"><span class="nav-number">7.2.3.</span> <span class="nav-text">修改ACL规则</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A2%9E%E5%8A%A0web%E8%AE%BF%E9%97%AEACL%E8%A7%84%E5%88%99"><span class="nav-number">7.2.4.</span> <span class="nav-text">增加web访问ACL规则</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%8E%E9%80%BB%E8%BE%91%E4%BA%A4%E6%8D%A2%E6%9C%BA%E7%A7%BB%E9%99%A4%E8%AF%A5ACL%E8%A7%84%E5%88%99"><span class="nav-number">7.2.5.</span> <span class="nav-text">从逻辑交换机移除该ACL规则</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BD%BB%E5%BA%95%E5%88%A0%E9%99%A4ACL%E8%A7%84%E5%88%99"><span class="nav-number">7.2.6.</span> <span class="nav-text">彻底删除ACL规则</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%97%E5%87%BAACL%E8%A7%84%E5%88%99"><span class="nav-number">7.2.7.</span> <span class="nav-text">列出ACL规则</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B7%BB%E5%8A%A0ACL%E8%A7%84%E5%88%99%E5%88%B0%E7%AB%AF%E5%8F%A3%E7%BB%84"><span class="nav-number">7.2.8.</span> <span class="nav-text">添加ACL规则到端口组</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%8E%E7%AB%AF%E5%8F%A3%E7%BB%84%E7%A7%BB%E9%99%A4ACL%E8%A7%84%E5%88%99"><span class="nav-number">7.2.9.</span> <span class="nav-text">从端口组移除ACL规则</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BD%BB%E5%BA%95%E5%88%A0%E9%99%A4%E7%AB%AF%E5%8F%A3%E7%BB%84ACL%E8%A7%84%E5%88%99"><span class="nav-number">7.2.10.</span> <span class="nav-text">彻底删除端口组ACL规则</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9B%B4%E6%8E%A5%E6%91%A7%E6%AF%81ACL%E8%A7%84%E5%88%99"><span class="nav-number">7.2.11.</span> <span class="nav-text">直接摧毁ACL规则</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%9C%8D%E5%8A%A1%E8%B4%A8%E9%87%8F%EF%BC%88Qos%EF%BC%89"><span class="nav-number">8.</span> <span class="nav-text">服务质量（Qos）</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%92%88%E5%AF%B9%E7%AB%AF%E5%8F%A3%E7%9A%84Qos"><span class="nav-number">8.1.</span> <span class="nav-text">针对端口的Qos</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B7%BB%E5%8A%A0%E7%AB%AF%E5%8F%A3Qos"><span class="nav-number">8.1.1.</span> <span class="nav-text">添加端口Qos</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B5%8B%E8%AF%95%E7%AB%AF%E5%8F%A3qos"><span class="nav-number">8.1.2.</span> <span class="nav-text">测试端口qos</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%92%88%E5%AF%B9%E8%99%9A%E6%8B%9F%E4%BA%A4%E6%8D%A2%E6%9C%BA%E7%9A%84Qos"><span class="nav-number">8.2.</span> <span class="nav-text">针对虚拟交换机的Qos</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B7%BB%E5%8A%A0Qos"><span class="nav-number">8.2.1.</span> <span class="nav-text">添加Qos</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B5%8B%E8%AF%95qos"><span class="nav-number">8.2.2.</span> <span class="nav-text">测试qos</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BC%96%E8%BE%91Qos"><span class="nav-number">8.2.3.</span> <span class="nav-text">编辑Qos</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%A0%E9%99%A4Qos"><span class="nav-number">8.2.4.</span> <span class="nav-text">删除Qos</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%97%E5%87%BAQos"><span class="nav-number">8.2.5.</span> <span class="nav-text">列出Qos</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%9C%B0%E5%9D%80%E9%9B%86"><span class="nav-number">9.</span> <span class="nav-text">地址集</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A2%9E%E5%8A%A0%E5%9C%B0%E5%9D%80%E9%9B%86"><span class="nav-number">9.1.</span> <span class="nav-text">增加地址集</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BC%96%E8%BE%91%E5%9C%B0%E5%9D%80%E9%9B%86"><span class="nav-number">9.2.</span> <span class="nav-text">编辑地址集</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B5%8B%E8%AF%95%E5%9C%B0%E5%9D%80%E9%9B%86"><span class="nav-number">9.3.</span> <span class="nav-text">测试地址集</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8nmap%E5%88%9B%E5%BB%BA%E7%AB%AF%E5%8F%A3%E7%9B%91%E5%90%AC%E6%B5%8B%E8%AF%95%E5%9C%B0%E5%9D%80%E9%9B%86"><span class="nav-number">9.4.</span> <span class="nav-text">使用nmap创建端口监听测试地址集</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9F%A5%E7%9C%8B%E5%9C%B0%E5%9D%80%E9%9B%86"><span class="nav-number">9.5.</span> <span class="nav-text">查看地址集</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%A0%E9%99%A4%E5%9C%B0%E5%9D%80%E9%9B%86"><span class="nav-number">9.6.</span> <span class="nav-text">删除地址集</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#LB%E8%B4%9F%E8%BD%BD%E5%B9%B3%E8%A1%A1"><span class="nav-number">10.</span> <span class="nav-text">LB负载平衡</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%85%8D%E7%BD%AEweb%E8%AE%BF%E9%97%AE"><span class="nav-number">10.1.</span> <span class="nav-text">配置web访问</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE%E9%80%BB%E8%BE%91%E8%B7%AF%E7%94%B1%E5%99%A8%E4%B8%8A%E7%9A%84LB"><span class="nav-number">10.2.</span> <span class="nav-text">配置逻辑路由器上的LB</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE%E9%80%BB%E8%BE%91%E4%BA%A4%E6%8D%A2%E6%9C%BA%E4%B8%8A%E7%9A%84LB"><span class="nav-number">10.3.</span> <span class="nav-text">配置逻辑交换机上的LB</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%85%8D%E7%BD%AELB%E7%9A%84%E5%81%A5%E5%BA%B7%E6%A3%80%E6%9F%A5"><span class="nav-number">10.4.</span> <span class="nav-text">配置LB的健康检查</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#HA%E9%AB%98%E5%8F%AF%E7%94%A8"><span class="nav-number">11.</span> <span class="nav-text">HA高可用</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E9%9D%99%E6%80%81%E8%B7%AF%E7%94%B1"><span class="nav-number">12.</span> <span class="nav-text">静态路由</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A2%9E%E5%8A%A0%E9%9D%99%E6%80%81%E8%B7%AF%E7%94%B1"><span class="nav-number">12.1.</span> <span class="nav-text">增加静态路由</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%A0%E9%99%A4%E9%9D%99%E6%80%81%E8%B7%AF%E7%94%B1"><span class="nav-number">12.2.</span> <span class="nav-text">删除静态路由</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%97%E5%87%BA%E9%9D%99%E6%80%81%E8%B7%AF%E7%94%B1"><span class="nav-number">12.3.</span> <span class="nav-text">列出静态路由</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="dangervon"
      src="/images/header.png">
  <p class="site-author-name" itemprop="name">dangervon</p>
  <div class="site-description" itemprop="description">To be a Better man</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">4</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">3</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">3</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/dangervon" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;dangervon" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:cemicircle@gmail.com" title="E-Mail → mailto:cemicircle@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>
  <div class="cc-license motion-element" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2021 – 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">dangervon</span>
</div>

        








      </div>
    </footer>
  </div>

  
  <script src="/nextlib/anime.min.js"></script>
  <script src="/nextlib/velocity/velocity.min.js"></script>
  <script src="/nextlib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
