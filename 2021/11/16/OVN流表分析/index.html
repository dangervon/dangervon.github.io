<!DOCTYPE html>
<html lang="en-US">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.loli.net/css?family=Noto Serif SC:300,300italic,400,400italic,700,700italic|Lobster Two:300,300italic,400,400italic,700,700italic|EB Garamond:300,300italic,400,400italic,700,700italic|Source Code Pro:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="/nextlib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"dangervon.github.io","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="open virtual network下的逻辑流表及openflow流表分析方案">
<meta property="og:type" content="article">
<meta property="og:title" content="OVN流表分析">
<meta property="og:url" content="http://dangervon.github.io/2021/11/16/OVN%E6%B5%81%E8%A1%A8%E5%88%86%E6%9E%90/index.html">
<meta property="og:site_name" content="DangerZone">
<meta property="og:description" content="open virtual network下的逻辑流表及openflow流表分析方案">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2021-11-16T06:36:31.000Z">
<meta property="article:modified_time" content="2021-11-16T08:02:25.351Z">
<meta property="article:author" content="dangervon">
<meta property="article:tag" content="openflow">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://dangervon.github.io/2021/11/16/OVN%E6%B5%81%E8%A1%A8%E5%88%86%E6%9E%90/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'en-US'
  };
</script>

  <title>OVN流表分析 | DangerZone</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>
<a target="_blank" rel="noopener" href="https://github.com/dangervon" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">DangerZone</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">Linus Benedict Torvalds Once Said:Talk is Cheap,Show me the Code.That is true Correct!</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags<span class="badge">2</span></a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories<span class="badge">1</span></a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives<span class="badge">2</span></a>

  </li>
        <li class="menu-item menu-item-schedule">

    <a href="/schedule/" rel="section"><i class="fa fa-calendar fa-fw"></i>Schedule</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en-US">
    <link itemprop="mainEntityOfPage" href="http://dangervon.github.io/2021/11/16/OVN%E6%B5%81%E8%A1%A8%E5%88%86%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/header.png">
      <meta itemprop="name" content="dangervon">
      <meta itemprop="description" content="to be a better man">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="DangerZone">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          OVN流表分析
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2021-11-16 14:36:31 / Modified: 16:02:25" itemprop="dateCreated datePublished" datetime="2021-11-16T14:36:31+08:00">2021-11-16</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/openvswitch/" itemprop="url" rel="index"><span itemprop="name">openvswitch</span></a>
                </span>
            </span>

          
            <div class="post-description">open virtual network下的逻辑流表及openflow流表分析方案</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="流表概述"><a href="#流表概述" class="headerlink" title="流表概述"></a>流表概述</h1><h2 id="流表规则"><a href="#流表规则" class="headerlink" title="流表规则"></a>流表规则</h2><p>每条openflow流规则由一系列字段组成，分为基本字段、条件字段和动作字段三部分</p>
<h3 id="基本字段"><a href="#基本字段" class="headerlink" title="基本字段"></a>基本字段</h3><p>基本字段包括生效时间duration_sec、所属表项table_id、优先级priority、处理的数据包数n_packets，空闲超时时间idle_timeout等，空闲超时时间idle_timeout以秒为单位，超过设置的空闲超时时间后该流规则将被自动删除，空闲超时时间设置为0表示该流规则永不过期，idle_timeout将不包含于ovs-ofctl dump-flows brname的输出中。</p>
<table>
<thead>
<tr>
<th>字段</th>
<th>解析</th>
</tr>
</thead>
<tbody><tr>
<td>cookie=value</td>
<td>cookie字段有两种书写方式：cookie=value和cookie=value/mask。mask中对应位为1时cookie中值相应的位须严格匹配，为0时cookie中值对应的位通配，当mask为-1时，必须严格匹配cookie值。 在ovn中，如果cookie没有值时，表示不是直接从逻辑流表转换过来的</td>
</tr>
<tr>
<td>duration=value</td>
<td>流表生效时间，标识流表从下发到现在所持续的时间</td>
</tr>
<tr>
<td>table=tableid</td>
<td>流表所属表项，标识流表所属的表，默认为0</td>
</tr>
<tr>
<td>priority=priority</td>
<td>标识流表的优先级，范围为0-65535，值越大，优先级越高</td>
</tr>
<tr>
<td>n_packets</td>
<td>标识流表匹配包数</td>
</tr>
<tr>
<td>n_bytes</td>
<td>标识流表匹配字节数</td>
</tr>
<tr>
<td>idle_timeout=sec</td>
<td>流表空闲超时时间，流表会在空闲时间达到给定的时间时被删除。设置为0（默认值）时，流表不会因空闲时间被删除。</td>
</tr>
<tr>
<td>hard_timeout=sec</td>
<td>流表可存在的时间。设置此值后，流表会在到达给定时间后被删除。</td>
</tr>
<tr>
<td>idle_age=sec</td>
<td>流表空闲时间</td>
</tr>
<tr>
<td>hard_age=sec</td>
<td>流表存在时间。此字段与duration字段的区别在当流表被修改后，会重新设置hard_timer但是不会重置duration</td>
</tr>
</tbody></table>
<h3 id="条件字段"><a href="#条件字段" class="headerlink" title="条件字段"></a>条件字段</h3><p>条件字段包括输入端口号in_port、源目的mac地址dl_src/dl_dst、源目的ip地址nw_src/nw_dst、数据包类型dl_type、网络层协议类型nw_proto等，可以为这些字段的任意组合，但在网络分层结构中底层的字段未给出确定值时上层的字段不允许给确定值，即一条流规则中允许底层协议字段指定为确定值，高层协议字段指定为通配符(不指定即为匹配任何值)，而不允许高层协议字段指定为确定值，而底层协议字段却为通配符(不指定即为匹配任何值)，否则，ovs-vswitchd 中的流规则将全部丢失，网络无法连接。</p>
<table>
<thead>
<tr>
<th>字段</th>
<th>解析</th>
</tr>
</thead>
<tbody><tr>
<td>in_port=port</td>
<td>标识匹配接收数据包的端口号</td>
</tr>
<tr>
<td>dl_vlan_pcp=priority</td>
<td>匹配IEEE 802.1q优先码点(PCP)优先级，该优先级指定为0到7之间的值，包括0和7。更高的值表示更高的帧优先级。</td>
</tr>
<tr>
<td>dl_type=ethertype</td>
<td>匹配以太网协议类型ethertype，该类型指定为0到65535之间的整数，匹配数据包的二层协议类型，IP数据包为0x0800，IPv6数据包为0x86dd，ARP数据包为0x0806</td>
</tr>
<tr>
<td>dl_src=xx:xx:xx:xx:xx:xx<br/>dl_dst=xx:xx:xx:xx:xx:xx</td>
<td>匹配指定的链路层源或者目的MAC地址</td>
</tr>
<tr>
<td>dl_src=xx:xx:xx:xx:xx:xx<br/>/xx:xx:xx:xx:xx:xx<br/>dl_dst=xx:xx:xx:xx:xx:xx<br/>/xx:xx:xx:xx:xx:xx</td>
<td>匹配指定的链路层MAC地址，MAC地址格式为ADDR/MASK，当MASK值为01:00:00:00:00:00时，仅匹配多播位。当dl_dst=01:00:00:00:00:00/01:00:00:00:00:00时，匹配所有的组播报文和广播报文。dl_dst=00:00:00:00:00:00/01:00:00:00:00:00匹配所有的单播报文。</td>
</tr>
<tr>
<td>nw_src=ip[/mask]<br/>nw_dst=ip[/mask]</td>
<td>当dl_type=0x0800或指定ip时，匹配数据包的源、目的IP地址 当dl_type=0x0806或指定arp时，匹配ARP数据包的ar_spa或者ar_tpa字段</td>
</tr>
<tr>
<td>dl_vlan=vlan</td>
<td>匹配802.1Q类型（即vlan）数据包</td>
</tr>
<tr>
<td>vlan_tci=tci[/mask]</td>
<td>匹配修改后的VLAN TCI TCI。如果省略掩码，则tci就是要匹配的VLAN tci;如果指定了掩码，那么掩码中的1位表示tci中的对应位必须完全匹配，0位的通配符表示该位。</td>
</tr>
<tr>
<td>nw_proto=proto</td>
<td>匹配数据包协议类型。当dl_type=0x0800时，匹配IP协议族的协议，例如tcp，udp，icmp等<br/>当指定ip或dl_type=0x0800时，匹配ip协议类型proto, proto指定为0到255之间的十进制数(例如1匹配ICMP包或6匹配TCP包)。<br/>当指定ipv6或dl_type=0x86dd时，匹配ipv6报头类型proto，它被指定为0到255之间的十进制数(例如58匹配ICMPv6包或6匹配TCP)。<br/>当指定arp或dl_type=0x0806时，匹配arp操作码的较低8位。<br/>当指定rarp或dl_type=0x8035时，匹配ARP操作码的较低8位。</td>
</tr>
<tr>
<td>nw_tos=tos</td>
<td>匹配IP Tos/DSCP或者IPv6的tos字段，值为0-255</td>
</tr>
<tr>
<td>nw_ecn=ecn</td>
<td>匹配IP ToS或IPv6流量类字段中的ecn位，该字段指定为0到3之间的十进制数(包括3)。</td>
</tr>
<tr>
<td>nw_ttl=ttl</td>
<td>匹配IP TTL或IPv6跳限值TTL, TTL指定为0到255之间的小数，包括在内。</td>
</tr>
<tr>
<td>tp_src=port<br/>tp_dst=port</td>
<td>若指定了udp或者tcp协议，则匹配udp/tcp的端口号</td>
</tr>
<tr>
<td>icmp_type=type<br/>icmp_code=code</td>
<td>若指定了icmp或者icmpv6协议，则匹配对应的icmp 类型或者code字段</td>
</tr>
<tr>
<td>table=number</td>
<td>如果指定，则限制流操作和流转储命令仅应用于给定数字在0到254之间的表。</td>
</tr>
<tr>
<td>ip_frag=frag_type</td>
<td>当dl_type指定为IP或者IPv6，frag_type指定匹配的IP分片包或者非分片包的匹配 frag_type支持的值为：<br/>no: 仅匹配非分片报文<br/>yes：匹配所有分片报文<br/>first：仅匹配offset为0的分片报文<br/>later：仅匹配offset非0的分片报文<br/>not_later：匹配非分片报文和offset为0的分片报文</td>
</tr>
<tr>
<td>arp_sha=xx:xx:xx:xx:xx:xx<br/>arp_tha=xx:xx:xx:xx:xx:xx</td>
<td>当设置dl_type为ARP或者RARP，则arp_sha和arp_tha匹配数据包的源、目的MAC地址</td>
</tr>
<tr>
<td>tun_id=tunnel-id[/mask]</td>
<td>匹配隧道标识符–隧道id。只有通过带有密钥的隧道到达的数据包(例如带有RFC 2890密钥扩展名和非零密钥值的GRE)才具有非零的隧道ID。</td>
</tr>
</tbody></table>
<p>以下是一些匹配项的速记符</p>
<table>
<thead>
<tr>
<th>速记符</th>
<th>匹配项</th>
</tr>
</thead>
<tbody><tr>
<td>ip</td>
<td>dl_type=0x800</td>
</tr>
<tr>
<td>ipv6</td>
<td>dl_type=0x86dd</td>
</tr>
<tr>
<td>icmp</td>
<td>dl_type=0x0800,nw_proto=1</td>
</tr>
<tr>
<td>mplsm</td>
<td>dl_type=0x8848</td>
</tr>
<tr>
<td>mpls</td>
<td>dl_type=0x8847</td>
</tr>
<tr>
<td>rarp</td>
<td>dl_type=0x8035</td>
</tr>
<tr>
<td>arp</td>
<td>dl_type=0x0806</td>
</tr>
<tr>
<td>sctp6</td>
<td>dl_type=0x86dd,nw_proto=132</td>
</tr>
<tr>
<td>sctp</td>
<td>dl_type=0x0800,nw_proto=132</td>
</tr>
<tr>
<td>udp6</td>
<td>dl_type=0x86dd,nw_proto=17</td>
</tr>
<tr>
<td>udp</td>
<td>dl_type=0x0800,nw_proto=17</td>
</tr>
<tr>
<td>tcp6</td>
<td>dl_type=0x86dd,nw_proto=6</td>
</tr>
<tr>
<td>tcp</td>
<td>dl_type=0x0800,nw_proto=6</td>
</tr>
<tr>
<td>icmp6</td>
<td>dl_type=0x86dd,nw_proto=58</td>
</tr>
</tbody></table>
<h3 id="动作字段"><a href="#动作字段" class="headerlink" title="动作字段"></a>动作字段</h3><p>动作字段包括正常转发normal、定向到某交换机端口output：port、丢弃drop、更改源目的mac地址mod_dl_src/mod_dl_dst等，一条流规则可有多个动作，动作执行按指定的先后顺序依次完成。</p>
<table>
<thead>
<tr>
<th>字段</th>
<th>解析</th>
</tr>
</thead>
<tbody><tr>
<td>output:port</td>
<td>将数据包从port接口发送</td>
</tr>
<tr>
<td>output:src[start..end]</td>
<td>将包输出到从src读取的OpenFlow端口号,该src是NXM字段所包含数据。例如：output:NXM_NX_REG0[16..31],表示输出端口号是从NXM_NX_REG0寄存器的16-31为中读取的数据</td>
</tr>
<tr>
<td>enqueue:port:queue</td>
<td>将数据包入队到指定端口的指定队列里</td>
</tr>
<tr>
<td>normal</td>
<td>将数据包按照设备上的正常L2/L3层处理方式进行处理</td>
</tr>
<tr>
<td>flood</td>
<td>将数据包发送到交换机上除接收接口和禁止flood的接口外的所有接口</td>
</tr>
<tr>
<td>all</td>
<td>将数据包发送到除接收接口外的所有接口</td>
</tr>
<tr>
<td>controller(key=value…)</td>
<td>将数据包作为PACKET IN消息发送到OpenFlow控制器。<br/>支持的键值对：<br/>max_len=nbytes：限制发送到控制器的数据包长度字节数，默认情况是发送整个数据包；<br/>reason=reason：在PACKET IN消息中指明发送消息的原因，支持的reason为action(default)，no_match和invalid_ttl;<br/>id=controller-id：指明控制器ID</td>
</tr>
<tr>
<td>in_port</td>
<td>将数据包从接收的接口发送出去</td>
</tr>
<tr>
<td>drop</td>
<td>丢弃数据包</td>
</tr>
<tr>
<td>mod_vlan_vid:vlan_vid</td>
<td>修改数据包的vlan id</td>
</tr>
<tr>
<td>mod_vlan_pcp:vlan_pcp</td>
<td>vlan_pcp 修改数据包的vlan priority</td>
</tr>
<tr>
<td>strip_vlan</td>
<td>如果数据包中存在vlan tag，则剥离vlan tag</td>
</tr>
<tr>
<td>push_vlan:ethertype</td>
<td>为数据包添加新的vlan tag</td>
</tr>
<tr>
<td>push_mpls:ethertype</td>
<td>如果包还没有包含任何MPLS标签，则将包的Ethertype更改为Ethertype，它必须是MPLS单播Ethertype 0x8847或MPLS多播Ethertype 0x8848，然后推送一个初始标签堆栈条目。</td>
</tr>
<tr>
<td>pop_mpls:ethertype</td>
<td>去掉最外层的MPLS标签堆栈条目</td>
</tr>
<tr>
<td>mod_dl_src:mac</td>
<td>设置数据包的源MAC地址</td>
</tr>
<tr>
<td>mod_dl_dst:mac</td>
<td>设置数据包的目的MAC地址</td>
</tr>
<tr>
<td>mod_nw_src:ip</td>
<td>设置数据包的源IP地址</td>
</tr>
<tr>
<td>mod_nw_dst:ip</td>
<td>设置数据包的目的IP地址</td>
</tr>
<tr>
<td>mod_tp_src:port</td>
<td>设置TCP或者UDP的源端口</td>
</tr>
<tr>
<td>mod_tp_dst:port</td>
<td>设置TCP或UDP的目的端口</td>
</tr>
<tr>
<td>mod_nw_tos:tos</td>
<td>将IPv4 ToS/DSCP字段设置为ToS，该字段必须是0到255之间的4的倍数。</td>
</tr>
<tr>
<td>resubmit([port],[table])</td>
<td>第一个参数：使用端口替换in_port字段(如果指定了端口)，重第二个参数：重新指定流表，搜索这个OpenFlow流表(或表指定其编号的表)</td>
</tr>
<tr>
<td>set_tunnel:id<br/>set_tunnel64:id</td>
<td>如果输出到将包封装在隧道中并支持标识符(如GRE)的端口，则将标识符设置为id。</td>
</tr>
<tr>
<td>set_queue:queue</td>
<td>设置输出包时应用于排队的队列。</td>
</tr>
<tr>
<td>pop_queue</td>
<td>将队列恢复到应用任何set_queue操作之前的值。</td>
</tr>
<tr>
<td>dec_ttl<br/>dec_ttl[(id1,id2)]</td>
<td>减少IPv4包或跳限制的IPv6包的TTL。</td>
</tr>
<tr>
<td>set_mpls_ttl:ttl</td>
<td>设置包的外部MPLS标签堆栈条目的TTL。ttl应该在0到255之间(包括255)。</td>
</tr>
<tr>
<td>dec_mpls_ttl</td>
<td>外部MPLS标签栈的TTL递减</td>
</tr>
<tr>
<td>move:src[start..end]−&gt;dst[start..end]</td>
<td>将指定的位从字段src复制到字段dst。src和dst必须是nicira−ext.h中定义的NXM字段名,例如NXM_OF_UDP_SRC 或者 NXM_NX_REG0.<br/>例如：<br/>move:NXM_NX_REG0 [0 . . 5]−&gt; NXM_NX_REG1 [26 . .31]将寄存器0中编号为0到5(含5)的6位拷贝到寄存器26到31(含31)中;<br/>move:NXM_NX_REG0 [0 . .15]−&gt;NXM_OF_VLAN_TCI[]将寄存器0中最不重要的16位复制到VLAN TCI字段中。</td>
</tr>
<tr>
<td>load:value−&gt;dst[start..end]</td>
<td>写值value到dst指定位置（从start位到end位），例如：load:55−&gt;NXM_NX_REG2[0..5] 就是将55写入NAX_NX_REG2[0..5],数据存放位数为6位，110111</td>
</tr>
<tr>
<td>push:src[start..end]</td>
<td>从开始到结束的比特包括在内，均存放在栈顶的字段中。<br/>例如:push:NXM_NX_REG2 [0 . .5]将存储在寄存器2中从0到5(含5位)中的值推送到内部堆栈。</td>
</tr>
<tr>
<td>pop:dst[start..end]</td>
<td>从堆栈顶部弹出，从弹出的值中检索包含开始到结束的位，并将它们存储到dst中相应的位。<br/>例如:pop:NXM_NX_REG2 [0 . .5]从堆栈顶部弹出值。设置寄存器2从0到5，将栈顶数据存放到该寄存器0-5。</td>
</tr>
<tr>
<td>set_field:value−&gt;dst</td>
<td>将文字值写入dst字段，该字段应指定为用于匹配的名称。<br/>例如: set_field:fe80:0123:4567:890a:a6ba:dbff:fefe:59fa−&gt;ipv6_src</td>
</tr>
<tr>
<td>learn(argument[,argument]…)</td>
<td>此操作在OpenFlow表中添加或修改一个流，类似于ovs−ofctl−strict mod−flow。参数指定流的匹配字段、操作和其他属性，如下所示：<br/>idle_timeout=seconds<br/>hard_timeout=seconds<br/>priority=value<br/>这些键值对的含义与通常的ovs - ofctl流语法中的含义相同<br/>fin_idle_timeout=seconds<br/>fin_hard_timeout=seconds<br/>将带有指定参数的fin_timeout操作添加到新流。<br/>table=number<br/>应该插入新流的表。指定一个0到254之间的小数。如果表未指定，则默认为表1<br/>field=value<br/>field[start..end]=src[start..end]<br/>field[start..end]<br/>向新流添加匹配条件<br/>load:value−&gt;dst[start..end]<br/>load:src[start..end]−&gt;dst[start..end]<br/>向新流添加加载操作。<br/>output:field[start..end]<br/>将输出操作添加到新流的操作中，该操作将输出到从字段[start..]获取的OpenFlow端口。end]，它必须是上面描述的NXM字段</td>
</tr>
<tr>
<td>local</td>
<td>一般是转发给本地网桥，ovs-ofctl add-flow br0 in_port=1,actions=local</td>
</tr>
</tbody></table>
<h2 id="流表分析"><a href="#流表分析" class="headerlink" title="流表分析"></a>流表分析</h2><p><strong>table0</strong> </p>
<p>完成物理到逻辑的翻译，将逻辑信息，比如上面提到的信息记录到寄存器中。</p>
<p>VM中的容器的报文用VLAN进行区分</p>
<p>别的chassis过来的报文，根据入端口和tunnel_id进行区分，然后获取出端口，这个在封装的时候已经有了</p>
<p><strong>table16-31</strong> </p>
<p>主要是将逻辑流表ingress pipeline 0-15 的操作部分转换为openflow流表，主要工作如下</p>
<p>每个逻辑流表会映射一个或者多个openflow流表，通常报文只是匹配其中一条流表。</p>
<p>ovn-controller使用逻辑流表的UUID的前32位作为openflow流表的cookie值。查看逻辑流表的UUID使用ovn-sbctl list Logical_Flow，对应上面cookie的逻辑流表的UUID的信息在这里。</p>
<p>一些逻辑流表可以映射到ovs的”conjunctive match”扩展名(参见这里)，这时候因为一条openflow流表对应了多条逻辑流表，所以cookie为0。这里的”conjunctive match”表示一个集合的匹配，比如tcp_src ∈ {80, 443, 8080} and tcp_dst ∈ {80, 443, 8080}。</p>
<p>一些逻辑流表可能不会转换成openflow流表，如果交换机上虚拟接口没有添加到ovs中，添加命令ovs-vsctl set Interface veth2_b external_ids:iface-id=ls2-vm4，那么相应的openflow流表将不会生成。</p>
<p>最后就是有一些逻辑流表和openflow流表很明显的对应操作关系，我们列一下</p>
<p>next对应resubmit</p>
<p>field = constant对应set_field</p>
<p>output，将报文resubmit到表32，如果逻辑流表有多个output操作，那么每个都要resubmit到表32。</p>
<p>get_arp(P, A)和get_nd(P, A)，通过讲参数存储在openflow字段中(上面例子中存储在NXM_NX_REG0，流表cookie=0x5dbc664)，然后resubmit到表66，然后ovn-controller从MAC_Binding表生成流填充，如果表66中有匹配项，其action将绑定的MAC存储在目的MAC地址字段中</p>
<p>put_arp(P, A, E)和put_nd(P, A, E)讲参数存储到openflow的字段中(字段太多，查看上面流表cookie=0x92af5d1c)，然后更新MAC_Binding表中。</p>
<p><strong>table32-47</strong></p>
<p>主要是将逻辑流表ingress pipeline的output action转换为openflow流表。以下详细介绍下：</p>
<p><strong>table32</strong></p>
<p>主要是处理到其他宿主机中虚拟机的报文，讲VNI设置到metadata，然后resubmit到表33</p>
<p><strong>table33</strong></p>
<p>主要是将报文resubmit到table34，对于多个逻辑output端口的时候，需要改为每个逻辑端口P，然后resubmit到表34</p>
<p><strong>table34</strong></p>
<p>检查报文的逻辑ingress和egress的端口是否一致，一致则丢弃。剩下的resubmit到表48</p>
<p><strong>table48-63</strong></p>
<p>主要是讲逻辑流表的egress pipeline部分转换成openflow流表，这块属于报文发送之前的最后验证，最终resubmit到表64，最终没有执行output的报文将被丢弃。</p>
<p><strong>table64</strong></p>
<p>貌似和loopback有关，修改逻辑入端口。</p>
<p><strong>table65</strong></p>
<p> 逻辑到物理的转换，和表0相反，主要是将找到逻辑端口对应的物理端口，然后发送，如果虚拟机中还有容器的话，需要添加vlan头。</p>
<p><strong>table66</strong></p>
<p>主要是对应MAC_Binding中的数据，来修改目的IP对应的目的MAC，功能类似arp。</p>
<h2 id="流表寄存器"><a href="#流表寄存器" class="headerlink" title="流表寄存器"></a>流表寄存器</h2><h3 id="常用寄存器"><a href="#常用寄存器" class="headerlink" title="常用寄存器"></a>常用寄存器</h3><table>
<thead>
<tr>
<th>寄存器</th>
<th>功能</th>
<th>详解</th>
</tr>
</thead>
<tbody><tr>
<td>metadata</td>
<td>作为vni使用</td>
<td>是ovn的Logical Datapath Field，命令ovn-sbctl list Datapath_Binding查看tunnel_key，封装到geneve或者stt中</td>
</tr>
<tr>
<td>reg14</td>
<td>记录逻辑入端口</td>
<td>是ovn的Logical InputPort Field，命令ovn-sbctl list Port_Binding查看tunnel_key，封装到geneve或者stt中</td>
</tr>
<tr>
<td>reg15</td>
<td>记录逻辑出端口</td>
<td>是ovn的Logical OutputPort Field，命令ovn-sbctl list Port_Binding查看tunnel_key，封装到geneve或者stt中</td>
</tr>
<tr>
<td>reg13</td>
<td>逻辑端口的conntrack zone</td>
<td>chassis内部有用，出了chassis无用，conntrack连接追踪</td>
</tr>
<tr>
<td>reg12</td>
<td>SNAT的conntrack zone</td>
<td>同上</td>
</tr>
<tr>
<td>reg11</td>
<td>DNAT的conntrack zone</td>
<td>同上</td>
</tr>
<tr>
<td>reg10</td>
<td>逻辑流表标志</td>
<td>可能是逻辑流表中的flags.loopback之类的标志</td>
</tr>
</tbody></table>
<h3 id="NXM字段"><a href="#NXM字段" class="headerlink" title="NXM字段"></a>NXM字段</h3><p>什么是NXM字段，也叫做扩展字段</p>
<table>
<thead>
<tr>
<th>NXM字段</th>
<th align="left">报文字段</th>
</tr>
</thead>
<tbody><tr>
<td>NXM_OF_ETH_SRC</td>
<td align="left">源MAC</td>
</tr>
<tr>
<td>NXM_OF_ETH_DST</td>
<td align="left">目的MAC</td>
</tr>
<tr>
<td>NXM_OF_ETH_TYPE</td>
<td align="left">以太网类型</td>
</tr>
<tr>
<td>NXM_OF_SCTP_DST</td>
<td align="left">SCTP目的端口</td>
</tr>
<tr>
<td>NXM_OF_SCTP_SRC</td>
<td align="left">SCTP源端口</td>
</tr>
<tr>
<td>NXM_OF_UDP_DST</td>
<td align="left">UDP目的端口</td>
</tr>
<tr>
<td>NXM_OF_UDP_SRC</td>
<td align="left">UDP源端口</td>
</tr>
<tr>
<td>NXM_OF_TCP_DST</td>
<td align="left">TCP目的端口</td>
</tr>
<tr>
<td>NXM_OF_TCP_SRC</td>
<td align="left">TCP源端口</td>
</tr>
<tr>
<td>NXM_OF_IP_DST</td>
<td align="left">目的IP</td>
</tr>
<tr>
<td>NXM_OF_IP_SRC</td>
<td align="left">源IP</td>
</tr>
<tr>
<td>NXM_NX_IP_ECN</td>
<td align="left">IP ToS ECN</td>
</tr>
<tr>
<td>NXM_OF_IP_TOS</td>
<td align="left">IP ToS值</td>
</tr>
<tr>
<td>NXM_OF_IP_PROTO</td>
<td align="left">IP协议号</td>
</tr>
<tr>
<td>NXM_OF_VLAN_TCI</td>
<td align="left">vid</td>
</tr>
</tbody></table>
<h1 id="流表实践"><a href="#流表实践" class="headerlink" title="流表实践"></a>流表实践</h1><h2 id="虚拟化平台部署"><a href="#虚拟化平台部署" class="headerlink" title="虚拟化平台部署"></a>虚拟化平台部署</h2><p>当前，采用ovirt4.3虚拟化平台，节点部署情况如下表:</p>
<table>
<thead>
<tr>
<th>节点域名</th>
<th>IP地址</th>
<th>节点类型</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>engine220.cetc30.com</td>
<td>172.16.126.220</td>
<td>管理引擎</td>
<td>管理引擎以自承载的方式部署在node221.cetc30.com上，也作为ovn中心节点</td>
</tr>
<tr>
<td>node221.cetc30.com</td>
<td>172.16.126.221</td>
<td>计算节点</td>
<td>计算节点安装基于redhat7.8的hypervisor，管理引擎网络以网桥的方式管理</td>
</tr>
<tr>
<td>node222.cetc30.com</td>
<td>172.16.126.222</td>
<td>计算节点</td>
<td>计算节点安装基于redhat7.8的hypervisor，管理引擎网络以网桥的方式管理</td>
</tr>
</tbody></table>
<h2 id="管理引擎部署情况"><a href="#管理引擎部署情况" class="headerlink" title="管理引擎部署情况"></a>管理引擎部署情况</h2><p>查询engine220.cetc30.com上的IP地址，从下方可以看出，管理引擎虚拟机仅有一个eth0的网卡，IP地址为172.16.126.220、24，网关地址为172.16.126.1</p>
<figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@engine220 ~]<span class="comment"># ip a</span></span><br><span class="line"><span class="number">1</span>: lo: <span class="variable">&lt;LOOPBACK,UP,LOWER_UP&gt;</span> mtu <span class="number">65536</span> qdisc noqueue <span class="keyword">state</span> UNKNOWN <span class="keyword">group</span> <span class="keyword">default</span> qlen <span class="number">1000</span></span><br><span class="line">    link/loopback <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> brd <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span></span><br><span class="line">    <span class="keyword">inet</span> <span class="number">127.0</span>.<span class="number">0.1</span>/<span class="number">8</span> scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    <span class="keyword">inet6</span> ::<span class="number">1</span>/<span class="number">128</span> scope host </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line"><span class="number">2</span>: eth0: <span class="variable">&lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt;</span> mtu <span class="number">1500</span> qdisc mq <span class="keyword">state</span> UP <span class="keyword">group</span> <span class="keyword">default</span> qlen <span class="number">1000</span></span><br><span class="line">    link/ether <span class="number">00</span>:<span class="number">16</span>:<span class="number">3</span>e:<span class="number">76</span>:<span class="number">22</span>:f7 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    <span class="keyword">inet</span> <span class="number">172.16</span>.<span class="number">126.220</span>/<span class="number">24</span> brd <span class="number">172.16</span>.<span class="number">126.255</span> scope <span class="keyword">global</span> eth0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    <span class="keyword">inet6</span> fe80::<span class="number">216</span>:<span class="number">3</span>eff:fe76:<span class="number">22</span>f7/<span class="number">64</span> scope link </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br></pre></td></tr></table></figure>

<p>查看一下网卡eth0的属性，可以看出，这个网卡的driver是virtio_net型的网卡，也就是虚拟网卡</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">root@engine220</span> <span class="string">log</span>]<span class="comment"># ethtool -i eth0</span></span><br><span class="line"><span class="attr">driver:</span> <span class="string">virtio_net</span></span><br><span class="line"><span class="attr">version:</span> <span class="number">1.0</span><span class="number">.0</span></span><br><span class="line"><span class="attr">firmware-version:</span> </span><br><span class="line"><span class="attr">expansion-rom-version:</span> </span><br><span class="line"><span class="attr">bus-info:</span> <span class="number">0000</span><span class="string">:00:03.0</span></span><br><span class="line"><span class="attr">supports-statistics:</span> <span class="literal">no</span></span><br><span class="line"><span class="attr">supports-test:</span> <span class="literal">no</span></span><br><span class="line"><span class="attr">supports-eeprom-access:</span> <span class="literal">no</span></span><br><span class="line"><span class="attr">supports-register-dump:</span> <span class="literal">no</span></span><br><span class="line"><span class="attr">supports-priv-flags:</span> <span class="literal">no</span></span><br></pre></td></tr></table></figure>

<p>查询ovn北向数据库，从下方可以看出，当前ovn北向数据库中无任何项</p>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@engine220</span> ~]<span class="meta"># ovn-nbctl show</span></span><br><span class="line">[root<span class="symbol">@engine220</span> ~]<span class="meta">#</span></span><br></pre></td></tr></table></figure>

<p>查询ovn南向数据库，从下方可以看出，当前南向绑定了两个节点，分别为node221.cetc30.com和node222.cetc30.com，Encap的属性显示为Geneve隧道连接方式，csum属性为true，csum=true的意思是允许chassis可以使用checksum来保护ovn metadata。</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@engine220 ~]<span class="meta"># ovn-sbctl show</span></span><br><span class="line">Chassis <span class="string">&quot;11c1f235-90bb-403b-8388-807392ab66d5&quot;</span></span><br><span class="line"><span class="symbol">    hostname:</span> <span class="string">&quot;node222.cetc30.com&quot;</span></span><br><span class="line">    Encap geneve</span><br><span class="line"><span class="symbol">        ip:</span> <span class="string">&quot;172.16.126.222&quot;</span></span><br><span class="line"><span class="symbol">        options:</span> &#123;csum=<span class="string">&quot;true&quot;</span>&#125;</span><br><span class="line">Chassis <span class="string">&quot;57bbf64d-e5ee-47a3-bea5-6710770d7502&quot;</span></span><br><span class="line"><span class="symbol">    hostname:</span> <span class="string">&quot;node221.cetc30.com&quot;</span></span><br><span class="line">    Encap geneve</span><br><span class="line"><span class="symbol">        ip:</span> <span class="string">&quot;172.16.126.221&quot;</span></span><br><span class="line"><span class="symbol">        options:</span> &#123;csum=<span class="string">&quot;true&quot;</span>&#125;</span><br></pre></td></tr></table></figure>

<p>查询南向数据库中的Encap属性，从下方可以看出，encap属性中包含了uuid和chassis_name和csum属性以及隧道类型</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@engine220 ~]# ovn-sbctl list encap</span><br><span class="line">_uuid               : 89620436-dca0-4af0-afca-509ffbffc3f3</span><br><span class="line">chassis_name        : <span class="string">&quot;11c1f235-90bb-403b-8388-807392ab66d5&quot;</span><span class="built_in"></span></span><br><span class="line"><span class="built_in">ip </span>                 : <span class="string">&quot;172.16.126.222&quot;</span></span><br><span class="line">options             : &#123;<span class="attribute">csum</span>=<span class="string">&quot;true&quot;</span>&#125;<span class="built_in"></span></span><br><span class="line"><span class="built_in">type </span>               : geneve</span><br><span class="line"></span><br><span class="line">_uuid               : 83f002d2-a77d-427f-ac6f-4eae60ac7026</span><br><span class="line">chassis_name        : <span class="string">&quot;57bbf64d-e5ee-47a3-bea5-6710770d7502&quot;</span><span class="built_in"></span></span><br><span class="line"><span class="built_in">ip </span>                 : <span class="string">&quot;172.16.126.221&quot;</span></span><br><span class="line">options             : &#123;<span class="attribute">csum</span>=<span class="string">&quot;true&quot;</span>&#125;<span class="built_in"></span></span><br><span class="line"><span class="built_in">type </span>               : geneve</span><br></pre></td></tr></table></figure>

<p>查询南向数据库中的Chassis属性，从下方可以看出，其中最重要的就是iface-types，表明了当前支持的隧道类型，包含了stt、tap、vxlan、geneve等，还有最重要的一项就是ovn-bridge-mapping属性，这个属性是一个key-value对，可以将一个物理网络映射给一个本地ovs桥以便为ovs网络提供可连接性。</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@engine220 ~]# ovn-sbctl list chassis</span><br><span class="line">_uuid               : 2cc8f8c4-ed0f-4779-8f69-203fc68413df</span><br><span class="line">encaps              : [89620436-dca0-4af0-afca-509ffbffc3f3]</span><br><span class="line">external_ids        : &#123;<span class="attribute">datapath-type</span>=<span class="string">&quot;&quot;</span>, <span class="attribute">iface-types</span>=<span class="string">&quot;erspan,geneve,gre,internal,ip6erspan,ip6gre,lisp,patch,stt,system,tap,vxlan&quot;</span>, <span class="attribute">ovn-bridge-mappings</span>=<span class="string">&quot;sdcvmnet:vdsmbr_ZNwY1Rku&quot;</span>, <span class="attribute">ovn-chassis-mac-mappings</span>=<span class="string">&quot;&quot;</span>, <span class="attribute">ovn-cms-options</span>=<span class="string">&quot;&quot;</span>&#125;</span><br><span class="line">hostname            : <span class="string">&quot;node222.cetc30.com&quot;</span></span><br><span class="line">name                : <span class="string">&quot;11c1f235-90bb-403b-8388-807392ab66d5&quot;</span></span><br><span class="line">nb_cfg              : 0</span><br><span class="line">transport_zones     : []</span><br><span class="line">vtep_logical_switches: []</span><br><span class="line"></span><br><span class="line">_uuid               : 10c9bfcd-786a-49bc-ad6a-7e977a8e04ce</span><br><span class="line">encaps              : [83f002d2-a77d-427f-ac6f-4eae60ac7026]</span><br><span class="line">external_ids        : &#123;<span class="attribute">datapath-type</span>=<span class="string">&quot;&quot;</span>, <span class="attribute">iface-types</span>=<span class="string">&quot;erspan,geneve,gre,internal,ip6erspan,ip6gre,lisp,patch,stt,system,tap,vxlan&quot;</span>, <span class="attribute">ovn-bridge-mappings</span>=<span class="string">&quot;sdcvmnet:vdsmbr_YcInse8a&quot;</span>, <span class="attribute">ovn-chassis-mac-mappings</span>=<span class="string">&quot;&quot;</span>, <span class="attribute">ovn-cms-options</span>=<span class="string">&quot;&quot;</span>&#125;</span><br><span class="line">hostname            : <span class="string">&quot;node221.cetc30.com&quot;</span></span><br><span class="line">name                : <span class="string">&quot;57bbf64d-e5ee-47a3-bea5-6710770d7502&quot;</span></span><br><span class="line">nb_cfg              : 0</span><br><span class="line">transport_zones     : []</span><br><span class="line">vtep_logical_switches: []</span><br></pre></td></tr></table></figure>

<p>查询南向数据的SSL连接状态，从该查询可以看出，当前ovn-central和ovn-node之间的通信是通过SSL进行了传输保护</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">root@engine220</span> <span class="string">~</span>]<span class="comment"># ovn-sbctl list SSL</span></span><br><span class="line"><span class="attr">_uuid               :</span> <span class="string">44e47d7f-8e50-4704-a174-0a170cdb85e0</span></span><br><span class="line"><span class="attr">bootstrap_ca_cert   :</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">ca_cert             :</span> <span class="string">&quot;/etc/pki/ovirt-engine/ca.pem&quot;</span></span><br><span class="line"><span class="attr">certificate         :</span> <span class="string">&quot;/etc/pki/ovirt-engine/certs/ovn-sdb.cer&quot;</span></span><br><span class="line"><span class="attr">external_ids        :</span> &#123;&#125;</span><br><span class="line"><span class="attr">private_key         :</span> <span class="string">&quot;/etc/pki/ovirt-engine/keys/ovn-sdb.key.nopass&quot;</span></span><br><span class="line"><span class="attr">ssl_ciphers         :</span> <span class="string">HIGH</span></span><br><span class="line"><span class="attr">ssl_protocols       :</span> <span class="string">&quot;TLSv1.2&quot;</span></span><br></pre></td></tr></table></figure>

<p>查询南向数据库的连接状态，可以看出当前的连接状态，南向绑定端口为6642，两个连接数</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@engine220 ~]# ovn-sbctl list<span class="built_in"> Connection</span></span><br><span class="line"><span class="built_in"></span>_uuid               : 2fdf8ee4-bc02-4c7f-8d74-ccdb0f7a2817</span><br><span class="line">external_ids        : &#123;&#125;</span><br><span class="line">inactivity_probe    : []</span><br><span class="line">is_connected        : <span class="literal">true</span></span><br><span class="line">max_backoff         : []</span><br><span class="line">other_config        : &#123;&#125;</span><br><span class="line">read_only           : <span class="literal">false</span></span><br><span class="line">role                : <span class="string">&quot;&quot;</span></span><br><span class="line">status              : &#123;<span class="attribute">bound_port</span>=<span class="string">&quot;6642&quot;</span>, <span class="attribute">n_connections</span>=<span class="string">&quot;2&quot;</span>, <span class="attribute">sec_since_connect</span>=<span class="string">&quot;0&quot;</span>, <span class="attribute">sec_since_disconnect</span>=<span class="string">&quot;0&quot;</span>&#125;</span><br><span class="line">target              : <span class="string">&quot;pssl:6642:[::]&quot;</span></span><br></pre></td></tr></table></figure>

<h2 id="节点221部署情况"><a href="#节点221部署情况" class="headerlink" title="节点221部署情况"></a>节点221部署情况</h2><p>查询node221.cetc30.com的IP地址，从下面可以看出，当前node211.cetc30.com上有多张网卡。</p>
<figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">[root@node221 ~]<span class="comment"># ip a</span></span><br><span class="line"><span class="number">1</span>: lo: <span class="variable">&lt;LOOPBACK,UP,LOWER_UP&gt;</span> mtu <span class="number">65536</span> qdisc noqueue <span class="keyword">state</span> UNKNOWN <span class="keyword">group</span> <span class="keyword">default</span> qlen <span class="number">1000</span></span><br><span class="line">    link/loopback <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> brd <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span></span><br><span class="line">    <span class="keyword">inet</span> <span class="number">127.0</span>.<span class="number">0.1</span>/<span class="number">8</span> scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    <span class="keyword">inet6</span> ::<span class="number">1</span>/<span class="number">128</span> scope host </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line"><span class="number">2</span>: eno1: <span class="variable">&lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt;</span> mtu <span class="number">1500</span> qdisc mq master ovs-system <span class="keyword">state</span> UP <span class="keyword">group</span> <span class="keyword">default</span> qlen <span class="number">1000</span></span><br><span class="line">    link/ether <span class="number">2</span>c:<span class="number">44</span>:fd:<span class="number">92</span>:<span class="number">49</span>:a8 brd ff:ff:ff:ff:ff:ff</span><br><span class="line"><span class="number">3</span>: eno2: <span class="variable">&lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt;</span> mtu <span class="number">1500</span> qdisc mq <span class="keyword">state</span> DOWN <span class="keyword">group</span> <span class="keyword">default</span> qlen <span class="number">1000</span></span><br><span class="line">    link/ether <span class="number">2</span>c:<span class="number">44</span>:fd:<span class="number">92</span>:<span class="number">49</span>:a9 brd ff:ff:ff:ff:ff:ff</span><br><span class="line"><span class="number">4</span>: eno3: <span class="variable">&lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt;</span> mtu <span class="number">1500</span> qdisc mq <span class="keyword">state</span> DOWN <span class="keyword">group</span> <span class="keyword">default</span> qlen <span class="number">1000</span></span><br><span class="line">    link/ether <span class="number">2</span>c:<span class="number">44</span>:fd:<span class="number">92</span>:<span class="number">49</span>:aa brd ff:ff:ff:ff:ff:ff</span><br><span class="line"><span class="number">5</span>: eno4: <span class="variable">&lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt;</span> mtu <span class="number">1500</span> qdisc mq <span class="keyword">state</span> DOWN <span class="keyword">group</span> <span class="keyword">default</span> qlen <span class="number">1000</span></span><br><span class="line">    link/ether <span class="number">2</span>c:<span class="number">44</span>:fd:<span class="number">92</span>:<span class="number">49</span>:ab brd ff:ff:ff:ff:ff:ff</span><br><span class="line"><span class="number">6</span>: ovs-system: <span class="variable">&lt;BROADCAST,MULTICAST&gt;</span> mtu <span class="number">1500</span> qdisc noop <span class="keyword">state</span> DOWN <span class="keyword">group</span> <span class="keyword">default</span> qlen <span class="number">1000</span></span><br><span class="line">    link/ether <span class="number">96</span>:<span class="number">0</span>f:aa:fc:eb:<span class="number">0</span>a brd ff:ff:ff:ff:ff:ff</span><br><span class="line"><span class="number">7</span>: vdsmbr_YcInse8a: <span class="variable">&lt;BROADCAST,MULTICAST&gt;</span> mtu <span class="number">1500</span> qdisc noop <span class="keyword">state</span> DOWN <span class="keyword">group</span> <span class="keyword">default</span> qlen <span class="number">1000</span></span><br><span class="line">    link/ether ae:f7:f8:<span class="number">73</span>:<span class="number">3</span>a:<span class="number">73</span> brd ff:ff:ff:ff:ff:ff</span><br><span class="line"><span class="number">8</span>: sdcvmnet: <span class="variable">&lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt;</span> mtu <span class="number">1500</span> qdisc noqueue <span class="keyword">state</span> UNKNOWN <span class="keyword">group</span> <span class="keyword">default</span> qlen <span class="number">1000</span></span><br><span class="line">    link/ether <span class="number">2</span>c:<span class="number">44</span>:fd:<span class="number">92</span>:<span class="number">49</span>:a8 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    <span class="keyword">inet</span> <span class="number">172.16</span>.<span class="number">126.221</span>/<span class="number">24</span> scope <span class="keyword">global</span> sdcvmnet</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    <span class="keyword">inet6</span> fe80::<span class="number">2</span>e44:fdff:fe92:<span class="number">49</span>a8/<span class="number">64</span> scope link </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line"><span class="number">9</span>: br-int: <span class="variable">&lt;BROADCAST,MULTICAST&gt;</span> mtu <span class="number">1500</span> qdisc noop <span class="keyword">state</span> DOWN <span class="keyword">group</span> <span class="keyword">default</span> qlen <span class="number">1000</span></span><br><span class="line">    link/ether <span class="number">76</span>:e4:fd:<span class="number">15</span>:d6:<span class="number">4</span>f brd ff:ff:ff:ff:ff:ff</span><br><span class="line"><span class="number">10</span>: genev_sys_6081: <span class="variable">&lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt;</span> mtu <span class="number">65000</span> qdisc noqueue master ovs-system <span class="keyword">state</span> UNKNOWN <span class="keyword">group</span> <span class="keyword">default</span> qlen <span class="number">1000</span></span><br><span class="line">    link/ether <span class="number">8</span>e:ca:ab:<span class="number">8</span>b:<span class="number">5</span>e:<span class="number">9</span>e brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    <span class="keyword">inet6</span> fe80::<span class="number">8</span>cca:abff:fe8b:<span class="number">5</span>e9e/<span class="number">64</span> scope link </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line"><span class="number">26</span>: ;vdsmdummy;: <span class="variable">&lt;BROADCAST,MULTICAST&gt;</span> mtu <span class="number">1500</span> qdisc noop <span class="keyword">state</span> DOWN <span class="keyword">group</span> <span class="keyword">default</span> qlen <span class="number">1000</span></span><br><span class="line">    link/ether <span class="number">0</span>e:c9:<span class="number">81</span>:<span class="number">3</span>d:bf:<span class="number">0</span>c brd ff:ff:ff:ff:ff:ff</span><br><span class="line"><span class="number">27</span>: vnet0: <span class="variable">&lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt;</span> mtu <span class="number">1500</span> qdisc mq master ovs-system <span class="keyword">state</span> UNKNOWN <span class="keyword">group</span> <span class="keyword">default</span> qlen <span class="number">1000</span></span><br><span class="line">    link/ether fe:<span class="number">16</span>:<span class="number">3</span>e:<span class="number">76</span>:<span class="number">22</span>:f7 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    <span class="keyword">inet6</span> fe80::fc16:<span class="number">3</span>eff:fe76:<span class="number">22</span>f7/<span class="number">64</span> scope link </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br></pre></td></tr></table></figure>

<p>查看网卡的属性</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#可以看出genev_sys_6081是geneve隧道所创建的网卡</span></span><br><span class="line">[<span class="string">root@node221</span> <span class="string">~</span>]<span class="comment"># ethtool -i genev_sys_6081</span></span><br><span class="line"><span class="attr">driver:</span> <span class="string">geneve</span></span><br><span class="line"><span class="attr">version:</span> <span class="number">0.6</span></span><br><span class="line"><span class="attr">firmware-version:</span> </span><br><span class="line"><span class="attr">expansion-rom-version:</span> </span><br><span class="line"><span class="attr">bus-info:</span> </span><br><span class="line"><span class="attr">supports-statistics:</span> <span class="literal">no</span></span><br><span class="line"><span class="attr">supports-test:</span> <span class="literal">no</span></span><br><span class="line"><span class="attr">supports-eeprom-access:</span> <span class="literal">no</span></span><br><span class="line"><span class="attr">supports-register-dump:</span> <span class="literal">no</span></span><br><span class="line"><span class="attr">supports-priv-flags:</span> <span class="literal">no</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#可以看出，sdcvmnet,ovs-system,br-int,vdsmbr_YcInse8a均是由openvswitch所创建的网卡</span></span><br><span class="line"><span class="comment">#其中，ovs-system比较特殊，他是早期的ovs初始化时所创建的网卡，但是后期没用并一直遗留了下来。</span></span><br><span class="line">[<span class="string">root@node221</span> <span class="string">~</span>]<span class="comment"># ethtool -i sdcvmnet</span></span><br><span class="line"><span class="attr">driver:</span> <span class="string">openvswitch</span></span><br><span class="line"><span class="attr">version:</span> </span><br><span class="line"><span class="attr">firmware-version:</span> </span><br><span class="line"><span class="attr">expansion-rom-version:</span> </span><br><span class="line"><span class="attr">bus-info:</span> </span><br><span class="line"><span class="attr">supports-statistics:</span> <span class="literal">no</span></span><br><span class="line"><span class="attr">supports-test:</span> <span class="literal">no</span></span><br><span class="line"><span class="attr">supports-eeprom-access:</span> <span class="literal">no</span></span><br><span class="line"><span class="attr">supports-register-dump:</span> <span class="literal">no</span></span><br><span class="line"><span class="attr">supports-priv-flags:</span> <span class="literal">no</span></span><br></pre></td></tr></table></figure>

<p>查看ovs网桥状态</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[root@node221 ~]# ovs-vsctl show</span><br><span class="line">98e7caa1-8efa-450d-ad6e-338cb5dc4d48</span><br><span class="line">   <span class="built_in"> Bridge </span><span class="string">&quot;vdsmbr_YcInse8a&quot;</span></span><br><span class="line">       <span class="built_in"> Port </span><span class="string">&quot;vnet0&quot;</span></span><br><span class="line">           <span class="built_in"> Interface </span><span class="string">&quot;vnet0&quot;</span></span><br><span class="line">       <span class="built_in"> Port </span>sdcvmnet</span><br><span class="line">           <span class="built_in"> Interface </span>sdcvmnet</span><br><span class="line">                type: internal</span><br><span class="line">       <span class="built_in"> Port </span><span class="string">&quot;vdsmbr_YcInse8a&quot;</span></span><br><span class="line">           <span class="built_in"> Interface </span><span class="string">&quot;vdsmbr_YcInse8a&quot;</span></span><br><span class="line">                type: internal</span><br><span class="line">       <span class="built_in"> Port </span><span class="string">&quot;eno1&quot;</span></span><br><span class="line">           <span class="built_in"> Interface </span><span class="string">&quot;eno1&quot;</span></span><br><span class="line">   <span class="built_in"> Bridge </span>br-int</span><br><span class="line">        fail_mode: secure</span><br><span class="line">       <span class="built_in"> Port </span><span class="string">&quot;ovn-11c1f2-0&quot;</span></span><br><span class="line">           <span class="built_in"> Interface </span><span class="string">&quot;ovn-11c1f2-0&quot;</span></span><br><span class="line">                type: geneve</span><br><span class="line">                options: &#123;<span class="attribute">csum</span>=<span class="string">&quot;true&quot;</span>, <span class="attribute">key</span>=flow, <span class="attribute">remote_ip</span>=<span class="string">&quot;172.16.126.222&quot;</span>&#125;</span><br><span class="line">       <span class="built_in"> Port </span>br-int</span><br><span class="line">           <span class="built_in"> Interface </span>br-int</span><br><span class="line">                type: internal</span><br><span class="line">    ovs_version: <span class="string">&quot;2.11.0&quot;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>Bridge: Bridge 代表一个以太网交换机（Switch），一个主机中可以创建一个或者多个 Bridge 设备。</li>
<li>Port: 端口与物理交换机的端口概念类似，每个 Port 都隶属于一个 Bridge。</li>
<li>Interface: 连接到 Port 的网络接口设备。在通常情况下，Port 和 Interface 是一对一的关系, 只有在配置 Port 为 bond 模式后，Port 和 Interface 是一对多的关系。</li>
</ul>
<p>从上面的ovs网桥状态可以看出，当前ovs上有两个桥：vdsmbr_YcInse8a和br-int。</p>
<p>其中，物理网卡eno1被绑定到了vdsmbr_YcInse8a桥上，engine220.cetc30.com的虚拟网卡也被绑定到了vdsmbr_YcInse8a桥上的vnet0口，vdsmbr_YcInse8a桥上也新建了sdcvmnet端口，充当管理口。网桥vdsmbr_YcInse8a的fail_mode为standalone（默认为此项），表示如果三次联系不到控制器， 网桥将当做一个普通的mac学习交换机。</p>
<p>在br-int桥上，新建了ovn-11c1f2-0端口充当geneve隧道的vtep，br-int端口做桥的管理口。从上可以看出，ovn-11c1f2-0端口的类型是geneve，csum=true允许使用ckecksum保护ovn metadata数据，key=flow允许不同vni的隧道流量通过，隧道对端为172.16.126.222。网桥br-int的fail_mode为secure，表示将持续接收控制器下发的流表。</p>
<p>ovs中的Interface有如下类型，具体请查看ovsdb帮助文档。</p>
<table>
<thead>
<tr>
<th>接口类型</th>
<th>接口作用</th>
</tr>
</thead>
<tbody><tr>
<td>Normal</td>
<td>用户可以把操作系统中的网卡绑定到ovs上，ovs会生成一个普通端口处理这块网卡进出的数据包。</td>
</tr>
<tr>
<td>Internal</td>
<td>端口类型为internal时，ovs会创建一块虚拟网卡，虚拟网卡会与端口自动绑定。当ovs创建一个新网桥时，默认会创建一个与网桥同名的Internal Port</td>
</tr>
<tr>
<td>Patch</td>
<td>当机器中有多个ovs网桥时，可以使用Patch Port把两个网桥连起来。Patch Port总是成对出现，分别连接在两个网桥上，在两个网桥之间交换数据</td>
</tr>
<tr>
<td>Tunne</td>
<td>隧道端口是一种虚拟端口，支持使用gre或vxlan等隧道技术与位于网络上其他位置的远程端口通讯</td>
</tr>
<tr>
<td>TAP</td>
<td>Linux的tap和tun设备网络</td>
</tr>
</tbody></table>
<p>下面解释一下geneve隧道的属性中的options字段</p>
<table>
<thead>
<tr>
<th>字段</th>
<th>解析</th>
</tr>
</thead>
<tbody><tr>
<td>options: remote_ip</td>
<td>String类型，远程隧道端口。必须是个单播地址ipv4或者ipv6，或者是一个关键词flow。如果设置成flow，即remote_ip=flow则flow这个动作(set_field)必须指定tun_dst或tun_ipv6_dst为远程隧道端口的IP。</td>
</tr>
<tr>
<td>options: local_ip</td>
<td>String类型，本地隧道端口。必须是个单播地址ipv4或者ipv6，或者是一个关键词flow。如果设置成flow，即local_ip=flow则flow这个动作(set_field)必须指定tun_src或者tun_ipv6_src为本地隧道端口的IP。</td>
</tr>
<tr>
<td>options: in_key</td>
<td>String类型，隧道接收的包，包的key值含以下三者之一：0，包中如果没有key或者这个key是0，则表示没有这个属性；一个确定的24bit(Geneve，VXLAN，LISP)，32bit（GRE），64bit（STT）数字，隧道会接收以上指定key的包；关键字flow，隧道会接收任意key的包，key会被替换成tun_id，并使用tun_id去匹配流表。</td>
</tr>
<tr>
<td>options: out_key</td>
<td>String类型，隧道发送的包，包的key值被设置为：0，包如果被设置为0，则发送的包不会带有该属性，等同于不设置改属性；一个确定的24bit(Geneve，VXLAN，LISP)，32bit（GRE），64bit（STT）数字，隧道发送的包会带上该key；关键字flow，隧道会设置key值。</td>
</tr>
<tr>
<td>options: key</td>
<td>String类型，如果in_key和out_key是同一数值，则可以合并为该属性。</td>
</tr>
<tr>
<td>options: tos</td>
<td>String类型，在封包的时候添加进ToS字段。</td>
</tr>
<tr>
<td>options: ttl</td>
<td>tring类型，可以设置为inherit、数字、不设置，TTL字段会被设置在封装包中，该属性表示该包在路由前最大经过的网段数量。inherit表示从inner packet(必须要是ipv4或ipv6)中拷贝TTL字段，不设置则默认为64。</td>
</tr>
<tr>
<td>options: df_default</td>
<td>布尔类型，如果为true表示不分包bit会被设置在封装包头中，去让MTU发现。</td>
</tr>
<tr>
<td>options: csum</td>
<td>String类型，只可能是True、False。在发包中计算封包头的校验，GRE默认支持，vxlan和geneve则需要kernel &gt; 4.0</td>
</tr>
</tbody></table>
<p>查看vdsmbr_YcInse8a桥上的流表</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#从上面可以看出，vdsmbr_YcInse8a就是一个普通的mac学习网桥，不是流表网桥，所以网桥上的actions的处理方式是按照普通L2/L3方式进行处理</span></span><br><span class="line">[root@node221 ~]# ovs-ofctl dump-flows vdsmbr_YcInse8a</span><br><span class="line"> <span class="attribute">cookie</span>=0x0, <span class="attribute">duration</span>=713736.690s, <span class="attribute">table</span>=0, <span class="attribute">n_packets</span>=30799694, <span class="attribute">n_bytes</span>=125325335150, <span class="attribute">priority</span>=0 <span class="attribute">actions</span>=NORMAL</span><br><span class="line"><span class="comment">#cookie=0x0，表示这条流表不是从逻辑流表转换过来的</span></span><br><span class="line"><span class="comment">#duration=713736.690s，这条流表创建出来已经持续713736.690秒了</span></span><br><span class="line"><span class="comment">#table=0,流表匹配table0</span></span><br><span class="line"><span class="comment">#n_packets=30799694，命中包30799694个</span></span><br><span class="line"><span class="comment">#n_bytes=125325335150，命中字节数为125325335150,这样算下来，125325335150/30799694=4069,每个包的大小为4069字节。（为什么是4069字节）</span></span><br><span class="line"><span class="comment">#priority=0 优先级为0，最低优先级</span></span><br><span class="line"><span class="comment">#actions=NORMAL,按照普通交换机进行L2/L3处理</span></span><br></pre></td></tr></table></figure>

<p>查看br-int桥上的流表</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">cookie</span>=0x0, <span class="attribute">duration</span>=714947.969s, <span class="attribute">table</span>=0, <span class="attribute">n_packets</span>=14155, <span class="attribute">n_bytes</span>=1386162, <span class="attribute">priority</span>=100,in_port=&quot;ovn-11c1f2-0&quot; <span class="attribute">actions</span>=move:NXM_NX_TUN_ID[0<span class="built_in">..</span>23]-&gt;OXM_OF_METADATA[0<span class="built_in">..</span>23],move:NXM_NX_TUN_METADATA0[16<span class="built_in">..</span>30]-&gt;NXM_NX_REG14[0<span class="built_in">..</span>14],move:NXM_NX_TUN_METADATA0[0<span class="built_in">..</span>15]-&gt;NXM_NX_REG15[0<span class="built_in">..</span>15],resubmit(,33)</span><br><span class="line"><span class="comment">#基本字段:不是逻辑流表生成的流表，是一个table0里面的流表，优先级为100</span></span><br><span class="line"><span class="comment">#条件字段：in_port=&quot;ovn-11c1f2-0&quot;,从ovn-11c1f2-0入端进来的流量（其实就是从隧道中过来的流量）</span></span><br><span class="line"><span class="comment">#匹配字段：move:将指定的位从src拷贝到dst，这个匹配字段的意思是：</span></span><br><span class="line">将NXM_NX_TUN_ID寄存器中的0-23共24位拷贝到OXM_OF_METADATA寄存器的0-23位中：NXM_NX_TUN_ID，名称为TUN_ID，64位宽度，存放着隧道的key（geneve有24位的vni，STT有64位）；OXM_OF_METADATA名称为metadata,64位宽度，最老的寄存器，用来存放一些用户定义的元数据。</span><br><span class="line">将NXM_NX_TUN_METADATA0寄存器中的16-30共15位拷贝到NXM_NX_REG14寄存器的0-14位中：NXM_NX_TUN_METADATA0名称为tun_metadata0,992位宽度，封装有隧道的TLV数据；NXM_NX_REG14，其实就是reg14,存放逻辑入端口数据</span><br><span class="line">将NXM_NX_TUN_METADATA0寄存器中的0-15共16位拷贝到NXM_NX_REG15寄存器的0-15位中：NXM_NX_TUN_METADATA0名称为tun_metadata0,992位宽度，封装有隧道的TLV数据；NXM_NX_REG15，其实就是reg15，存放逻辑出端口数据</span><br><span class="line">resubmit(,33)，跳转到table33；第一个参数：使用端口替换in_port字段(如果指定了端口)，第二个参数：重新指定流表，搜索这个OpenFlow流表(或表指定其编号的表)</span><br><span class="line"></span><br><span class="line"><span class="attribute">cookie</span>=0x0, <span class="attribute">duration</span>=714947.969s, <span class="attribute">table</span>=32, <span class="attribute">n_packets</span>=0, <span class="attribute">n_bytes</span>=0, <span class="attribute">priority</span>=150,reg10=0x10/0x10 <span class="attribute">actions</span>=resubmit(,33)</span><br><span class="line"><span class="comment">#基本字段:不解释，table32中的流表</span></span><br><span class="line"><span class="comment">#条件字段:reg10=0x10/0x10，当reg10(逻辑流表标记)为0x10/0x10时</span></span><br><span class="line"><span class="comment">#匹配字段：跳转到表33</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">cookie</span>=0x0, <span class="attribute">duration</span>=714947.969s, <span class="attribute">table</span>=32, <span class="attribute">n_packets</span>=0, <span class="attribute">n_bytes</span>=0, <span class="attribute">priority</span>=150,reg10=0x2/0x2 <span class="attribute">actions</span>=resubmit(,33)</span><br><span class="line"><span class="comment">#基本字段:不解释，table32中的流表</span></span><br><span class="line"><span class="comment">#条件字段:reg10=0x2/0x2，当reg10(逻辑流表标记)为0x2/0x2时</span></span><br><span class="line"><span class="comment">#匹配字段：跳转到表33</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">cookie</span>=0x0, <span class="attribute">duration</span>=714947.969s, <span class="attribute">table</span>=32, <span class="attribute">n_packets</span>=2445948, <span class="attribute">n_bytes</span>=163476027, <span class="attribute">priority</span>=0 <span class="attribute">actions</span>=resubmit(,33)</span><br><span class="line"><span class="comment">#基本字段:不解释，table32中的流表</span></span><br><span class="line"><span class="comment">#条件字段:无</span></span><br><span class="line"><span class="comment">#匹配字段：跳转到表33</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attribute">cookie</span>=0x0, <span class="attribute">duration</span>=714947.969s, <span class="attribute">table</span>=34, <span class="attribute">n_packets</span>=2457197, <span class="attribute">n_bytes</span>=164583424, <span class="attribute">priority</span>=0 <span class="attribute">actions</span>=load:0-&gt;NXM_NX_REG0[],load:0-&gt;NXM_NX_REG1[],load:0-&gt;NXM_NX_REG2[],load:0-&gt;NXM_NX_REG3[],load:0-&gt;NXM_NX_REG4[],load:0-&gt;NXM_NX_REG5[],load:0-&gt;NXM_NX_REG6[],load:0-&gt;NXM_NX_REG7[],load:0-&gt;NXM_NX_REG8[],load:0-&gt;NXM_NX_REG9[],resubmit(,40)</span><br><span class="line"><span class="comment">#基本字段，不解释，table34中的流表</span></span><br><span class="line"><span class="comment">#条件字段，无</span></span><br><span class="line"><span class="comment">#匹配字段：将值0写入NXM_NX_REG0[]至NXM_NX_REG9[]（reg0-reg9的寄存器具体是做什么的）</span></span><br><span class="line">resubmit(,40)，跳转到表40</span><br><span class="line"></span><br><span class="line"><span class="attribute">cookie</span>=0x0, <span class="attribute">duration</span>=714947.969s, <span class="attribute">table</span>=64, <span class="attribute">n_packets</span>=2456599, <span class="attribute">n_bytes</span>=164556628, <span class="attribute">priority</span>=0 <span class="attribute">actions</span>=resubmit(,65)</span><br><span class="line"><span class="comment">#基本字段:不解释，table64中的流表</span></span><br><span class="line"><span class="comment">#条件字段:无</span></span><br><span class="line"><span class="comment">#匹配字段：跳转到表65</span></span><br></pre></td></tr></table></figure>

<p>VXLAN 是数据中心常用的 tunnel 技术，但是 VXLAN header 是固定的，只能传递一个 VNID（VXLAN network identifier），如果想在 tunnel 里面传递更多的信息，VXLAN 实现不了。所以 OVN 选择了 Geneve 和 STT，Geneve 的头部有个 option 字段，支持 TLV 格式，用户可以根据自己的需要进行扩展，而 STT 的头部可以传递 64-bit 的数据，比 VXLAN 的 24-bit 大很多，所以我们从第一条流表中可以看出NXM_NX_TUN_ID的定义为64位，就是为了放STT的头部。</p>
<p>OVN tunnel 封装时使用了三种数据:</p>
<ul>
<li>Logical datapath identifier（逻辑的数据通道标识符）</li>
</ul>
<p><code>datapath</code> 是 OVS 里面的概念，报文需要送到 datapath 进行处理，一个 datapath 对应一个 OVN 里面的逻辑交换机或者逻辑路由器，类似于 <code>tunnel ID</code>。这个标识符有 24-bit，由 ovn-northd 分配的，全局唯一，保存在 <code>Southbound DB</code> 里面的表 <code>Datapath_Binding</code> 的列 <code>tunnel_key</code> 里。</p>
<ul>
<li>Logical input port identifier（逻辑的入端口标识符）</li>
</ul>
<p>进入 <code>logical datapath</code> 的端口标识符，15-bit 长，由 ovn-northd 分配的，在每个 datapath 里面唯一。它可用范围是 1-32767，0 预留给内部使用。保存在 <code>Southbound DB</code> 里面的表 <code>Port_Binding</code> 的列 <code>tunnel_key</code> 里。</p>
<ul>
<li>Logical output port identifier（逻辑的出端口标识符）</li>
</ul>
<p>离开 <code>logical datapath</code> 的端口标识符，16-bit 长，范围 0-32767 和 <code>logical input port identifier</code> 含义一样，范围 32768-65535 给组播组使用。对于每个 <code>logical port</code>，<code>input port identifier</code> 和 <code>output port identifier</code> 相同。</p>
<p>如果 tunnel 类型是 Geneve，<code>Geneve header</code> 里面的 VNI 字段填 <code>logical datapath identifier</code>，Option 字段填 <code>logical input port identifier</code> 和 <code>logical output port identifier</code>，TLV 的 class 为 0xffff，type 为 0，value 为 0 (1-bit) + <code>logical input port identifier (15-bit)</code> + <code>logical output port identifier (16-bit)</code>。</p>
<p>OVS 的 tunnel 封装是由 Openflow 流表来做的，所以 ovn-controller 需要把这三个标识符写到本地 HV 的 Openflow flow table 里面，对于每个进入 br-int 的报文，都会有这三个属性，分别存在NXM_NX_TUN_ID和NXM_NX_TUN_METADATA0，然后我们在上述流表中可以看到，流表动作将其拷贝到了OXM_OF_METADATA和NXM_NX_REG14和NXM_NX_REG15中。</p>
<h2 id="节点222部署情况"><a href="#节点222部署情况" class="headerlink" title="节点222部署情况"></a>节点222部署情况</h2><p>node222上的部署情况和221类似，就不进行分析了，只是列举一下。</p>
<p>查询node222.cetc30.com的IP地址，从下面可以看出，当前node211.cetc30.com上有多张网卡。</p>
<figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">[root@node222 ~]<span class="comment"># ip a</span></span><br><span class="line"><span class="number">1</span>: lo: <span class="variable">&lt;LOOPBACK,UP,LOWER_UP&gt;</span> mtu <span class="number">65536</span> qdisc noqueue <span class="keyword">state</span> UNKNOWN <span class="keyword">group</span> <span class="keyword">default</span> qlen <span class="number">1000</span></span><br><span class="line">    link/loopback <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> brd <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span></span><br><span class="line">    <span class="keyword">inet</span> <span class="number">127.0</span>.<span class="number">0.1</span>/<span class="number">8</span> scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    <span class="keyword">inet6</span> ::<span class="number">1</span>/<span class="number">128</span> scope host </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line"><span class="number">2</span>: ens513f0: <span class="variable">&lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt;</span> mtu <span class="number">1500</span> qdisc mq <span class="keyword">state</span> DOWN <span class="keyword">group</span> <span class="keyword">default</span> qlen <span class="number">1000</span></span><br><span class="line">    link/ether <span class="number">00</span>:<span class="number">1</span>e:<span class="number">67</span>:f1:e8:<span class="number">58</span> brd ff:ff:ff:ff:ff:ff</span><br><span class="line"><span class="number">3</span>: ens513f1: <span class="variable">&lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt;</span> mtu <span class="number">1500</span> qdisc mq <span class="keyword">state</span> DOWN <span class="keyword">group</span> <span class="keyword">default</span> qlen <span class="number">1000</span></span><br><span class="line">    link/ether <span class="number">00</span>:<span class="number">1</span>e:<span class="number">67</span>:f1:e8:<span class="number">59</span> brd ff:ff:ff:ff:ff:ff</span><br><span class="line"><span class="number">4</span>: ens513f2: <span class="variable">&lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt;</span> mtu <span class="number">1500</span> qdisc mq <span class="keyword">state</span> DOWN <span class="keyword">group</span> <span class="keyword">default</span> qlen <span class="number">1000</span></span><br><span class="line">    link/ether <span class="number">00</span>:<span class="number">1</span>e:<span class="number">67</span>:f1:e8:<span class="number">5</span>a brd ff:ff:ff:ff:ff:ff</span><br><span class="line"><span class="number">5</span>: ens513f3: <span class="variable">&lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt;</span> mtu <span class="number">1500</span> qdisc mq <span class="keyword">state</span> DOWN <span class="keyword">group</span> <span class="keyword">default</span> qlen <span class="number">1000</span></span><br><span class="line">    link/ether <span class="number">00</span>:<span class="number">1</span>e:<span class="number">67</span>:f1:e8:<span class="number">5</span>b brd ff:ff:ff:ff:ff:ff</span><br><span class="line"><span class="number">6</span>: enp4s0f0: <span class="variable">&lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt;</span> mtu <span class="number">1500</span> qdisc mq master ovs-system <span class="keyword">state</span> UP <span class="keyword">group</span> <span class="keyword">default</span> qlen <span class="number">1000</span></span><br><span class="line">    link/ether a4:bf:<span class="number">01</span>:<span class="number">01</span>:<span class="number">68</span>:<span class="number">23</span> brd ff:ff:ff:ff:ff:ff</span><br><span class="line"><span class="number">7</span>: enp4s0f3: <span class="variable">&lt;BROADCAST,MULTICAST&gt;</span> mtu <span class="number">1500</span> qdisc noop <span class="keyword">state</span> DOWN <span class="keyword">group</span> <span class="keyword">default</span> qlen <span class="number">1000</span></span><br><span class="line">    link/ether a4:bf:<span class="number">01</span>:<span class="number">01</span>:<span class="number">68</span>:<span class="number">24</span> brd ff:ff:ff:ff:ff:ff</span><br><span class="line"><span class="number">8</span>: ovs-system: <span class="variable">&lt;BROADCAST,MULTICAST&gt;</span> mtu <span class="number">1500</span> qdisc noop <span class="keyword">state</span> DOWN <span class="keyword">group</span> <span class="keyword">default</span> qlen <span class="number">1000</span></span><br><span class="line">    link/ether <span class="number">06</span>:<span class="number">17</span>:<span class="number">65</span>:bc:c2:f8 brd ff:ff:ff:ff:ff:ff</span><br><span class="line"><span class="number">9</span>: vdsmbr_ZNwY1Rku: <span class="variable">&lt;BROADCAST,MULTICAST&gt;</span> mtu <span class="number">1500</span> qdisc noop <span class="keyword">state</span> DOWN <span class="keyword">group</span> <span class="keyword">default</span> qlen <span class="number">1000</span></span><br><span class="line">    link/ether d2:<span class="number">8</span>f:b0:<span class="number">88</span>:b8:<span class="number">17</span> brd ff:ff:ff:ff:ff:ff</span><br><span class="line"><span class="number">10</span>: sdcvmnet: <span class="variable">&lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt;</span> mtu <span class="number">1500</span> qdisc noqueue <span class="keyword">state</span> UNKNOWN <span class="keyword">group</span> <span class="keyword">default</span> qlen <span class="number">1000</span></span><br><span class="line">    link/ether a4:bf:<span class="number">01</span>:<span class="number">01</span>:<span class="number">68</span>:<span class="number">23</span> brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    <span class="keyword">inet</span> <span class="number">172.16</span>.<span class="number">126.222</span>/<span class="number">24</span> scope <span class="keyword">global</span> sdcvmnet</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    <span class="keyword">inet6</span> fe80::a6bf:<span class="number">1</span>ff:fe01:<span class="number">6823</span>/<span class="number">64</span> scope link </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line"><span class="number">11</span>: genev_sys_6081: <span class="variable">&lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt;</span> mtu <span class="number">65000</span> qdisc noqueue master ovs-system <span class="keyword">state</span> UNKNOWN <span class="keyword">group</span> <span class="keyword">default</span> qlen <span class="number">1000</span></span><br><span class="line">    link/ether <span class="number">12</span>:f4:cc:fb:e2:<span class="number">93</span> brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    <span class="keyword">inet6</span> fe80::<span class="number">10</span>f4:ccff:fefb:e293/<span class="number">64</span> scope link </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line"><span class="number">12</span>: br-int: <span class="variable">&lt;BROADCAST,MULTICAST&gt;</span> mtu <span class="number">1500</span> qdisc noop <span class="keyword">state</span> DOWN <span class="keyword">group</span> <span class="keyword">default</span> qlen <span class="number">1000</span></span><br><span class="line">    link/ether <span class="number">32</span>:<span class="number">30</span>:<span class="number">5</span>d:ba:<span class="number">9</span>f:<span class="number">4</span>e brd ff:ff:ff:ff:ff:ff</span><br><span class="line"><span class="number">28</span>: ;vdsmdummy;: <span class="variable">&lt;BROADCAST,MULTICAST&gt;</span> mtu <span class="number">1500</span> qdisc noop <span class="keyword">state</span> DOWN <span class="keyword">group</span> <span class="keyword">default</span> qlen <span class="number">1000</span></span><br><span class="line">    link/ether de:<span class="number">87</span>:<span class="number">45</span>:<span class="number">44</span>:bf:b6 brd ff:ff:ff:ff:ff:ff</span><br></pre></td></tr></table></figure>

<p>查看ovs网桥状态</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@node222 ~]# ovs-vsctl show</span><br><span class="line">5d163e6f-f528-4991-be94-53398a5c2d97</span><br><span class="line">   <span class="built_in"> Bridge </span><span class="string">&quot;vdsmbr_ZNwY1Rku&quot;</span></span><br><span class="line">       <span class="built_in"> Port </span>sdcvmnet</span><br><span class="line">           <span class="built_in"> Interface </span>sdcvmnet</span><br><span class="line">                type: internal</span><br><span class="line">       <span class="built_in"> Port </span><span class="string">&quot;vdsmbr_ZNwY1Rku&quot;</span></span><br><span class="line">           <span class="built_in"> Interface </span><span class="string">&quot;vdsmbr_ZNwY1Rku&quot;</span></span><br><span class="line">                type: internal</span><br><span class="line">       <span class="built_in"> Port </span><span class="string">&quot;enp4s0f0&quot;</span></span><br><span class="line">           <span class="built_in"> Interface </span><span class="string">&quot;enp4s0f0&quot;</span></span><br><span class="line">   <span class="built_in"> Bridge </span>br-int</span><br><span class="line">        fail_mode: secure</span><br><span class="line">       <span class="built_in"> Port </span><span class="string">&quot;ovn-57bbf6-0&quot;</span></span><br><span class="line">           <span class="built_in"> Interface </span><span class="string">&quot;ovn-57bbf6-0&quot;</span></span><br><span class="line">                type: geneve</span><br><span class="line">                options: &#123;<span class="attribute">csum</span>=<span class="string">&quot;true&quot;</span>, <span class="attribute">key</span>=flow, <span class="attribute">remote_ip</span>=<span class="string">&quot;172.16.126.221&quot;</span>&#125;</span><br><span class="line">       <span class="built_in"> Port </span>br-int</span><br><span class="line">           <span class="built_in"> Interface </span>br-int</span><br><span class="line">                type: internal</span><br><span class="line">    ovs_version: <span class="string">&quot;2.11.0&quot;</span></span><br></pre></td></tr></table></figure>

<p>查看网桥上的流表</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@node222 ~]# ovs-ofctl dump-flows vdsmbr_ZNwY1Rku</span><br><span class="line"> <span class="attribute">cookie</span>=0x0, <span class="attribute">duration</span>=622275.150s, <span class="attribute">table</span>=0, <span class="attribute">n_packets</span>=27743756, <span class="attribute">n_bytes</span>=125245817580, <span class="attribute">priority</span>=0 <span class="attribute">actions</span>=NORMAL</span><br><span class="line"></span><br><span class="line">[root@node222 ~]# ovs-ofctl dump-flows br-int</span><br><span class="line"> <span class="attribute">cookie</span>=0x0, <span class="attribute">duration</span>=595479.177s, <span class="attribute">table</span>=0, <span class="attribute">n_packets</span>=64, <span class="attribute">n_bytes</span>=6048, <span class="attribute">priority</span>=100,in_port=&quot;ovn-57bbf6-0&quot; <span class="attribute">actions</span>=move:NXM_NX_TUN_ID[0<span class="built_in">..</span>23]-&gt;OXM_OF_METADATA[0<span class="built_in">..</span>23],move:NXM_NX_TUN_METADATA0[16<span class="built_in">..</span>30]-&gt;NXM_NX_REG14[0<span class="built_in">..</span>14],move:NXM_NX_TUN_METADATA0[0<span class="built_in">..</span>15]-&gt;NXM_NX_REG15[0<span class="built_in">..</span>15],resubmit(,33)</span><br><span class="line"> <span class="attribute">cookie</span>=0x0, <span class="attribute">duration</span>=622272.850s, <span class="attribute">table</span>=32, <span class="attribute">n_packets</span>=0, <span class="attribute">n_bytes</span>=0, <span class="attribute">priority</span>=150,reg10=0x10/0x10 <span class="attribute">actions</span>=resubmit(,33)</span><br><span class="line"> <span class="attribute">cookie</span>=0x0, <span class="attribute">duration</span>=622272.850s, <span class="attribute">table</span>=32, <span class="attribute">n_packets</span>=0, <span class="attribute">n_bytes</span>=0, <span class="attribute">priority</span>=150,reg10=0x2/0x2 <span class="attribute">actions</span>=resubmit(,33)</span><br><span class="line"> <span class="attribute">cookie</span>=0x0, <span class="attribute">duration</span>=622272.850s, <span class="attribute">table</span>=32, <span class="attribute">n_packets</span>=2912887, <span class="attribute">n_bytes</span>=196190610, <span class="attribute">priority</span>=0 <span class="attribute">actions</span>=resubmit(,33)</span><br><span class="line"> <span class="attribute">cookie</span>=0x0, <span class="attribute">duration</span>=622272.850s, <span class="attribute">table</span>=34, <span class="attribute">n_packets</span>=2918499, <span class="attribute">n_bytes</span>=196796696, <span class="attribute">priority</span>=0 <span class="attribute">actions</span>=load:0-&gt;NXM_NX_REG0[],load:0-&gt;NXM_NX_REG1[],load:0-&gt;NXM_NX_REG2[],load:0-&gt;NXM_NX_REG3[],load:0-&gt;NXM_NX_REG4[],load:0-&gt;NXM_NX_REG5[],load:0-&gt;NXM_NX_REG6[],load:0-&gt;NXM_NX_REG7[],load:0-&gt;NXM_NX_REG8[],load:0-&gt;NXM_NX_REG9[],resubmit(,40)</span><br><span class="line"> <span class="attribute">cookie</span>=0x0, <span class="attribute">duration</span>=622272.850s, <span class="attribute">table</span>=64, <span class="attribute">n_packets</span>=2918009, <span class="attribute">n_bytes</span>=196773036, <span class="attribute">priority</span>=0 <span class="attribute">actions</span>=resubmit(,65)</span><br></pre></td></tr></table></figure>


    </div>

    
    
    
        

<div>
<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>Post author:  </strong>dangervon
  </li>
  <li class="post-copyright-link">
    <strong>Post link: </strong>
    <a href="http://dangervon.github.io/2021/11/16/OVN%E6%B5%81%E8%A1%A8%E5%88%86%E6%9E%90/" title="OVN流表分析">http://dangervon.github.io/2021/11/16/OVN流表分析/</a>
  </li>
  <li class="post-copyright-license">
    <strong>Copyright Notice:  </strong>All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> unless stating additionally.
  </li>
</ul>
</div>


      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/openflow/" rel="tag"># openflow</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2021/11/16/Neutron%E4%B8%8B%E7%9A%84ACL%E8%A7%84%E5%88%99%E5%88%97%E8%A1%A8/" rel="prev" title="Neutron下的ACL规则列表">
      <i class="fa fa-chevron-left"></i> Neutron下的ACL规则列表
    </a></div>
      <div class="post-nav-item"></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%B5%81%E8%A1%A8%E6%A6%82%E8%BF%B0"><span class="nav-number">1.</span> <span class="nav-text">流表概述</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B5%81%E8%A1%A8%E8%A7%84%E5%88%99"><span class="nav-number">1.1.</span> <span class="nav-text">流表规则</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9F%BA%E6%9C%AC%E5%AD%97%E6%AE%B5"><span class="nav-number">1.1.1.</span> <span class="nav-text">基本字段</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9D%A1%E4%BB%B6%E5%AD%97%E6%AE%B5"><span class="nav-number">1.1.2.</span> <span class="nav-text">条件字段</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8A%A8%E4%BD%9C%E5%AD%97%E6%AE%B5"><span class="nav-number">1.1.3.</span> <span class="nav-text">动作字段</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B5%81%E8%A1%A8%E5%88%86%E6%9E%90"><span class="nav-number">1.2.</span> <span class="nav-text">流表分析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B5%81%E8%A1%A8%E5%AF%84%E5%AD%98%E5%99%A8"><span class="nav-number">1.3.</span> <span class="nav-text">流表寄存器</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B8%B8%E7%94%A8%E5%AF%84%E5%AD%98%E5%99%A8"><span class="nav-number">1.3.1.</span> <span class="nav-text">常用寄存器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#NXM%E5%AD%97%E6%AE%B5"><span class="nav-number">1.3.2.</span> <span class="nav-text">NXM字段</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%B5%81%E8%A1%A8%E5%AE%9E%E8%B7%B5"><span class="nav-number">2.</span> <span class="nav-text">流表实践</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%99%9A%E6%8B%9F%E5%8C%96%E5%B9%B3%E5%8F%B0%E9%83%A8%E7%BD%B2"><span class="nav-number">2.1.</span> <span class="nav-text">虚拟化平台部署</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AE%A1%E7%90%86%E5%BC%95%E6%93%8E%E9%83%A8%E7%BD%B2%E6%83%85%E5%86%B5"><span class="nav-number">2.2.</span> <span class="nav-text">管理引擎部署情况</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%8A%82%E7%82%B9221%E9%83%A8%E7%BD%B2%E6%83%85%E5%86%B5"><span class="nav-number">2.3.</span> <span class="nav-text">节点221部署情况</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%8A%82%E7%82%B9222%E9%83%A8%E7%BD%B2%E6%83%85%E5%86%B5"><span class="nav-number">2.4.</span> <span class="nav-text">节点222部署情况</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="dangervon"
      src="/images/header.png">
  <p class="site-author-name" itemprop="name">dangervon</p>
  <div class="site-description" itemprop="description">to be a better man</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">2</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">1</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">2</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/dangervon" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;dangervon" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:cemicircle@gmail.com" title="E-Mail → mailto:cemicircle@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>
  <div class="cc-license motion-element" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">dangervon</span>
</div>

        








      </div>
    </footer>
  </div>

  
  <script src="/nextlib/anime.min.js"></script>
  <script src="/nextlib/velocity/velocity.min.js"></script>
  <script src="/nextlib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
